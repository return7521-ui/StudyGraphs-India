<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudyGraphs India | Advanced STEM Workspace</title>
    
    <meta name="description" content="India's Advanced Scientific Computing Environment for ISC/CBSE Students.">
    <meta name="theme-color" content="#0f172a">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // "StudyGraphs India" Brand Palette
                        'sg-bg': '#0f172a',      // Slate 900 (Deep Matte)
                        'sg-surface': '#1e293b', // Slate 800
                        'sg-border': '#334155',  // Slate 700
                        'brand-primary': '#3b82f6', // Royal Blue
                        'brand-accent': '#f43f5e',  // Rose
                        'sci-green': '#10b981',     // Emerald (Physics)
                        'sci-purple': '#8b5cf6',    // Violet (Math)
                        'sci-gold': '#f59e0b',      // Amber (Chemistry)
                    },
                    fontFamily: {
                        'sans': ['"Inter"', 'ui-sans-serif', 'system-ui'],
                        'mono': ['"JetBrains Mono"', 'ui-monospace', 'SFMono-Regular'],
                        'math': ['"Computer Modern"', 'serif'], // For Formulas
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
                    },
                    screens: {
                        'mobile': {'max': '768px'}, // Custom mobile breakpoint
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.4.0/algebrite.min.js"></script>
    
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CORE RESET & SCROLLBARS */
        body { 
            margin: 0; padding: 0; 
            background-color: #0f172a; 
            color: #f8fafc;
            overflow: hidden; /* App-like feel */
            -webkit-tap-highlight-color: transparent;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { position: fixed; width: 100%; height: 100%; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism Classes */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .loading-screen {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Global Error Handler to prevent White Screen of Death
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("System Error:", message, error);
            // In a real app, we would log this to a server
        };

        /* PART 1 COMPLETE: ENGINES LOADED */
        // ==================================================================================
        // 2. KERNEL ARCHITECTURE: GLOBAL STATE MANAGEMENT
        // ==================================================================================

        const OSContext = React.createContext();

        // --- APP REGISTRY (The DNA of StudyGraphs India) ---
        // Only essential STEM apps included. No bloatware.
        const APP_REGISTRY = {
            // MATHEMATICS SUITE
            'graph':    { id: 'graph',    title: 'Graph Plotter Pro', icon: 'fa-chart-area',          color: '#3b82f6', width: 1000, height: 700 },
            'solver':   { id: 'solver',   title: 'Universal Solver',  icon: 'fa-square-root-variable',color: '#8b5cf6', width: 600,  height: 800 },
            'formulas': { id: 'formulas', title: 'Formula Library',   icon: 'fa-book-open',           color: '#f43f5e', width: 900,  height: 600 },
            
            // SCIENCE SUITE
            'periodic': { id: 'periodic', title: 'Periodic Table 3D', icon: 'fa-flask',               color: '#f59e0b', width: 1100, height: 700 },
            'physics':  { id: 'physics',  title: 'Physics Sim Lab',   icon: 'fa-atom',                color: '#10b981', width: 900,  height: 650 },
            
            // UTILITIES
            'converter':{ id: 'converter',title: 'Unit & Currency',   icon: 'fa-arrow-right-arrow-left', color: '#06b6d4', width: 500, height: 600 },
            'code':     { id: 'code',     title: 'CS Code Studio',    icon: 'fa-code',                color: '#6366f1', width: 900,  height: 650 },
            'settings': { id: 'settings', title: 'System Settings',   icon: 'fa-sliders',             color: '#64748b', width: 700,  height: 500 },
        };

        // --- INITIAL STATE ---
        const initialState = {
            windows: [],            // Active app instances
            activeWindowId: null,   // Currently focused app
            nextZIndex: 100,        // Stacking order counter
            isMobile: window.innerWidth < 768, // Mobile detection
            theme: 'dark',          // UI Theme
            
            // User Preferences
            settings: {
                showGrid: true,
                animations: true,
                currencyBase: 'INR'
            }
        };

        // --- THE REDUCER (Logic Engine) ---
        function osReducer(state, action) {
            switch (action.type) {
                
                // 1. LAUNCH APP
                case 'OPEN_APP': {
                    const appId = action.payload;
                    const appConfig = APP_REGISTRY[appId];
                    
                    // Check if already open
                    const isOpen = state.windows.find(w => w.id === appId);
                    if (isOpen) {
                        // Bring to front
                        return {
                            ...state,
                            activeWindowId: appId,
                            nextZIndex: state.nextZIndex + 1,
                            windows: state.windows.map(w => 
                                w.id === appId 
                                ? { ...w, zIndex: state.nextZIndex, isMinimized: false }
                                : w
                            )
                        };
                    }

                    // Create new window instance
                    const newWindow = {
                        ...appConfig,
                        instanceId: Date.now(),
                        zIndex: state.nextZIndex,
                        isMinimized: false,
                        isMaximized: state.isMobile, // Force maximize on mobile
                        x: state.isMobile ? 0 : 50 + (state.windows.length * 30),
                        y: state.isMobile ? 0 : 50 + (state.windows.length * 30)
                    };

                    return {
                        ...state,
                        activeWindowId: appId,
                        nextZIndex: state.nextZIndex + 1,
                        windows: [...state.windows, newWindow]
                    };
                }

                // 2. CLOSE APP
                case 'CLOSE_APP': {
                    const remaining = state.windows.filter(w => w.id !== action.payload);
                    const nextActive = remaining.length > 0 
                        ? remaining.sort((a,b) => b.zIndex - a.zIndex)[0].id 
                        : null;

                    return { ...state, windows: remaining, activeWindowId: nextActive };
                }

                // 3. FOCUS APP (Bring to Front)
                case 'FOCUS_APP': {
                    if (state.activeWindowId === action.payload) return state;
                    return {
                        ...state,
                        activeWindowId: action.payload,
                        nextZIndex: state.nextZIndex + 1,
                        windows: state.windows.map(w => 
                            w.id === action.payload ? { ...w, zIndex: state.nextZIndex } : w
                        )
                    };
                }

                // 4. WINDOW CONTROLS
                case 'MINIMIZE_APP':
                    return {
                        ...state,
                        activeWindowId: null,
                        windows: state.windows.map(w => w.id === action.payload ? { ...w, isMinimized: true } : w)
                    };

                case 'MAXIMIZE_APP':
                    return {
                        ...state,
                        windows: state.windows.map(w => w.id === action.payload ? { ...w, isMaximized: !w.isMaximized } : w)
                    };

                // 5. SYSTEM EVENTS
                case 'SET_MOBILE':
                    return { ...state, isMobile: action.payload };

                default:
                    return state;
            }
        }

        // --- CONTEXT PROVIDER ---
        const OSProvider = ({ children }) => {
            const [state, dispatch] = React.useReducer(osReducer, initialState);

            // Responsive Listener
            React.useEffect(() => {
                const handleResize = () => {
                    const mobile = window.innerWidth < 768;
                    if (mobile !== state.isMobile) {
                        dispatch({ type: 'SET_MOBILE', payload: mobile });
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [state.isMobile]);

            return (
                <OSContext.Provider value={{ state, dispatch, APP_REGISTRY }}>
                    {children}
                </OSContext.Provider>
            );
        };

        const useOS = () => React.useContext(OSContext);

        /* PART 2 COMPLETE: KERNEL READY */
        // ==================================================================================
        // 3. WINDOW ENGINE: THE CONTAINER FOR ALL APPS
        // ==================================================================================

        const WindowFrame = ({ windowData, children }) => {
            const { dispatch, state } = useOS();
            const { 
                id, title, icon, color,
                x, y, width, height, 
                zIndex, isMinimized, isMaximized 
            } = windowData;
            
            // --- PHYSICS STATE ---
            const [pos, setPos] = React.useState({ x, y });
            const [isDragging, setIsDragging] = React.useState(false);
            const dragOffset = React.useRef({ x: 0, y: 0 });
            
            // Ref for bounds checking
            const windowRef = React.useRef(null);

            // --- FOCUS HANDLER ---
            // bringing window to front on click
            const handleFocus = () => dispatch({ type: 'FOCUS_APP', payload: id });

            // --- DRAG LOGIC (Desktop Only) ---
            const handleMouseDown = (e) => {
                if (state.isMobile || isMaximized) return; // Disable drag on mobile/maximized
                
                // Only draggble via header
                e.stopPropagation();
                handleFocus();
                
                setIsDragging(true);
                dragOffset.current = { 
                    x: e.clientX - pos.x, 
                    y: e.clientY - pos.y 
                };
            };

            React.useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    // Update position
                    const newX = e.clientX - dragOffset.current.x;
                    const newY = e.clientY - dragOffset.current.y;
                    
                    setPos({ x: newX, y: newY });
                };

                const handleMouseUp = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging]);

            // --- RENDER LOGIC ---
            if (isMinimized) return null;

            // Styles
            const isFull = isMaximized || state.isMobile;
            const containerStyle = {
                zIndex: zIndex,
                position: isFull ? 'fixed' : 'absolute',
                top: isFull ? 0 : pos.y,
                left: isFull ? 0 : pos.x,
                width: isFull ? '100%' : width,
                height: isFull ? '100%' : height,
                borderRadius: isFull ? 0 : '12px',
                transition: isDragging ? 'none' : 'all 0.2s cubic-bezier(0.2, 0, 0, 1)', // Snappy snap
                transform: isDragging ? 'scale(1.01)' : 'scale(1)',
                opacity: isDragging ? 0.95 : 1,
            };

            return (
                <div 
                    ref={windowRef}
                    style={containerStyle}
                    onMouseDownCapture={handleFocus}
                    className="flex flex-col glass shadow-glass overflow-hidden text-white"
                >
                    {/* --- TITLE BAR --- */}
                    <div 
                        className={`
                            h-12 shrink-0 flex items-center justify-between px-4 select-none
                            ${isFull ? 'bg-sg-surface border-b border-sg-border' : 'bg-white/5 border-b border-white/5'}
                        `}
                        onMouseDown={handleMouseDown}
                        style={{ cursor: isFull ? 'default' : 'grab' }}
                        onDoubleClick={() => !state.isMobile && dispatch({ type: 'MAXIMIZE_APP', payload: id })}
                    >
                        {/* Title & Icon */}
                        <div className="flex items-center gap-3 pointer-events-none">
                            <div className="w-8 h-8 rounded-lg flex items-center justify-center bg-white/10 text-lg">
                                <i className={`fas ${icon}`} style={{ color: color }}></i>
                            </div>
                            <div>
                                <div className="font-bold text-sm tracking-wide text-gray-100">{title}</div>
                                {isFull && <div className="text-[10px] text-gray-500 hidden sm:block">StudyGraphs India</div>}
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex items-center gap-2" onMouseDown={e => e.stopPropagation()}>
                            <button 
                                onClick={() => dispatch({ type: 'MINIMIZE_APP', payload: id })}
                                className="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors"
                            >
                                <i className="fas fa-minus"></i>
                            </button>
                            
                            {!state.isMobile && (
                                <button 
                                    onClick={() => dispatch({ type: 'MAXIMIZE_APP', payload: id })}
                                    className="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors"
                                >
                                    <i className={`fas ${isMaximized ? 'fa-compress' : 'fa-expand'}`}></i>
                                </button>
                            )}

                            <button 
                                onClick={() => dispatch({ type: 'CLOSE_APP', payload: id })}
                                className="w-8 h-8 rounded hover:bg-red-500/20 flex items-center justify-center text-gray-400 hover:text-red-400 transition-colors"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    {/* --- APP CONTENT --- */}
                    <div className="flex-1 relative bg-sg-bg/50 backdrop-blur-sm overflow-hidden">
                        {children}
                    </div>
                </div>
            );
        };

        /* PART 3 COMPLETE: WINDOW ENGINE READY */
        // ==================================================================================
        // 4. SYSTEM UI: TASKBAR & APP LAUNCHER
        // ==================================================================================

        // --- CLOCK WIDGET ---
        const Clock = () => {
            const [time, setTime] = React.useState(new Date());

            React.useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center h-full px-4 text-gray-300 select-none cursor-default hover:text-white transition-colors">
                    <div className="text-sm font-bold font-mono leading-none">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-[10px] opacity-60">
                        {time.toLocaleDateString([], { month: 'short', day: 'numeric' })}
                    </div>
                </div>
            );
        };

        // --- MAIN TASKBAR ---
        const Taskbar = () => {
            const { state, dispatch, APP_REGISTRY } = useOS();
            const { windows, activeWindowId, isMobile } = state;

            // Define pinned apps (Quick Access)
            const pinned = ['graph', 'solver', 'periodic', 'physics', 'converter'];
            
            // Merge pinned with currently open apps (deduplicate)
            const dockItems = [...new Set([...pinned, ...windows.map(w => w.id)])];

            return (
                <div className="fixed bottom-0 left-0 w-full z-[99999] pointer-events-none flex justify-center pb-2">
                    <div className="pointer-events-auto bg-sg-surface/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl flex items-center p-2 gap-1 mb-2 mx-2 max-w-full overflow-x-auto no-scrollbar">
                        
                        {/* Start Menu Button (Simulated) */}
                        <button 
                            className="w-10 h-10 rounded-xl flex items-center justify-center bg-brand-primary/10 text-brand-primary hover:bg-brand-primary hover:text-white transition-all mr-2"
                            title="Apps Menu"
                        >
                            <i className="fas fa-grid-2"></i>
                        </button>

                        <div className="w-px h-6 bg-white/10 mx-1"></div>

                        {/* App Icons */}
                        {dockItems.map(appId => {
                            const app = APP_REGISTRY[appId];
                            if (!app) return null; // Safety check

                            const isOpen = windows.find(w => w.id === appId);
                            const isActive = activeWindowId === appId;

                            return (
                                <button
                                    key={appId}
                                    onClick={() => dispatch({ type: 'OPEN_APP', payload: appId })}
                                    className={`
                                        group relative w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300
                                        ${isActive ? 'bg-white/10' : 'hover:bg-white/5'}
                                    `}
                                    title={app.title}
                                >
                                    <i 
                                        className={`fas ${app.icon} text-lg transition-transform group-hover:-translate-y-1`}
                                        style={{ color: app.color }}
                                    ></i>
                                    
                                    {/* Running Indicator (Dot) */}
                                    {isOpen && (
                                        <div className={`
                                            absolute bottom-1 w-1 h-1 rounded-full transition-all duration-300
                                            ${isActive ? 'w-3 bg-brand-primary' : 'bg-gray-500'}
                                        `}></div>
                                    )}
                                    
                                    {/* Tooltip (Desktop Only) */}
                                    {!isMobile && (
                                        <div className="absolute bottom-full mb-3 px-2 py-1 bg-black/80 backdrop-blur text-xs rounded text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap border border-white/10">
                                            {app.title}
                                        </div>
                                    )}
                                </button>
                            );
                        })}

                        <div className="w-px h-6 bg-white/10 mx-1"></div>

                        {/* System Tray (Clock, etc.) */}
                        <div className="hidden sm:flex">
                            <Clock />
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 4 COMPLETE: NAVIGATION READY */
        // ==================================================================================
        // 5. DESKTOP ENVIRONMENT
        // ==================================================================================

        const Desktop = () => {
            const { dispatch, APP_REGISTRY, state } = useOS();

            // --- WALLPAPER ANIMATION ---
            // Using a CSS-in-JS approach for the Aurora effect
            const wallpaperStyle = {
                position: 'fixed',
                top: 0, left: 0,
                width: '100%', height: '100%',
                background: 'linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a)',
                backgroundSize: '400% 400%',
                animation: 'gradientBG 15s ease infinite',
                zIndex: -1
            };

            // Global Keyframes injection
            React.useEffect(() => {
                const styleSheet = document.createElement("style");
                styleSheet.innerText = `
                    @keyframes gradientBG {
                        0% { background-position: 0% 50%; }
                        50% { background-position: 100% 50%; }
                        100% { background-position: 0% 50%; }
                    }
                    .desktop-icon:hover { background: rgba(255, 255, 255, 0.1); }
                    .desktop-icon:active { transform: scale(0.95); }
                `;
                document.head.appendChild(styleSheet);
                return () => document.head.removeChild(styleSheet);
            }, []);

            // --- SHORTCUTS CONFIG ---
            // Only the most critical apps on the desktop
            const shortcuts = ['graph', 'solver', 'periodic', 'physics', 'formulas', 'code'];

            return (
                <div 
                    className="fixed inset-0 overflow-hidden" 
                    onContextMenu={(e) => e.preventDefault()} // Disable native context menu
                >
                    {/* 1. The Wallpaper */}
                    <div style={wallpaperStyle}></div>
                    
                    {/* 2. Grid Overlay (Subtle Tech Feel) */}
                    <div className="absolute inset-0 opacity-[0.03] pointer-events-none"
                         style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }}>
                    </div>

                    {/* 3. Icon Grid */}
                    <div className="relative z-0 p-4 pt-6 flex flex-col flex-wrap content-start h-[calc(100%-80px)] gap-2 sm:gap-4 pointer-events-none">
                        {/* Wrapper for pointer events */}
                        <div className="pointer-events-auto flex flex-col flex-wrap content-start gap-4 h-full">
                            {shortcuts.map(appId => {
                                const app = APP_REGISTRY[appId];
                                return (
                                    <div 
                                        key={appId}
                                        onClick={() => state.isMobile && dispatch({ type: 'OPEN_APP', payload: appId })}
                                        onDoubleClick={() => !state.isMobile && dispatch({ type: 'OPEN_APP', payload: appId })}
                                        className="desktop-icon w-20 sm:w-24 flex flex-col items-center gap-1 p-2 rounded-lg border border-transparent hover:border-white/5 transition-all cursor-pointer group select-none"
                                    >
                                        {/* Icon Box */}
                                        <div 
                                            className="w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-lg transition-transform group-hover:-translate-y-1"
                                            style={{ 
                                                background: `linear-gradient(135deg, ${app.color}20, ${app.color}05)`, 
                                                border: `1px solid ${app.color}40`,
                                                boxShadow: `0 4px 20px ${app.color}20`
                                            }}
                                        >
                                            <i 
                                                className={`fas ${app.icon}`} 
                                                style={{ color: app.color, filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))' }}
                                            ></i>
                                        </div>
                                        
                                        {/* Label */}
                                        <span className="text-[10px] sm:text-xs font-medium text-gray-200 text-center bg-black/20 px-2 py-0.5 rounded shadow-sm line-clamp-2 backdrop-blur-[2px]">
                                            {app.title}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* 4. Branding Watermark (Bottom Right) */}
                    <div className="absolute bottom-16 right-4 text-right pointer-events-none opacity-30 hidden sm:block">
                        <h1 className="text-2xl font-bold font-sans tracking-tight text-white">StudyGraphs India</h1>
                        <p className="text-xs text-gray-400">Professional STEM Environment v2.0</p>
                    </div>
                </div>
            );
        };

        /* PART 5 COMPLETE: DESKTOP READY */
        // ==================================================================================
        // 6. APP MODULE: GRAPH PLOTTER PRO (Scientific Graphing Engine)
        // ==================================================================================

        const GraphApp = () => {
            // --- STATE MANAGEMENT ---
            const [inputs, setInputs] = React.useState([
                { id: 1, val: 'sin(x)', color: '#3b82f6', visible: true },
                { id: 2, val: 'x^2 / 10', color: '#f43f5e', visible: true }
            ]);
            const [range, setRange] = React.useState({ min: -10, max: 10 });
            const plotRef = React.useRef(null);

            // --- PLOTTING ENGINE ---
            React.useEffect(() => {
                if (!window.Plotly) return;

                const data = [];
                const layout = {
                    autosize: true,
                    margin: { t: 30, r: 20, b: 40, l: 40 }, // Tight layout
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#94a3b8', family: 'Inter' },
                    xaxis: { 
                        gridcolor: '#334155', 
                        zerolinecolor: '#94a3b8',
                        range: [range.min, range.max]
                    },
                    yaxis: { 
                        gridcolor: '#334155', 
                        zerolinecolor: '#94a3b8' 
                    },
                    showlegend: false,
                    hovermode: 'closest'
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    displaylogo: false
                };

                // Generate traces for each valid input
                inputs.forEach(inp => {
                    if (!inp.val || !inp.visible) return;

                    try {
                        const expr = math.compile(inp.val);
                        const xValues = [];
                        const yValues = [];
                        
                        // Adaptive sampling: 500 points for smoothness
                        const step = (range.max - range.min) / 500;
                        for (let x = range.min; x <= range.max; x += step) {
                            try {
                                const y = expr.evaluate({ x });
                                xValues.push(x);
                                yValues.push(y);
                            } catch (e) { /* Ignore undefined points */ }
                        }

                        data.push({
                            x: xValues,
                            y: yValues,
                            mode: 'lines',
                            line: { color: inp.color, width: 3 },
                            name: `y = ${inp.val}`
                        });
                    } catch (err) {
                        // Silent fail on syntax error (user is still typing)
                    }
                });

                // Render Plot
                Plotly.newPlot(plotRef.current, data, layout, config);

            }, [inputs, range]);

            // --- HANDLERS ---
            const addEquation = () => {
                const colors = ['#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                const newId = Date.now();
                setInputs([...inputs, { 
                    id: newId, 
                    val: '', 
                    color: colors[inputs.length % colors.length], 
                    visible: true 
                }]);
            };

            const updateEquation = (id, newVal) => {
                setInputs(inputs.map(i => i.id === id ? { ...i, val: newVal } : i));
            };

            const removeEquation = (id) => {
                if (inputs.length > 1) {
                    setInputs(inputs.filter(i => i.id !== id));
                }
            };

            return (
                <div className="flex flex-col md:flex-row h-full text-white overflow-hidden select-none">
                    
                    {/* --- SIDEBAR: EQUATION EDITOR --- */}
                    <div className="w-full md:w-80 flex-shrink-0 bg-sg-surface border-b md:border-b-0 md:border-r border-sg-border flex flex-col z-10">
                        {/* Header */}
                        <div className="p-4 border-b border-sg-border bg-sg-bg/50">
                            <h2 className="text-sm font-bold uppercase tracking-wider text-gray-400">Expressions</h2>
                        </div>

                        {/* List */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {inputs.map((inp, idx) => (
                                <div key={inp.id} className="flex items-center gap-2 animate-fadeIn">
                                    {/* Color Indicator */}
                                    <div 
                                        className="w-8 h-8 rounded-lg flex items-center justify-center font-math font-bold text-lg bg-black/30 border border-white/10"
                                        style={{ color: inp.color }}
                                    >
                                        <i className="fas fa-wave-square text-xs"></i>
                                    </div>

                                    {/* Input Field */}
                                    <div className="flex-1 relative group">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-mono text-xs italic">y=</span>
                                        <input 
                                            type="text" 
                                            value={inp.val}
                                            onChange={(e) => updateEquation(inp.id, e.target.value)}
                                            className="w-full bg-sg-bg border border-sg-border rounded-lg py-2 pl-8 pr-8 font-mono text-sm text-white focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition-all"
                                            placeholder="Enter equation..."
                                        />
                                        {/* Delete Button */}
                                        <button 
                                            onClick={() => removeEquation(inp.id)}
                                            className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                            
                            {/* Add Button */}
                            <button 
                                onClick={addEquation}
                                className="w-full py-2 border border-dashed border-gray-600 rounded-lg text-xs text-gray-400 hover:text-white hover:border-gray-400 transition-colors flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-plus"></i> Add Expression
                            </button>
                        </div>

                        {/* Controls Footer */}
                        <div className="p-4 border-t border-sg-border bg-sg-bg/50 text-xs">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-gray-400">X-Range</span>
                                <span className="text-brand-primary font-mono">[{range.min}, {range.max}]</span>
                            </div>
                            <input 
                                type="range" 
                                min="5" max="50" 
                                value={range.max}
                                onChange={(e) => {
                                    const val = Number(e.target.value);
                                    setRange({ min: -val, max: val });
                                }}
                                className="w-full accent-brand-primary h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>

                    {/* --- MAIN: GRAPH CANVAS --- */}
                    <div className="flex-1 relative bg-sg-bg flex flex-col">
                        <div id="graph-container" className="flex-1 relative w-full h-full">
                            <div ref={plotRef} className="absolute inset-0 w-full h-full" />
                            
                            {/* Loading State / Empty State Hint */}
                            {inputs.every(i => !i.val) && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-20">
                                    <i className="fas fa-chart-line text-6xl mb-4"></i>
                                    <p className="font-mono text-sm">Start typing an equation...</p>
                                </div>
                            )}
                        </div>
                    </div>

                </div>
            );
        };

        /* PART 6 COMPLETE: GRAPH ENGINE READY */
        // ==================================================================================
        // 7. APP MODULE: UNIVERSAL SOLVER (Symbolic CAS Engine)
        // ==================================================================================

        const SolverApp = () => {
            const [input, setInput] = React.useState('');
            const [history, setHistory] = React.useState([]);
            const [mode, setMode] = React.useState('RAD'); // RAD or DEG
            const bottomRef = React.useRef(null);
// Add this helper inside SolverApp
const solveSystem = (eqs) => {
    // Logic for solving up to 3 equations
    // Example input: ["x+y=5", "x-y=1"]
    try {
        const result = math.solve(eqs); // Using Math.js internal system solver
        return result.toString();
    } catch(e) {
        return "System unsolvable or inconsistent.";
    }
};
            // --- COMPUTATION ENGINE ---
            const processCalculation = () => {
                if (!input.trim()) return;

                let result = '';
                let type = 'numeric';
                
                try {
                    // 1. Try Symbolic Computation (Algebrite)
                    // We interpret specific keywords to Algebrite syntax
                    let expr = input
                        .replace(/sin\(/g, 'sin(')
                        .replace(/cos\(/g, 'cos(')
                        .replace(/π/g, 'pi');

                    // Check for calculus commands
                    if (expr.startsWith('d/dx')) {
                        // Extract content: d/dx(x^2) -> d(x^2)
                        const inner = expr.match(/\((.*)\)/)[1];
                        result = Algebrite.run(`d(${inner})`);
                        type = 'Symbolic Derivative';
                    } else if (expr.startsWith('∫')) {
                        const inner = expr.match(/\((.*)\)/)[1];
                        result = Algebrite.run(`integral(${inner})`);
                        type = 'Symbolic Integral';
                    } else {
                        // Try simplifying first
                        const simple = Algebrite.run(expr);
                        
                        // If Algebrite returns the same thing or error, try Math.js for numeric
                        if (simple === expr || simple.includes('Stop')) {
                            const numeric = math.evaluate(expr);
                            // Round to 8 decimals if float
                            result = typeof numeric === 'number' 
                                ? parseFloat(numeric.toFixed(8)).toString() 
                                : numeric.toString();
                        } else {
                            result = simple;
                            type = 'Simplification';
                        }
                    }

                    // 2. Format Result for LaTeX
                    // Algebrite output needs to be cleaned for KaTeX
                    const latexResult = result
                        .replace(/\*/g, '\\cdot ')
                        .replace(/(sin|cos|tan|log)/g, '\\$1')
                        .replace(/pi/g, '\\pi');

                    const newEntry = {
                        id: Date.now(),
                        query: input,
                        result: result, // Raw text
                        latex: latexResult, // For display
                        type: type
                    };

                    setHistory([...history, newEntry]);
                    setInput('');
                    
                    // Auto-scroll
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);

                } catch (err) {
                    setHistory([...history, {
                        id: Date.now(),
                        query: input,
                        result: "Syntax Error",
                        latex: "\\text{Syntax Error}",
                        type: 'Error',
                        isError: true
                    }]);
                }
            };

            // --- UI HELPERS ---
            const insert = (val) => setInput(prev => prev + val);
            const backspace = () => setInput(prev => prev.slice(0, -1));
            const clear = () => { setInput(''); setHistory([]); };
            
            // Helper to render math safely
            const MathDisplay = ({ tex }) => {
                const containerRef = React.useRef(null);
                React.useEffect(() => {
                    if(containerRef.current && window.katex) {
                        try {
                            katex.render(tex, containerRef.current, { throwOnError: false, displayMode: true });
                        } catch(e) {}
                    }
                }, [tex]);
                return <div ref={containerRef} className="overflow-x-auto py-2" />;
            };

            // Keypad Layout
            const keys = [
                { l: 'sin', v: 'sin(', c: 'func' }, { l: 'cos', v: 'cos(', c: 'func' }, { l: 'tan', v: 'tan(', c: 'func' }, { l: 'log', v: 'log(', c: 'func' },
                { l: '(', v: '(', c: 'op' },        { l: ')', v: ')', c: 'op' },        { l: 'x', v: 'x', c: 'var' },       { l: '÷', v: '/', c: 'op' },
                { l: '7', v: '7', c: 'num' },       { l: '8', v: '8', c: 'num' },       { l: '9', v: '9', c: 'num' },       { l: '×', v: '*', c: 'op' },
                { l: '4', v: '4', c: 'num' },       { l: '5', v: '5', c: 'num' },       { l: '6', v: '6', c: 'num' },       { l: '-', v: '-', c: 'op' },
                { l: '1', v: '1', c: 'num' },       { l: '2', v: '2', c: 'num' },       { l: '3', v: '3', c: 'num' },       { l: '+', v: '+', c: 'op' },
                { l: '0', v: '0', c: 'num' },       { l: '.', v: '.', c: 'num' },       { l: 'π', v: 'pi', c: 'const' },    { l: '=', act: processCalculation, c: 'action' },
            ];

            const advKeys = [
                { l: 'd/dx', v: 'd/dx(', desc: 'Derivative' },
                { l: '∫', v: '∫(', desc: 'Integral' },
                { l: '√', v: 'sqrt(', desc: 'Root' },
                { l: '^', v: '^', desc: 'Power' },
            ];

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- HISTORY / DISPLAY AREA --- */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scroll space-y-4">
                        {history.length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-gray-600 opacity-40">
                                <i className="fas fa-calculator text-6xl mb-4"></i>
                                <p>Enter a problem to solve</p>
                                <p className="text-xs mt-2">Try: d/dx(x^2) or sin(45 deg)</p>
                            </div>
                        )}
                        
                        {history.map(item => (
                            <div key={item.id} className="bg-white/5 rounded-xl p-4 border border-white/5 animate-fadeIn">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs font-mono text-gray-400">{item.query}</span>
                                    <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded ${item.isError ? 'bg-red-500/20 text-red-400' : 'bg-brand-primary/20 text-brand-primary'}`}>
                                        {item.type}
                                    </span>
                                </div>
                                <div className="text-lg text-white">
                                    {item.isError ? item.result : <MathDisplay tex={item.latex} />}
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>

                    {/* --- INPUT AREA --- */}
                    <div className="bg-sg-surface border-t border-sg-border p-2">
                        {/* Input Box */}
                        <div className="flex items-center gap-2 bg-black/30 rounded-lg border border-white/10 p-2 mb-2">
                            <span className="text-brand-primary font-bold">f(x)</span>
                            <input 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && processCalculation()}
                                className="flex-1 bg-transparent border-none outline-none font-mono text-lg text-white placeholder-gray-600"
                                placeholder="Calculate..."
                                autoFocus
                            />
                            <button onClick={backspace} className="text-gray-400 hover:text-white px-2"><i className="fas fa-backspace"></i></button>
                        </div>

                        {/* Advanced Row */}
                        <div className="flex gap-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                            <button onClick={clear} className="px-4 py-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white text-xs font-bold transition-colors">CLR</button>
                            {advKeys.map((k, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => insert(k.v)}
                                    className="px-4 py-2 rounded bg-white/5 hover:bg-white/10 text-sci-purple text-xs font-bold border border-white/5 whitespace-nowrap"
                                >
                                    {k.l}
                                </button>
                            ))}
                        </div>

                        {/* Main Grid */}
                        <div className="grid grid-cols-4 gap-1.5 h-48 sm:h-56">
                            {keys.map((k, i) => (
                                <button 
                                    key={i}
                                    onClick={k.act || (() => insert(k.v))}
                                    className={`
                                        rounded-lg text-lg font-bold transition-all active:scale-95 shadow-sm
                                        ${k.c === 'num' ? 'bg-white/5 hover:bg-white/10 text-white' : ''}
                                        ${k.c === 'op' ? 'bg-brand-primary/10 hover:bg-brand-primary/20 text-brand-primary' : ''}
                                        ${k.c === 'func' ? 'bg-transparent text-gray-400 text-sm hover:text-white' : ''}
                                        ${k.c === 'var' ? 'text-sci-green italic' : ''}
                                        ${k.c === 'const' ? 'text-sci-gold' : ''}
                                        ${k.c === 'action' ? 'bg-brand-primary hover:bg-blue-400 text-white shadow-glow' : ''}
                                    `}
                                >
                                    {k.l}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 7 COMPLETE: SOLVER PRO READY */
        // ==================================================================================
        // 8. APP MODULE: ELEMENTA 3D (Visual Chemistry)
        // ==================================================================================

        // --- 3D ATOM COMPONENT ---
        const AtomViewer = ({ atomicNumber, color }) => {
            const mountRef = React.useRef(null);
            
            React.useEffect(() => {
                if (!mountRef.current) return;

                // Scene Setup
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(50, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 100);
                camera.position.z = 15;
                
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                mountRef.current.appendChild(renderer.domElement);

                // Nucleus
                const nucleusGeo = new THREE.SphereGeometry(1.2, 32, 32);
                const nucleusMat = new THREE.MeshBasicMaterial({ color: color });
                const nucleus = new THREE.Mesh(nucleusGeo, nucleusMat);
                scene.add(nucleus);

                // Glow
                const glowGeo = new THREE.SphereGeometry(1.8, 32, 32);
                const glowMat = new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.3 });
                const glow = new THREE.Mesh(glowGeo, glowMat);
                scene.add(glow);

                // Electrons
                const electrons = [];
                const orbits = [];
                const shells = [2, 8, 18, 32, 32, 18, 8];
                let remaining = atomicNumber;
                let shellIdx = 0;

                while (remaining > 0 && shellIdx < shells.length) {
                    const count = Math.min(remaining, shells[shellIdx]);
                    const radius = 4 + (shellIdx * 2);
                    
                    // Orbit Ring
                    const orbitGeo = new THREE.RingGeometry(radius - 0.03, radius + 0.03, 64);
                    const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, opacity: 0.15, transparent: true });
                    const orbit = new THREE.Mesh(orbitGeo, orbitMat);
                    
                    // Random rotation for 3D effect
                    orbit.rotation.x = Math.random() * Math.PI;
                    orbit.rotation.y = Math.random() * Math.PI;
                    scene.add(orbit);
                    orbits.push(orbit);

                    // Add Electrons to this shell
                    for (let i = 0; i < count; i++) {
                        const angle = (i / count) * Math.PI * 2;
                        const elGeo = new THREE.SphereGeometry(0.25, 8, 8);
                        const elMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                        const el = new THREE.Mesh(elGeo, elMat);
                        
                        // Metadata for animation
                        el.userData = { angle, radius, speed: 0.02 - (shellIdx * 0.002), orbitRot: orbit.rotation };
                        scene.add(el);
                        electrons.push(el);
                    }
                    
                    remaining -= count;
                    shellIdx++;
                }

                // Animation Loop
                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    
                    nucleus.rotation.y += 0.01;
                    
                    electrons.forEach(e => {
                        e.userData.angle += e.userData.speed;
                        const x = Math.cos(e.userData.angle) * e.userData.radius;
                        const z = Math.sin(e.userData.angle) * e.userData.radius;
                        
                        // Apply orbit rotation
                        const vec = new THREE.Vector3(x, 0, z);
                        vec.applyEuler(e.userData.orbitRot);
                        e.position.copy(vec);
                    });
                    
                    renderer.render(scene, camera);
                };
                animate();

                // Cleanup
                return () => {
                    cancelAnimationFrame(frameId);
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                    // Memory cleanup
                    nucleusGeo.dispose(); nucleusMat.dispose();
                    renderer.dispose();
                };
            }, [atomicNumber, color]); // Re-run when element changes

            return <div ref={mountRef} className="w-full h-full" />;
        };

        // --- MAIN APP ---
        const PeriodicApp = () => {
            // Compressed dataset for top 18 elements
            const elements = [
                { n: 1, s: 'H', name: 'Hydrogen', m: '1.008', cat: 'Nonmetal', col: '#ef4444' },
                { n: 2, s: 'He', name: 'Helium', m: '4.0026', cat: 'Noble Gas', col: '#a855f7' },
                { n: 3, s: 'Li', name: 'Lithium', m: '6.94', cat: 'Alkali Metal', col: '#f59e0b' },
                { n: 4, s: 'Be', name: 'Beryllium', m: '9.0122', cat: 'Alkaline Earth', col: '#eab308' },
                { n: 5, s: 'B', name: 'Boron', m: '10.81', cat: 'Metalloid', col: '#10b981' },
                { n: 6, s: 'C', name: 'Carbon', m: '12.011', cat: 'Nonmetal', col: '#ef4444' },
                { n: 7, s: 'N', name: 'Nitrogen', m: '14.007', cat: 'Nonmetal', col: '#ef4444' },
                { n: 8, s: 'O', name: 'Oxygen', m: '15.999', cat: 'Nonmetal', col: '#ef4444' },
                { n: 9, s: 'F', name: 'Fluorine', m: '18.998', cat: 'Halogen', col: '#06b6d4' },
                { n: 10, s: 'Ne', name: 'Neon', m: '20.180', cat: 'Noble Gas', col: '#a855f7' },
                { n: 11, s: 'Na', name: 'Sodium', m: '22.990', cat: 'Alkali Metal', col: '#f59e0b' },
                { n: 12, s: 'Mg', name: 'Magnesium', m: '24.305', cat: 'Alkaline Earth', col: '#eab308' },
                { n: 13, s: 'Al', name: 'Aluminium', m: '26.982', cat: 'Post-transition', col: '#94a3b8' },
                { n: 14, s: 'Si', name: 'Silicon', m: '28.085', cat: 'Metalloid', col: '#10b981' },
                { n: 15, s: 'P', name: 'Phosphorus', m: '30.974', cat: 'Nonmetal', col: '#ef4444' },
                { n: 16, s: 'S', name: 'Sulfur', m: '32.06', cat: 'Nonmetal', col: '#ef4444' },
                { n: 17, s: 'Cl', name: 'Chlorine', m: '35.45', cat: 'Halogen', col: '#06b6d4' },
                { n: 18, s: 'Ar', name: 'Argon', m: '39.948', cat: 'Noble Gas', col: '#a855f7' },
            ];

            const [selected, setSelected] = React.useState(elements[0]);

            return (
                <div className="flex flex-col md:flex-row h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: TABLE GRID --- */}
                    <div className="flex-1 p-4 overflow-y-auto custom-scroll">
                        <h2 className="text-xl font-bold mb-4 font-cyber text-sci-gold flex items-center gap-2">
                            <i className="fas fa-flask"></i> Periodic Table
                        </h2>
                        
                        <div className="grid grid-cols-6 sm:grid-cols-9 gap-2">
                            {elements.map(el => (
                                <button
                                    key={el.n}
                                    onClick={() => setSelected(el)}
                                    className={`
                                        aspect-square p-1 rounded border transition-all duration-200 flex flex-col items-center justify-center relative overflow-hidden group
                                        ${selected.n === el.n ? 'bg-white/10 border-white shadow-glow' : 'border-white/10 hover:bg-white/5'}
                                    `}
                                    style={{ borderColor: selected.n === el.n ? el.col : '' }}
                                >
                                    <span className="text-[8px] absolute top-1 left-1 opacity-50">{el.n}</span>
                                    <span className="text-lg font-bold" style={{ color: el.col }}>{el.s}</span>
                                    <span className="text-[8px] text-gray-400 truncate w-full text-center group-hover:text-white transition-colors">{el.name}</span>
                                </button>
                            ))}
                        </div>
                        <div className="mt-8 text-center text-xs text-gray-500 italic">
                            Showing first 18 elements for demo performance.
                        </div>
                    </div>

                    {/* --- RIGHT: INSPECTOR PANEL --- */}
                    <div className="h-1/2 md:h-full md:w-96 bg-sg-surface border-t md:border-t-0 md:border-l border-sg-border flex flex-col">
                        {/* 3D View */}
                        <div className="flex-1 relative bg-gradient-to-br from-black to-sg-bg overflow-hidden">
                            <div className="absolute top-4 left-4 z-10">
                                <h1 className="text-4xl font-bold text-white opacity-90">{selected.s}</h1>
                                <p className="text-sm font-mono text-gray-400">{selected.name}</p>
                            </div>
                            <AtomViewer atomicNumber={selected.n} color={selected.col} />
                        </div>

                        {/* Data Card */}
                        <div className="p-6 bg-white/5">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-black/20 p-3 rounded border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold">Atomic Mass</div>
                                    <div className="text-lg font-mono text-sci-gold">{selected.m} u</div>
                                [Image of Periodic table atomic mass]
                                </div>
                                <div className="bg-black/20 p-3 rounded border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold">Category</div>
                                    <div className="text-sm font-bold" style={{ color: selected.col }}>{selected.cat}</div>
                                </div>
                            </div>
                            
                            <div className="mt-4 pt-4 border-t border-white/10">
                                <div className="text-[10px] uppercase text-gray-500 font-bold mb-2">Electron Configuration</div>
                                <div className="flex gap-1">
                                    {/* Simple visualization of shells */}
                                    {[2, 8, 8, 18].map((max, i) => {
                                        let count = 0;
                                        let rem = selected.n;
                                        for(let j=0; j<i; j++) rem -= [2,8,8,18][j]; // crude logic for demo
                                        if (rem > 0) count = Math.min(rem, max);
                                        
                                        return count > 0 ? (
                                            <div key={i} className="flex flex-col items-center">
                                                <div className="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center text-xs font-mono bg-white/5">
                                                    {count}
                                                </div>
                                                <span className="text-[8px] text-gray-600 mt-1">K-L-M-N'[i]</span>
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        /* PART 8 COMPLETE: ELEMENTA 3D READY */
        // ==================================================================================
        // 9. APP MODULE: PHYSICS SIM LAB (Matter.js Integration)
        // ==================================================================================

        const PhysicsApp = () => {
            const sceneRef = React.useRef(null);
            const engineRef = React.useRef(null);
            const runnerRef = React.useRef(null);
            
            // Simulation Parameters
            const [config, setConfig] = React.useState({
                gravity: 1,
                timeScale: 1,
                bounciness: 0.9
            });
            const [objCount, setObjCount] = React.useState(0);

            // --- INITIALIZATION ---
            React.useEffect(() => {
                if (!sceneRef.current) return;

                // Module Aliases
                const Engine = Matter.Engine,
                      Render = Matter.Render,
                      Runner = Matter.Runner,
                      World = Matter.World,
                      Bodies = Matter.Bodies,
                      MouseConstraint = Matter.MouseConstraint,
                      Mouse = Matter.Mouse,
                      Composite = Matter.Composite;

                // Create Engine
                const engine = Engine.create();
                const world = engine.world;
                engineRef.current = engine;

                // Create Renderer
                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width: sceneRef.current.clientWidth,
                        height: sceneRef.current.clientHeight,
                        background: 'transparent', // Transparent to see OS background
                        wireframes: false,
                        showAngleIndicator: false
                    }
                });

                // Add Walls
                const w = sceneRef.current.clientWidth;
                const h = sceneRef.current.clientHeight;
                const wallOpts = { isStatic: true, render: { fillStyle: '#334155' } };
                
                World.add(world, [
                    Bodies.rectangle(w/2, h + 25, w, 50, wallOpts), // Floor
                    Bodies.rectangle(w + 25, h/2, 50, h, wallOpts), // Right
                    Bodies.rectangle(-25, h/2, 50, h, wallOpts)     // Left
                ]);

                // Mouse Interaction (Essential for "Touch" on mobile)
                const mouse = Mouse.create(render.canvas);
                const mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: { stiffness: 0.2, render: { visible: false } }
                });
                World.add(world, mouseConstraint);
                render.mouse = mouse; // Sync

                // Run
                Render.run(render);
                const runner = Runner.create();
                runnerRef.current = runner;
                Runner.run(runner, engine);

                // Resize Handler
                const handleResize = () => {
                    render.canvas.width = sceneRef.current.clientWidth;
                    render.canvas.height = sceneRef.current.clientHeight;
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    Render.stop(render);
                    Runner.stop(runner);
                    World.clear(world);
                    Engine.clear(engine);
                    window.removeEventListener('resize', handleResize);
                    render.canvas.remove();
                };
            }, []);

            // --- DYNAMIC UPDATES ---
            React.useEffect(() => {
                if (engineRef.current) {
                    engineRef.current.world.gravity.y = config.gravity;
                    engineRef.current.timing.timeScale = config.timeScale;
                }
            }, [config]);

            // --- ACTIONS ---
            const spawn = (type) => {
                if (!engineRef.current) return;
                
                const w = sceneRef.current.clientWidth;
                const x = Math.random() * (w - 100) + 50;
                const y = 50;
                const color = ['#3b82f6', '#10b981', '#f59e0b', '#f43f5e'][Math.floor(Math.random()*4)];
                const opts = {
                    restitution: config.bounciness,
                    render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 1 }
                };

                let body;
                if (type === 'box') body = Matter.Bodies.rectangle(x, y, 40, 40, opts);
                if (type === 'circle') body = Matter.Bodies.circle(x, y, 20, opts);
                if (type === 'poly') body = Matter.Bodies.polygon(x, y, 5, 25, opts);

                if (body) {
                    Matter.World.add(engineRef.current.world, body);
                    setObjCount(prev => prev + 1);
                }
            };

            const clear = () => {
                if (!engineRef.current) return;
                const bodies = Matter.Composite.allBodies(engineRef.current.world);
                const toRemove = bodies.filter(b => !b.isStatic); // Keep walls
                Matter.Composite.remove(engineRef.current.world, toRemove);
                setObjCount(0);
            };

            return (
                <div className="flex h-full bg-sg-bg text-white relative font-sans overflow-hidden">
                    
                    {/* --- CANVAS LAYER --- */}
                    <div ref={sceneRef} className="absolute inset-0 z-0 cursor-crosshair"></div>

                    {/* --- CONTROLS OVERLAY --- */}
                    <div className="absolute top-4 left-4 z-10 w-64 bg-sg-surface/90 backdrop-blur-md border border-white/10 rounded-xl p-4 shadow-xl">
                        <h2 className="text-sm font-bold uppercase tracking-wider text-sci-green mb-3 flex items-center gap-2">
                            <i className="fas fa-atom"></i> Lab Controls
                        </h2>
                        
                        {/* Spawners */}
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            {[
                                { l: 'Box', i: 'fa-square', t: 'box' },
                                { l: 'Ball', i: 'fa-circle', t: 'circle' },
                                { l: 'Poly', i: 'fa-shapes', t: 'poly' }
                            ].map(btn => (
                                <button 
                                    key={btn.t} 
                                    onClick={() => spawn(btn.t)}
                                    className="flex flex-col items-center gap-1 p-2 bg-white/5 hover:bg-white/10 rounded transition-colors"
                                >
                                    <i className={`fas ${btn.i} text-lg text-gray-300`}></i>
                                    <span className="text-[10px]">{btn.l}</span>
                                </button>
                            ))}
                        </div>

                        {/* Sliders */}
                        <div className="space-y-3">
                            <div>
                                <div className="flex justify-between text-[10px] font-bold uppercase text-gray-400 mb-1">
                                    <span>Gravity</span>
                                    <span>{config.gravity.toFixed(1)}g</span>
                                </div>
                                <input 
                                    type="range" min="0" max="2" step="0.1" 
                                    value={config.gravity}
                                    onChange={e => setConfig({...config, gravity: parseFloat(e.target.value)})}
                                    className="w-full accent-sci-green h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-[10px] font-bold uppercase text-gray-400 mb-1">
                                    <span>Time Scale</span>
                                    <span>{config.timeScale.toFixed(1)}x</span>
                                </div>
                                <input 
                                    type="range" min="0.1" max="2" step="0.1" 
                                    value={config.timeScale}
                                    onChange={e => setConfig({...config, timeScale: parseFloat(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="mt-4 pt-3 border-t border-white/10 flex justify-between items-center">
                            <span className="text-xs text-gray-400">Objects: {objCount}</span>
                            <button 
                                onClick={clear}
                                className="text-xs text-red-400 hover:text-red-300 font-bold"
                            >
                                <i className="fas fa-trash-alt mr-1"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 9 COMPLETE: PHYSICS LAB READY */
        // ==================================================================================
        // ==================================================================================
        // 10. APP MODULE: FORMULA LIBRARY (Reference Database)
        // ==================================================================================

        const FormulaApp = () => {
            const [activeCat, setActiveCat] = React.useState('Algebra');
            const [search, setSearch] = React.useState('');

            // --- MERGED DATABASE ---
            const library = {
                'Algebra': [
                    { t: 'Quadratic Formula', f: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}' },
                    { t: 'Logarithm Rules', f: '\\log_b(xy) = \\log_b(x) + \\log_b(y)' },
                    { t: 'Binomial Theorem', f: '(a+b)^n = \\sum_{k=0}^{n} \\binom{n}{k} a^{n-k}b^k' },
                    { t: 'Complex Number Form', f: 'z = r(\\cos \\theta + i \\sin \\theta) = re^{i\\theta}' },
                    { t: 'Arithmetic Progression', f: 'a_n = a + (n-1)d' },
                    { t: 'Geometric Sum', f: 'S_n = \\frac{a(r^n - 1)}{r-1}' }
                ],
                'Trigonometry': [
                    { t: 'Pythagorean Identity', f: '\\sin^2\\theta + \\cos^2\\theta = 1' },
                    { t: 'Sine Rule', f: '\\frac{a}{\\sin A} = \\frac{b}{\\sin B} = \\frac{c}{\\sin C}' },
                    { t: 'Cosine Rule', f: 'c^2 = a^2 + b^2 - 2ab \\cos C' },
                    { t: 'Double Angle', f: '\\sin(2\\theta) = 2\\sin\\theta\\cos\\theta' }
                ],
                'Calculus': [
                    { t: 'Power Rule', f: '\\frac{d}{dx}x^n = nx^{n-1}' },
                    { t: 'Product Rule', f: '(uv)\' = u\'v + uv\'' },
                    { t: 'Chain Rule', f: '\\frac{dy}{dx} = \\frac{dy}{du} \\cdot \\frac{du}{dx}' },
                    { t: 'Integration by Parts', f: '\\int u \\, dv = uv - \\int v \\, du' },
                    { t: 'Gaussian Integral', f: '\\int_{-\\infty}^{\\infty} e^{-x^2} \\, dx = \\sqrt{\\pi}' }
                ],
                'Physics': [
                    { t: 'Newton\'s Second Law', f: 'F = ma' },
                    { t: 'Kinematics', f: 's = ut + \\frac{1}{2}at^2' },
                    { t: 'Kinetic Energy', f: 'E_k = \\frac{1}{2}mv^2' },
                    { t: 'Gravitational Force', f: 'F = G\\frac{m_1m_2}{r^2}' },
                    { t: 'Photoelectric Eq', f: 'h\\nu = \\phi + K_{max}' }
                ],
                'Thermodynamics': [
                    { t: 'First Law', f: '\\Delta Q = \\Delta U + \\Delta W' },
                    { t: 'Ideal Gas Law', f: 'PV = nRT' },
                    { t: 'Entropy Change', f: '\\Delta S = \\int \\frac{dQ_{rev}}{T}' },
                    { t: 'RMS Speed', f: 'v_{rms} = \\sqrt{\\frac{3RT}{M}}' }
                ],
                'Electromagnetism': [
                    { t: 'Coulomb\'s Law', f: 'F = \\frac{1}{4\\pi\\epsilon_0} \\frac{q_1 q_2}{r^2}' },
                    { t: 'Gauss\'s Law', f: '\\oint \\vec{E} \\cdot d\\vec{A} = \\frac{Q_{encl}}{\\epsilon_0}' },
                    { t: 'Faraday\'s Law', f: '\\mathcal{E} = - \\frac{d\\Phi_B}{dt}' },
                    { t: 'Capacitance', f: 'C = \\frac{\\epsilon_0 A}{d}' }
                ],
                'Chemistry': [
                    { t: 'Molarity', f: 'M = \\frac{n_{solute}}{V_{solution} (L)}' },
                    { t: 'Nernst Equation', f: 'E_{cell} = E^0_{cell} - \\frac{0.0591}{n} \\log Q' },
                    { t: 'Arrhenius Equation', f: 'k = A e^{-E_a/RT}' },
                    { t: 'Gibbs Free Energy', f: '\\Delta G = \\Delta H - T\\Delta S' }
                ]
            };

            // Helper to render KaTeX safely
            const Tex = ({ tex }) => {
                const r = React.useRef(null);
                React.useEffect(() => {
                    if (r.current && window.katex) 
                        katex.render(tex, r.current, { throwOnError: false, displayMode: true });
                }, [tex]);
                return <div ref={r} className="my-2" />;
            };

            // Filter Logic
            const filtered = search 
                ? Object.values(library).flat().filter(item => item.t.toLowerCase().includes(search.toLowerCase()))
                : library[activeCat];

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- SIDEBAR (Categories) --- */}
                    <div className="w-16 sm:w-48 bg-sg-surface border-r border-sg-border flex flex-col pt-4 items-center sm:items-stretch overflow-y-auto no-scrollbar">
                        <div className="px-4 mb-4 hidden sm:block">
                            <h2 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Chapters</h2>
                        </div>
                        {Object.keys(library).map(cat => (
                            <button
                                key={cat}
                                onClick={() => { setActiveCat(cat); setSearch(''); }}
                                className={`
                                    w-10 sm:w-full sm:px-4 py-3 flex items-center gap-3 transition-colors mb-1 mx-auto sm:mx-0 rounded-lg sm:rounded-none
                                    ${activeCat === cat && !search ? 'bg-brand-primary/10 text-brand-primary border-l-2 border-brand-primary' : 'text-gray-400 hover:text-white hover:bg-white/5'}
                                `}
                                title={cat}
                            >
                                <div className="text-lg w-6 text-center">
                                    <i className="fas fa-book"></i>
                                </div>
                                <span className="hidden sm:block text-sm font-medium truncate">{cat}</span>
                            </button>
                        ))}
                    </div>

                    {/* --- MAIN CONTENT --- */}
                    <div className="flex-1 flex flex-col min-w-0">
                        {/* Search Bar */}
                        <div className="h-16 border-b border-sg-border flex items-center px-6 bg-sg-bg/50 backdrop-blur-sm sticky top-0 z-10">
                            <div className="relative w-full max-w-md">
                                <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                <input 
                                    type="text" 
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                    placeholder="Search formulas (e.g., 'Kinetic Energy')..."
                                    className="w-full bg-sg-surface border border-sg-border rounded-full py-2 pl-10 pr-4 text-sm text-white focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition-all"
                                />
                            </div>
                        </div>

                        {/* Grid */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                            <h2 className="text-xl font-bold mb-6 text-white font-math">
                                {search ? `Results for "${search}"` : activeCat}
                            </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filtered && filtered.map((item, idx) => (
                                    <div key={idx} className="bg-sg-surface/50 border border-white/5 rounded-xl p-4 hover:border-brand-primary/50 transition-all hover:shadow-lg group">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="text-sm font-bold text-gray-300 group-hover:text-white transition-colors">
                                                {item.t}
                                            </h3>
                                            <button 
                                                className="text-gray-500 hover:text-brand-primary"
                                                title="Copy LaTeX"
                                                onClick={() => navigator.clipboard.writeText(item.f)}
                                            >
                                                <i className="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div className="bg-black/20 rounded p-2 overflow-x-auto">
                                            <Tex tex={item.f} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        /* PART 10 COMPLETE: FORMULA LIBRARY READY */
        // ==================================================================================
        // 11. APP MODULE: CONVERTER (Units & Currency)
        // ==================================================================================

        const ConverterApp = () => {
            const [mode, setMode] = React.useState('length');
            const [valA, setValA] = React.useState(1);
            const [valB, setValB] = React.useState(1);
            const [unitA, setUnitA] = React.useState('m');
            const [unitB, setUnitB] = React.useState('ft');

            // --- CONVERSION FACTORS ---
            const data = {
                length: {
                    label: 'Length', icon: 'fa-ruler',
                    rates: { 'm': 1, 'km': 1000, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254, 'mi': 1609.34 }
                },
                mass: {
                    label: 'Mass', icon: 'fa-weight-hanging',
                    rates: { 'kg': 1, 'g': 0.001, 'mg': 1e-6, 'lb': 0.453592, 'oz': 0.0283495, 't': 1000 }
                },
                currency: {
                    label: 'Currency', icon: 'fa-coins',
                    // Base USD. Simulated rates.
                    rates: { 'USD': 1, 'INR': 83.12, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 148.2, 'CNY': 7.19, 'RUB': 90.5, 'AED': 3.67 }
                },
                digital: {
                    label: 'Storage', icon: 'fa-hard-drive',
                    rates: { 'B': 1, 'KB': 1024, 'MB': 1048576, 'GB': 1.074e9, 'TB': 1.1e12 }
                }
            };

            // Logic: Convert A -> Base -> B
            const convert = (val, from, to, type) => {
                const r = data[type].rates;
                const base = val * r[from];
                return base / r[to];
            };

            // Handlers
            const handleA = (v) => {
                setValA(v);
                setValB(convert(v, unitA, unitB, mode));
            };
            
            const handleB = (v) => {
                setValB(v);
                setValA(convert(v, unitB, unitA, mode)); // Reverse
            };

            // Reset when switching modes
            const switchMode = (m) => {
                setMode(m);
                const keys = Object.keys(data[m].rates);
                setUnitA(keys[0]);
                setUnitB(keys[1] || keys[0]);
                setValA(1);
                setValB(convert(1, keys[0], keys[1] || keys[0], m));
            };

            // Update when units change
            React.useEffect(() => {
                setValB(convert(valA, unitA, unitB, mode));
            }, [unitA, unitB]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- SIDEBAR --- */}
                    <div className="w-16 bg-sg-surface border-r border-sg-border flex flex-col py-4 items-center gap-2">
                        {Object.keys(data).map(k => (
                            <button
                                key={k}
                                onClick={() => switchMode(k)}
                                className={`
                                    w-10 h-10 rounded-xl flex items-center justify-center transition-all
                                    ${mode === k ? 'bg-brand-primary text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}
                                `}
                                title={data[k].label}
                            >
                                <i className={`fas ${data[k].icon}`}></i>
                            </button>
                        ))}
                    </div>

                    {/* --- MAIN --- */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-sg-bg to-sg-surface">
                        <div className="w-full max-w-sm space-y-6">
                            
                            <div className="text-center">
                                <h2 className="text-2xl font-bold font-sans">{data[mode].label}</h2>
                                <p className="text-xs text-gray-500">Real-time Conversion Matrix</p>
                            </div>

                            <div className="space-y-4">
                                {/* Input A */}
                                <div className="bg-black/30 p-1 rounded-xl border border-white/10 flex items-center">
                                    <input 
                                        type="number" 
                                        value={valA} 
                                        onChange={e => handleA(parseFloat(e.target.value) || 0)}
                                        className="bg-transparent border-none outline-none w-full p-3 text-xl font-mono text-white"
                                    />
                                    <div className="w-px h-8 bg-white/10 mx-2"></div>
                                    <select 
                                        value={unitA} 
                                        onChange={e => setUnitA(e.target.value)}
                                        className="bg-transparent border-none outline-none text-sm font-bold text-brand-primary p-2 cursor-pointer"
                                    >
                                        {Object.keys(data[mode].rates).map(u => <option key={u} value={u} className="bg-sg-surface text-white">{u}</option>)}
                                    </select>
                                </div>

                                {/* Swap Icon */}
                                <div className="flex justify-center">
                                    <button 
                                        onClick={() => { const t = unitA; setUnitA(unitB); setUnitB(t); }}
                                        className="w-8 h-8 rounded-full bg-white/5 hover:bg-brand-primary hover:text-white flex items-center justify-center transition-all text-gray-400"
                                    >
                                        <i className="fas fa-arrow-right-arrow-left text-xs"></i>
                                    </button>
                                </div>

                                {/* Input B */}
                                <div className="bg-black/30 p-1 rounded-xl border border-white/10 flex items-center">
                                    <input 
                                        type="number" 
                                        value={valB} 
                                        onChange={e => handleB(parseFloat(e.target.value) || 0)}
                                        className="bg-transparent border-none outline-none w-full p-3 text-xl font-mono text-white"
                                    />
                                    <div className="w-px h-8 bg-white/10 mx-2"></div>
                                    <select 
                                        value={unitB} 
                                        onChange={e => setUnitB(e.target.value)}
                                        className="bg-transparent border-none outline-none text-sm font-bold text-brand-accent p-2 cursor-pointer"
                                    >
                                        {Object.keys(data[mode].rates).map(u => <option key={u} value={u} className="bg-sg-surface text-white">{u}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Info */}
                            <div className="text-center text-xs text-gray-500 font-mono">
                                1 {unitA} = {(data[mode].rates[unitA] / data[mode].rates[unitB]).toFixed(4)} {unitB}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        /* PART 11 COMPLETE: CONVERTER READY */
        // ==================================================================================
        // 26. APP MODULE: SYSTEM SOLVER (Linear Algebra)
        // ==================================================================================

        const SystemSolverApp = () => {
            const [mode, setMode] = React.useState(2); // 2 or 3 variables
            const [eqs, setEqs] = React.useState({
                a1: 1, b1: 1, c1: 0, d1: 5,
                a2: 1, b2: -1, c2: 0, d2: 1,
                a3: 0, b3: 0, c3: 0, d3: 0
            });
            const [solution, setSolution] = React.useState(null);

            const handleChange = (field, val) => {
                setEqs({ ...eqs, [field]: parseFloat(val) || 0 });
            };

            const solve = () => {
                const { a1, b1, c1, d1, a2, b2, c2, d2, a3, b3, c3, d3 } = eqs;
                let res = {};

                if (mode === 2) {
                    // Cramer's Rule 2x2
                    // a1x + b1y = d1
                    // a2x + b2y = d2
                    const D = (a1 * b2) - (a2 * b1);
                    const Dx = (d1 * b2) - (d2 * b1);
                    const Dy = (a1 * d2) - (a2 * d1);

                    if (D === 0) {
                        res = { error: "Determinant is 0. No unique solution." };
                    } else {
                        res = {
                            x: Dx / D,
                            y: Dy / D,
                            steps: [
                                `\\Delta = (${a1})(${b2}) - (${a2})(${b1}) = ${D}`,
                                `\\Delta_x = (${d1})(${b2}) - (${d2})(${b1}) = ${Dx}`,
                                `\\Delta_y = (${a1})(${d2}) - (${a2})(${d1}) = ${Dy}`,
                                `x = \\Delta_x / \\Delta = ${Dx/D}`,
                                `y = \\Delta_y / \\Delta = ${Dy/D}`
                            ]
                        };
                    }
                } else {
                    // Cramer's Rule 3x3
                    const D = a1*(b2*c3 - b3*c2) - b1*(a2*c3 - a3*c2) + c1*(a2*b3 - a3*b2);
                    const Dx = d1*(b2*c3 - b3*c2) - b1*(d2*c3 - d3*c2) + c1*(d2*b3 - d3*b2);
                    const Dy = a1*(d2*c3 - d3*c2) - d1*(a2*c3 - a3*c2) + c1*(a2*d3 - a3*d2);
                    const Dz = a1*(b2*d3 - b3*d2) - b1*(a2*d3 - a3*d2) + d1*(a2*b3 - a3*b2);

                    if (D === 0) {
                        res = { error: "Determinant is 0. System inconsistent." };
                    } else {
                        res = {
                            x: Dx / D,
                            y: Dy / D,
                            z: Dz / D,
                            steps: [
                                `\\Delta = ${D}`,
                                `\\Delta_x = ${Dx}, \\Delta_y = ${Dy}, \\Delta_z = ${Dz}`,
                                `x = ${Number(Dx/D).toFixed(2)}, y = ${Number(Dy/D).toFixed(2)}, z = ${Number(Dz/D).toFixed(2)}`
                            ]
                        };
                    }
                }
                setSolution(res);
            };

            // LaTeX Renderer Helper
            const StepTex = ({ tex }) => {
                const r = React.useRef(null);
                React.useEffect(() => {
                    if (r.current && window.katex) katex.render(tex, r.current);
                }, [tex]);
                return <div ref={r} className="text-sm my-1" />;
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    <div className="w-full max-w-2xl mx-auto p-6 flex flex-col">
                        
                        {/* Header & Toggle */}
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold font-math text-sci-purple">System Solver</h2>
                            <div className="flex bg-sg-surface rounded-lg p-1 border border-white/10">
                                <button onClick={() => setMode(2)} className={`px-4 py-1 rounded text-xs font-bold transition-all ${mode===2 ? 'bg-sci-purple text-white shadow-lg' : 'text-gray-400'}`}>2 Variables</button>
                                <button onClick={() => setMode(3)} className={`px-4 py-1 rounded text-xs font-bold transition-all ${mode===3 ? 'bg-sci-purple text-white shadow-lg' : 'text-gray-400'}`}>3 Variables</button>
                            </div>
                        </div>

                        {/* Equation Inputs */}
                        <div className="bg-sg-surface/50 p-6 rounded-xl border border-white/5 space-y-4">
                            {[1, 2, (mode === 3 ? 3 : null)].filter(Boolean).map(i => (
                                <div key={i} className="flex items-center gap-2 font-math text-lg">
                                    <input type="number" value={eqs[`a${i}`]} onChange={e => handleChange(`a${i}`, e.target.value)} className="w-12 bg-black/30 border border-white/10 rounded px-2 text-right outline-none focus:border-sci-purple" />
                                    <span className="text-gray-400">x +</span>
                                    <input type="number" value={eqs[`b${i}`]} onChange={e => handleChange(`b${i}`, e.target.value)} className="w-12 bg-black/30 border border-white/10 rounded px-2 text-right outline-none focus:border-sci-purple" />
                                    <span className="text-gray-400">y</span>
                                    {mode === 3 && (
                                        <>
                                            <span className="text-gray-400"> + </span>
                                            <input type="number" value={eqs[`c${i}`]} onChange={e => handleChange(`c${i}`, e.target.value)} className="w-12 bg-black/30 border border-white/10 rounded px-2 text-right outline-none focus:border-sci-purple" />
                                            <span className="text-gray-400">z</span>
                                        </>
                                    )}
                                    <span className="text-sci-gold font-bold">=</span>
                                    <input type="number" value={eqs[`d${i}`]} onChange={e => handleChange(`d${i}`, e.target.value)} className="w-12 bg-black/30 border border-white/10 rounded px-2 text-right outline-none focus:border-sci-purple" />
                                </div>
                            ))}
                        </div>

                        {/* Action */}
                        <button onClick={solve} className="mt-4 w-full py-3 bg-brand-primary hover:bg-blue-600 rounded-lg font-bold shadow-glow transition-all">
                            Solve System
                        </button>

                        {/* Solution Panel */}
                        {solution && (
                            <div className="mt-6 bg-black/20 rounded-xl p-4 border border-white/10 animate-fadeIn">
                                {solution.error ? (
                                    <div className="text-red-400 font-bold"><i className="fas fa-triangle-exclamation mr-2"></i>{solution.error}</div>
                                ) : (
                                    <>
                                        <div className="flex gap-4 mb-4 border-b border-white/10 pb-4">
                                            <div className="px-4 py-2 bg-sci-green/20 text-sci-green rounded-lg font-bold border border-sci-green/30">x = {Number(solution.x).toFixed(4)}</div>
                                            <div className="px-4 py-2 bg-sci-green/20 text-sci-green rounded-lg font-bold border border-sci-green/30">y = {Number(solution.y).toFixed(4)}</div>
                                            {mode === 3 && <div className="px-4 py-2 bg-sci-green/20 text-sci-green rounded-lg font-bold border border-sci-green/30">z = {Number(solution.z).toFixed(4)}</div>}
                                        </div>
                                        <div className="space-y-2">
                                            <div className="text-xs font-bold text-gray-500 uppercase">Steps (Cramer's Rule)</div>
                                            {solution.steps.map((s, i) => <StepTex key={i} tex={s} />)}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ==================================================================================
        // KERNEL UPDATE: DYNAMIC APP REGISTRY
        // ==================================================================================
        
        // 1. Register the new app
        APP_REGISTRY.systems = { 
            id: 'systems', 
            title: 'System Solver', 
            icon: 'fa-layer-group', 
            color: '#8b5cf6', 
            width: 700, 
            height: 600 
        };

        // 2. Updated Window Renderer (Dynamic)
        // This replaces the hardcoded version from Part 14 to support NEW apps dynamically.
        const DynamicWindowRenderer = () => {
            const { state, APP_REGISTRY } = useOS();
            
            // Map IDs to Component Functions
            // Inside DynamicWindowRenderer...
const COMPONENT_MAP = {
                'graph': GraphApp,
                'solver': SolverApp,
                'periodic': PeriodicApp,
                'physics': PhysicsApp,
                'formulas': FormulaApp,
                'converter': ConverterApp,
                'code': CodeApp,
                'settings': SettingsApp,
                'systems': SystemSolverApp,
                'geo': GeometryApp,
                'stats': StatsApp,
                'bio': BioApp,
                'nexus': NexusApp,
                'export': ExportApp,
                'exam': ExamApp,
                'astro': AstroApp,
                'chemi': ChemiApp,
                'wave': WaveApp,
                'circuit': CircuitApp,
                'organic': OrganicApp,
                'logic': LogicApp,
                'vector': VectorApp,
                'thermo': ThermoApp,
                'matrix': MatrixApp,
                'trig': TrigApp,
                'proj': ProjectileApp,
                'dict': DictApp,
                'calc': CalculusApp,
                'fractal': FractalApp,
                'board': BoardApp,
                'music': MusicApp,
                'focus': FocusApp,
                'task': TaskMgrApp,
                'algo': AlgoApp,
                'crypto': CryptoApp,
                'resistor': ResistorApp,
                'base': BaseApp,
                'truth': TruthApp,
                'regex': RegexApp,
                'optics': OpticsApp,
                'genetic': GeneticApp,
                'balance': BalanceApp
            };

            return (
                <>
                    {state.windows.map(win => {
                        const Component = COMPONENT_MAP[win.id];
                        if (!Component) return null;
                        return (
                            <WindowFrame key={win.instanceId} windowData={win}>
                                <Component />
                            </WindowFrame>
                        );
                    })}
                </>
            );
        };

        /* PART 26 COMPLETE: SYSTEM SOLVER INTEGRATED */
        // ==================================================================================
        // 27. APP MODULE: GEOCONSTRUCT (Geometry Lab)
        // ==================================================================================

        const GeometryApp = () => {
            const canvasRef = React.useRef(null);
            const [points, setPoints] = React.useState([]);
            const [mode, setMode] = React.useState('point'); // point, line, circle
            const [selected, setSelected] = React.useState([]);

            // --- CANVAS LOGIC ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // Clear & Grid
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(0, 0, w, h);
                
                // Draw Grid
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 0.5;
                for(let i=0; i<w; i+=20) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
                for(let i=0; i<h; i+=20) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(w,i); ctx.stroke(); }

                // Draw Connections (Lines)
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                if (points.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y);
                    for(let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
                    if (mode === 'polygon') ctx.closePath();
                    ctx.stroke();
                }

                // Draw Points
                points.forEach((p, i) => {
                    ctx.fillStyle = selected.includes(i) ? '#f43f5e' : '#fff';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    // Label
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '10px monospace';
                    ctx.fillText(`${p.l}(${Math.round(p.x)},${Math.round(p.y)})`, p.x + 8, p.y - 8);
                });

            }, [points, selected, mode]);

            const handleClick = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Snap to grid (nearest 20)
                const snapX = Math.round(x / 20) * 20;
                const snapY = Math.round(y / 20) * 20;

                const newPoint = { x: snapX, y: snapY, l: String.fromCharCode(65 + points.length) };
                setPoints([...points, newPoint]);
            };

            const clear = () => { setPoints([]); setSelected([]); };

            // --- CALCULATIONS ---
            let stats = null;
            if (points.length >= 2) {
                const dx = points[1].x - points[0].x;
                const dy = points[1].y - points[0].y;
                const dist = Math.sqrt(dx*dx + dy*dy).toFixed(2);
                const slope = dx !== 0 ? (dy/dx).toFixed(2) : '∞';
                stats = { dist, slope };
            }

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans">
                    {/* Toolbar */}
                    <div className="h-12 border-b border-white/10 flex items-center px-4 gap-2 bg-sg-surface">
                        <div className="flex bg-black/20 rounded p-1">
                            {['point', 'line', 'polygon'].map(m => (
                                <button 
                                    key={m}
                                    onClick={() => setMode(m)}
                                    className={`px-3 py-1 rounded text-xs capitalize ${mode === m ? 'bg-brand-primary text-white' : 'text-gray-400'}`}
                                >
                                    {m}
                                </button>
                            ))}
                        </div>
                        <div className="w-px h-6 bg-white/10 mx-2"></div>
                        <button onClick={clear} className="text-red-400 text-xs hover:text-white"><i className="fas fa-trash"></i> Clear</button>
                        
                        {/* Live Stats */}
                        {stats && (
                            <div className="ml-auto text-xs font-mono text-sci-green flex gap-4">
                                <span>Dist: {stats.dist}px</span>
                                <span>Slope: {stats.slope}</span>
                            </div>
                        )}
                    </div>

                    {/* Canvas Area */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas ref={canvasRef} onClick={handleClick} className="absolute inset-0 w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER GEOMETRY APP ---
        APP_REGISTRY.geo = { id: 'geo', title: 'Geometry Lab', icon: 'fa-shapes', color: '#f59e0b', width: 800, height: 600 };
        
        /* PART 27 COMPLETE: GEOMETRY LAB READY */
        // ==================================================================================
        // 28. APP MODULE: STATCRUNCH (Statistics Engine)
        // ==================================================================================

        const StatsApp = () => {
            const [dataInput, setDataInput] = React.useState('12, 15, 12, 18, 22, 19, 25, 12');
            const [stats, setStats] = React.useState(null);
            const [probMode, setProbMode] = React.useState('nCr'); // nCr or nPr
            const [n, setN] = React.useState(5);
            const [r, setR] = React.useState(2);

            // --- STATISTICS LOGIC ---
            const calculateStats = () => {
                const arr = dataInput.split(',').map(x => parseFloat(x.trim())).filter(n => !isNaN(n));
                if (arr.length === 0) return;

                const n = arr.length;
                const mean = math.mean(arr);
                const median = math.median(arr);
                const mode = math.mode(arr);
                const std = math.std(arr);
                const variance = math.var(arr);
                const min = math.min(arr);
                const max = math.max(arr);

                setStats({ n, mean, median, mode: mode.join(', '), std, variance, min, max, arr });
            };

            // --- PROBABILITY LOGIC ---
            const calcProb = () => {
                try {
                    if (probMode === 'nCr') return math.combinations(n, r);
                    if (probMode === 'nPr') return math.permutations(n, r);
                } catch(e) { return 'Error'; }
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: STATISTICS --- */}
                    <div className="flex-1 p-6 flex flex-col border-r border-white/10">
                        <h2 className="text-lg font-bold font-math text-sci-purple mb-4">Descriptive Statistics</h2>
                        
                        <div className="mb-4">
                            <label className="text-xs text-gray-500 uppercase font-bold">Data Set (comma separated)</label>
                            <textarea 
                                value={dataInput}
                                onChange={e => setDataInput(e.target.value)}
                                className="w-full h-24 bg-black/30 border border-white/10 rounded-xl p-3 text-sm font-mono mt-2 focus:border-sci-purple outline-none"
                            />
                            <button 
                                onClick={calculateStats}
                                className="mt-2 px-4 py-2 bg-sci-purple hover:bg-purple-500 rounded text-xs font-bold"
                            >
                                Analyze Data
                            </button>
                        </div>

                        {stats && (
                            <div className="grid grid-cols-2 gap-4 animate-fadeIn">
                                <div className="bg-white/5 p-3 rounded border border-white/5">
                                    <div className="text-[10px] text-gray-400 uppercase">Mean (Average)</div>
                                    <div className="text-xl font-mono text-sci-green">{stats.mean.toFixed(2)}</div>
                                </div>
                                <div className="bg-white/5 p-3 rounded border border-white/5">
                                    <div className="text-[10px] text-gray-400 uppercase">Median</div>
                                    <div className="text-xl font-mono text-white">{stats.median}</div>
                                </div>
                                <div className="bg-white/5 p-3 rounded border border-white/5">
                                    <div className="text-[10px] text-gray-400 uppercase">Std. Deviation</div>
                                    <div className="text-xl font-mono text-sci-gold">{stats.std.toFixed(3)}</div>
                                </div>
                                <div className="bg-white/5 p-3 rounded border border-white/5">
                                    <div className="text-[10px] text-gray-400 uppercase">Variance</div>
                                    <div className="text-xl font-mono text-white">{stats.variance.toFixed(3)}</div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- RIGHT: PROBABILITY --- */}
                    <div className="w-64 bg-sg-surface p-6 flex flex-col">
                        <h2 className="text-lg font-bold font-math text-brand-primary mb-4">Probability</h2>
                        
                        <div className="bg-white/5 p-4 rounded-xl border border-white/5 mb-6">
                            <div className="flex gap-2 mb-4">
                                <button onClick={() => setProbMode('nCr')} className={`flex-1 py-1 rounded text-xs font-bold ${probMode === 'nCr' ? 'bg-brand-primary' : 'bg-black/20 text-gray-400'}`}>nCr</button>
                                <button onClick={() => setProbMode('nPr')} className={`flex-1 py-1 rounded text-xs font-bold ${probMode === 'nPr' ? 'bg-brand-primary' : 'bg-black/20 text-gray-400'}`}>nPr</button>
                            </div>
                            
                            <div className="space-y-3">
                                <div className="flex items-center justify-between">
                                    <span className="text-xs font-math italic">n =</span>
                                    <input type="number" value={n} onChange={e => setN(parseInt(e.target.value))} className="w-16 bg-black/30 rounded border border-white/10 text-right px-2" />
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-xs font-math italic">r =</span>
                                    <input type="number" value={r} onChange={e => setR(parseInt(e.target.value))} className="w-16 bg-black/30 rounded border border-white/10 text-right px-2" />
                                </div>
                                <div className="pt-3 border-t border-white/10 text-center">
                                    <div className="text-[10px] text-gray-500 uppercase">Result</div>
                                    <div className="text-2xl font-bold font-mono text-brand-primary">{calcProb()}</div>
                                </div>
                            </div>
                        </div>

                        <div className="text-xs text-gray-500 mt-auto">
                            <strong>Note:</strong> nCr calculates combinations (order doesn't matter), while nPr calculates permutations.
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER STATS APP ---
        APP_REGISTRY.stats = { id: 'stats', title: 'StatCrunch', icon: 'fa-chart-pie', color: '#ec4899', width: 750, height: 550 };
        
        /* PART 28 COMPLETE: STATS APP READY */
        // ==================================================================================
        // 29. APP MODULE: BIOSCOPE (Biology 3D & Encyclopedia)
        // ==================================================================================

        const BioApp = () => {
            const mountRef = React.useRef(null);
            const [topic, setTopic] = React.useState('DNA');

            // --- 3D DNA ENGINE ---
            React.useEffect(() => {
                if (!mountRef.current || topic !== 'DNA') return;

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(50, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 100);
                camera.position.z = 20;
                camera.position.y = 0;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                mountRef.current.appendChild(renderer.domElement);

                // DNA Group
                const dnaGroup = new THREE.Group();
                const sphereGeo = new THREE.SphereGeometry(0.5, 16, 16);
                const cylinderGeo = new THREE.CylinderGeometry(0.2, 0.2, 4, 8);

                // Procedural Generation
                for (let i = 0; i < 40; i++) {
                    const y = i * 0.8 - 15;
                    const angle = i * 0.5;
                    
                    // Strand 1
                    const s1 = new THREE.Mesh(sphereGeo, new THREE.MeshBasicMaterial({ color: 0x3b82f6 }));
                    s1.position.set(Math.cos(angle) * 3, y, Math.sin(angle) * 3);
                    dnaGroup.add(s1);

                    // Strand 2
                    const s2 = new THREE.Mesh(sphereGeo, new THREE.MeshBasicMaterial({ color: 0xf43f5e }));
                    s2.position.set(Math.cos(angle + Math.PI) * 3, y, Math.sin(angle + Math.PI) * 3);
                    dnaGroup.add(s2);

                    // Base Pair Connector
                    const connector = new THREE.Mesh(cylinderGeo, new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.5, transparent: true }));
                    connector.position.set(0, y, 0);
                    connector.rotation.z = Math.PI / 2;
                    connector.rotation.y = angle;
                    dnaGroup.add(connector);
                }

                // Tilt it
                dnaGroup.rotation.z = 0.2;
                dnaGroup.rotation.x = 0.2;
                scene.add(dnaGroup);

                // Animation
                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    dnaGroup.rotation.y += 0.02; // Spin
                    renderer.render(scene, camera);
                };
                animate();

                return () => {
                    cancelAnimationFrame(frameId);
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                    sphereGeo.dispose();
                    cylinderGeo.dispose();
                    renderer.dispose();
                };
            }, [topic]);

            // --- CONTENT DATABASE ---
            const content = {
                'DNA': {
                    title: 'Deoxyribonucleic Acid',
                    text: 'DNA is a molecule composed of two polynucleotide chains that coil around each other to form a double helix carrying genetic instructions for the development, functioning, growth and reproduction of all known organisms and many viruses.',
                    points: ['Double Helix Structure', 'Adenine-Thymine (A-T)', 'Guanine-Cytosine (G-C)', 'Sugar-Phosphate Backbone']
                },
                'Mitosis': {
                    title: 'Cell Division (Mitosis)',
                    text: 'Mitosis is a part of the cell cycle when replicated chromosomes are separated into two new nuclei. Cell division gives rise to genetically identical cells in which the number of chromosomes is maintained.',
                    points: ['Prophase: Chromosomes condense', 'Metaphase: Align at equator', 'Anaphase: Chromatids separate', 'Telophase: New nuclei form']
                },
                'Botany': {
                    title: 'Plant Biology',
                    text: 'Botany involves the study of structure, growth, reproduction, metabolism, development, diseases, chemical properties, and evolutionary relationships among taxonomic groups of plants.',
                    points: ['Photosynthesis: 6CO2 + 6H2O → C6H12O6 + 6O2', 'Xylem: Water transport', 'Phloem: Food transport']
                }
            };

            const activeContent = content[topic];

            return (
                <div className="flex flex-col md:flex-row h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: MENU --- */}
                    <div className="w-full md:w-64 bg-sg-surface border-b md:border-b-0 md:border-r border-sg-border p-4 flex flex-col gap-2">
                        <h2 className="text-lg font-bold text-sci-green mb-4 flex items-center gap-2">
                            <i className="fas fa-dna"></i> BioScope
                        </h2>
                        {Object.keys(content).map(k => (
                            <button
                                key={k}
                                onClick={() => setTopic(k)}
                                className={`
                                    w-full text-left px-4 py-3 rounded-xl transition-all border border-transparent
                                    ${topic === k ? 'bg-sci-green/10 border-sci-green text-sci-green font-bold' : 'bg-white/5 hover:bg-white/10 text-gray-400'}
                                `}
                            >
                                {k}
                            </button>
                        ))}
                    </div>

                    {/* --- RIGHT: VISUALIZER & INFO --- */}
                    <div className="flex-1 flex flex-col relative">
                        {/* 3D Canvas (Only for DNA) */}
                        {topic === 'DNA' ? (
                            <div className="flex-1 relative bg-gradient-to-br from-black to-blue-900/20">
                                <div ref={mountRef} className="absolute inset-0 w-full h-full" />
                            </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-center bg-black/50">
                                <i className="fas fa-microscope text-6xl text-white/10"></i>
                            </div>
                        )}

                        {/* Info Card Overlay */}
                        <div className="absolute bottom-6 left-6 right-6 bg-sg-surface/90 backdrop-blur-md border border-white/10 rounded-2xl p-6 shadow-2xl animate-slideUp">
                            <h1 className="text-2xl font-bold font-serif mb-2 text-white">{activeContent.title}</h1>
                            <p className="text-sm text-gray-300 leading-relaxed mb-4">{activeContent.text}</p>
                            <div className="flex flex-wrap gap-2">
                                {activeContent.points.map((p, i) => (
                                    <span key={i} className="px-3 py-1 bg-white/10 rounded-full text-xs text-sci-green border border-white/5">
                                        • {p}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER BIO APP ---
        APP_REGISTRY.bio = { id: 'bio', title: 'BioScope 3D', icon: 'fa-dna', color: '#10b981', width: 900, height: 700 };
        
        /* PART 29 COMPLETE: BIOSCOPE READY */
        // ==================================================================================
        // 30. APP MODULE: NEXUS NOTES (Study Organizer)
        // ==================================================================================

        const NexusApp = () => {
            const [notes, setNotes] = React.useState([
                { id: 1, title: 'Physics Project Ideas', tag: 'Physics', content: '- Build a railgun using capacitors\n- Simulate orbital mechanics\n- Investigate viscosity of fluids' },
                { id: 2, title: 'Calculus Formulas', tag: 'Math', content: 'd/dx(sin x) = cos x\nIntegral of 1/x = ln|x| + C\nRemember +C for indefinite integrals!' },
                { id: 3, title: 'Organic Chemistry Reactions', tag: 'Chemistry', content: '1. Aldol Condensation\n2. Cannizzaro Reaction\n3. Friedel-Crafts Alkylation' }
            ]);
            const [activeId, setActiveId] = React.useState(1);
            const [search, setSearch] = React.useState('');

            const activeNote = notes.find(n => n.id === activeId) || notes[0];

            // --- HANDLERS ---
            const updateNote = (field, value) => {
                setNotes(notes.map(n => n.id === activeId ? { ...n, [field]: value } : n));
            };

            const createNote = () => {
                const newId = Date.now();
                setNotes([...notes, { id: newId, title: 'Untitled Note', tag: 'General', content: '' }]);
                setActiveId(newId);
            };

            const deleteNote = (id, e) => {
                e.stopPropagation();
                const remaining = notes.filter(n => n.id !== id);
                setNotes(remaining);
                if (activeId === id && remaining.length > 0) setActiveId(remaining[0].id);
            };

            // Filter logic
            const filtered = notes.filter(n => n.title.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- SIDEBAR (List) --- */}
                    <div className="w-16 sm:w-64 bg-sg-surface border-r border-sg-border flex flex-col">
                        {/* Header */}
                        <div className="p-4 border-b border-white/5 flex items-center justify-between">
                            <h2 className="hidden sm:block text-sm font-bold font-cyber text-gray-400 uppercase tracking-wider">My Notes</h2>
                            <button onClick={createNote} className="w-8 h-8 rounded bg-brand-primary text-white flex items-center justify-center hover:bg-blue-600 transition-colors">
                                <i className="fas fa-plus"></i>
                            </button>
                        </div>

                        {/* Search */}
                        <div className="p-2 hidden sm:block">
                            <input 
                                type="text" 
                                placeholder="Search..." 
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                className="w-full bg-black/20 border border-white/5 rounded px-3 py-1 text-xs text-white outline-none focus:border-brand-primary"
                            />
                        </div>

                        {/* List */}
                        <div className="flex-1 overflow-y-auto custom-scroll">
                            {filtered.map(note => (
                                <div 
                                    key={note.id}
                                    onClick={() => setActiveId(note.id)}
                                    className={`
                                        p-3 sm:px-4 sm:py-3 cursor-pointer border-l-2 transition-all flex flex-col gap-1 group
                                        ${activeId === note.id ? 'bg-white/5 border-brand-primary' : 'border-transparent hover:bg-white/5'}
                                    `}
                                >
                                    <div className={`text-sm font-bold truncate ${activeId === note.id ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}`}>
                                        {note.title}
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="hidden sm:inline-block text-[10px] px-1.5 py-0.5 rounded bg-white/10 text-gray-500">
                                            {note.tag}
                                        </span>
                                        <button 
                                            onClick={(e) => deleteNote(note.id, e)}
                                            className="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <i className="fas fa-trash-alt text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* --- MAIN EDITOR --- */}
                    {activeNote ? (
                        <div className="flex-1 flex flex-col bg-sg-bg relative">
                            {/* Toolbar */}
                            <div className="h-12 border-b border-white/5 flex items-center justify-between px-6 bg-sg-bg/50 backdrop-blur-sm">
                                <span className="text-xs text-gray-500">Last edited: Just now</span>
                                <div className="flex gap-3 text-gray-400">
                                    <button className="hover:text-white"><i className="fas fa-share-nodes"></i></button>
                                    <button className="hover:text-white"><i className="fas fa-ellipsis-vertical"></i></button>
                                </div>
                            </div>

                            {/* Content */}
                            <div className="flex-1 overflow-y-auto p-8 custom-scroll">
                                <input 
                                    type="text" 
                                    value={activeNote.title}
                                    onChange={e => updateNote('title', e.target.value)}
                                    className="w-full bg-transparent border-none outline-none text-3xl font-bold font-sans text-white placeholder-gray-600 mb-6"
                                    placeholder="Untitled"
                                />
                                <textarea 
                                    value={activeNote.content}
                                    onChange={e => updateNote('content', e.target.value)}
                                    className="w-full h-[calc(100%-80px)] bg-transparent border-none outline-none text-base text-gray-300 placeholder-gray-700 font-mono resize-none leading-relaxed"
                                    placeholder="Start typing your notes here..."
                                />
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex items-center justify-center text-gray-600">
                            Select a note to view
                        </div>
                    )}
                </div>
            );
        };

        // --- REGISTER NEXUS APP ---
        APP_REGISTRY.nexus = { id: 'nexus', title: 'Nexus Notes', icon: 'fa-book-journal-whills', color: '#f97316', width: 900, height: 600 };
        
        /* PART 30 COMPLETE: NEXUS NOTES READY */
        // ==================================================================================
        // 31. APP MODULE: DOCUPRINT (System Exporter)
        // ==================================================================================

        const ExportApp = () => {
            const { state } = useOS();
            const [selectedWin, setSelectedWin] = React.useState(null);
            const [format, setFormat] = React.useState('pdf'); // pdf or png
            const [status, setStatus] = React.useState('idle'); // idle, processing, done

            // Filter out 'ExportApp' itself from the list to prevent infinite recursion
            const targetWindows = state.windows.filter(w => w.id !== 'export');

            const handleExport = async () => {
                if (!selectedWin) return;
                
                setStatus('processing');
                
                // 1. Find the DOM element of the target window
                // We assume window frames have an ID or we traverse based on internal logic.
                // Since we didn't set IDs on DOM elements in Part 3, we will use a workaround:
                // We ask the user to "Focus" the window, then capture the active one.
                // Better approach for this demo: Capture the whole screen or specific app container.
                // For high reliability in this simulated OS, we will target the 'root' but crop or 
                // ideally, we update WindowFrame in future to have IDs. 
                // CURRENT SOLUTION: We will simulate the capture of the "Active Content" area.
                
                try {
                    // Wait a bit for UI to settle
                    await new Promise(r => setTimeout(r, 500));

                    // In a real DOM scenario, we'd select document.getElementById(`window-${selectedWin}`)
                    // Here, we grab the generic window class. This is a simulation limitation.
                    // To make this functional, let's capture the 'body' but focused on the center.
                    const element = document.body; 

                    const canvas = await html2canvas(element, {
                        scale: 2, // High resolution
                        backgroundColor: '#0f172a',
                        ignoreElements: (node) => node.id === 'export-window' // Don't capture the export tool itself
                    });

                    if (format === 'png') {
                        // DOWNLOAD IMAGE
                        const link = document.createElement('a');
                        link.download = `StudyGraphs_${selectedWin}_${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    } else {
                        // GENERATE PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape A4
                        
                        // Header
                        pdf.setFillColor(15, 23, 42); // Navy Blue
                        pdf.rect(0, 0, 297, 20, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(16);
                        pdf.text('StudyGraphs India', 10, 13);
                        pdf.setFontSize(10);
                        pdf.text(`Exported: ${new Date().toLocaleString()}`, 230, 13);

                        // Content
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = 280;
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        
                        pdf.addImage(imgData, 'PNG', 8, 25, pdfWidth, pdfHeight);
                        pdf.save(`StudyGraphs_Report_${Date.now()}.pdf`);
                    }

                    setStatus('done');
                    setTimeout(() => setStatus('idle'), 2000);

                } catch (err) {
                    console.error(err);
                    setStatus('error');
                }
            };

            return (
                <div id="export-window" className="flex flex-col h-full bg-sg-bg text-white font-sans p-6">
                    <div className="flex items-center gap-4 mb-8">
                        <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl shadow-glow">
                            <i className="fas fa-print"></i>
                        </div>
                        <div>
                            <h1 className="text-2xl font-bold font-cyber">DocuPrint Engine</h1>
                            <p className="text-sm text-gray-400">Professional Report Generator</p>
                        </div>
                    </div>

                    {/* Step 1: Select Window */}
                    <div className="mb-6">
                        <label className="text-xs font-bold uppercase text-gray-500 mb-2 block">1. Select Source App</label>
                        <div className="grid grid-cols-2 gap-2">
                            {targetWindows.map(win => (
                                <button
                                    key={win.id}
                                    onClick={() => setSelectedWin(win.id)}
                                    className={`
                                        p-3 rounded-lg border text-left flex items-center gap-3 transition-all
                                        ${selectedWin === win.id ? 'bg-brand-primary/20 border-brand-primary text-white' : 'bg-white/5 border-white/5 text-gray-400 hover:bg-white/10'}
                                    `}
                                >
                                    <i className={`fas ${win.icon} text-lg`}></i>
                                    <span className="text-sm font-medium">{win.title}</span>
                                </button>
                            ))}
                            {targetWindows.length === 0 && (
                                <div className="col-span-2 text-center py-4 text-gray-500 italic border border-dashed border-gray-700 rounded-lg">
                                    No other apps running. Open an app to export.
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Step 2: Format */}
                    <div className="mb-8">
                        <label className="text-xs font-bold uppercase text-gray-500 mb-2 block">2. Output Format</label>
                        <div className="flex gap-4">
                            <button 
                                onClick={() => setFormat('pdf')}
                                className={`flex-1 py-3 rounded-lg border flex flex-col items-center gap-1 ${format === 'pdf' ? 'bg-red-500/20 border-red-500 text-red-500' : 'bg-white/5 border-transparent text-gray-400'}`}
                            >
                                <i className="fas fa-file-pdf text-xl"></i>
                                <span className="text-xs font-bold">PDF Document</span>
                            </button>
                            <button 
                                onClick={() => setFormat('png')}
                                className={`flex-1 py-3 rounded-lg border flex flex-col items-center gap-1 ${format === 'png' ? 'bg-blue-500/20 border-blue-500 text-blue-500' : 'bg-white/5 border-transparent text-gray-400'}`}
                            >
                                <i className="fas fa-image text-xl"></i>
                                <span className="text-xs font-bold">High-Res PNG</span>
                            </button>
                        </div>
                    </div>

                    {/* Action */}
                    <button
                        onClick={handleExport}
                        disabled={!selectedWin || status === 'processing'}
                        className={`
                            w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-3 transition-all
                            ${status === 'processing' ? 'bg-gray-600 cursor-wait' : 'bg-gradient-to-r from-brand-primary to-indigo-600 hover:scale-[1.02]'}
                        `}
                    >
                        {status === 'processing' ? (
                            <>
                                <i className="fas fa-circle-notch fa-spin"></i> Rendering...
                            </>
                        ) : status === 'done' ? (
                            <>
                                <i className="fas fa-check"></i> Export Complete
                            </>
                        ) : (
                            <>
                                <i className="fas fa-download"></i> Export Now
                            </>
                        )}
                    </button>
                    
                    <p className="text-center text-[10px] text-gray-500 mt-4">
                        Note: Generates a snapshot of the current viewport. Ensure the target app is visible.
                    </p>
                </div>
            );
        };

        // --- REGISTER EXPORT APP ---
        APP_REGISTRY.export = { id: 'export', title: 'DocuPrint', icon: 'fa-print', color: '#6366f1', width: 500, height: 650 };
        
        /* PART 31 COMPLETE: EXPORT ENGINE READY */
        // ==================================================================================
        // 32. APP MODULE: EXAMHALL (Quiz & Test Engine)
        // ==================================================================================

        const ExamApp = () => {
            const [screen, setScreen] = React.useState('menu'); // menu, test, result
            const [subject, setSubject] = React.useState('Physics');
            const [answers, setAnswers] = React.useState({});
            const [timeLeft, setTimeLeft] = React.useState(300); // 5 minutes
            const [activeQ, setActiveQ] = React.useState(0);

            // --- QUESTION BANK ---
            const bank = {
                'Physics': [
                    { q: 'Dimension of Universal Gravitational Constant (G) is?', opts: ['M-1 L3 T-2', 'M L2 T-2', 'M L T-2', 'M-1 L2 T-2'], a: 0 },
                    { q: 'A projectile is fired at 45°. The ratio of H to R is?', opts: ['1:2', '1:4', '1:1', '2:1'], a: 1 },
                    { q: 'Kirchhoff’s First Law is based on conservation of?', opts: ['Energy', 'Momentum', 'Charge', 'Mass'], a: 2 }
                ],
                'Math': [
                    { q: 'Value of lim(x->0) (sin x / x) is?', opts: ['0', '1', 'Infinity', 'Undefined'], a: 1 },
                    { q: 'Derivative of log(sin x) is?', opts: ['tan x', 'cot x', 'sec x', 'cosec x'], a: 1 },
                    { q: 'If A is a square matrix, A + A\' is always?', opts: ['Symmetric', 'Skew-Symmetric', 'Identity', 'Null'], a: 0 }
                ]
            };
            
            const currentQuestions = bank[subject] || bank['Physics'];

            // --- TIMER LOGIC ---
            React.useEffect(() => {
                if (screen !== 'test') return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            setScreen('result');
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [screen]);

            const startTest = (sub) => {
                setSubject(sub);
                setAnswers({});
                setTimeLeft(300);
                setActiveQ(0);
                setScreen('test');
            };

            const submit = () => setScreen('result');

            // --- RENDERERS ---
            if (screen === 'menu') return (
                <div className="flex flex-col h-full bg-sg-bg text-white p-8 items-center justify-center">
                    <div className="text-center mb-8">
                        <i className="fas fa-graduation-cap text-6xl text-brand-primary mb-4"></i>
                        <h1 className="text-3xl font-bold">ExamHall</h1>
                        <p className="text-gray-400">Computer Based Test (CBT) Simulation</p>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                        {Object.keys(bank).map(sub => (
                            <button 
                                key={sub}
                                onClick={() => startTest(sub)}
                                className="p-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-left transition-all hover:border-brand-primary group"
                            >
                                <div className="text-lg font-bold group-hover:text-brand-primary">{sub}</div>
                                <div className="text-xs text-gray-500">10 Mins • 20 Marks</div>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (screen === 'result') {
                let score = 0;
                currentQuestions.forEach((q, i) => {
                    if (answers[i] === q.a) score++;
                });
                const percent = (score / currentQuestions.length) * 100;

                return (
                    <div className="flex flex-col h-full bg-sg-bg text-white items-center justify-center p-8">
                        <div className="w-full max-w-md bg-sg-surface border border-white/10 rounded-2xl p-8 text-center shadow-2xl">
                            <div className="w-24 h-24 rounded-full bg-white/5 mx-auto mb-6 flex items-center justify-center text-4xl font-bold" style={{ color: percent >= 70 ? '#10b981' : '#ef4444' }}>
                                {percent}%
                            </div>
                            <h2 className="text-2xl font-bold mb-2">Test Completed</h2>
                            <p className="text-gray-400 mb-6">You scored {score} out of {currentQuestions.length}</p>
                            
                            <div className="space-y-2 mb-8 text-left max-h-48 overflow-y-auto custom-scroll p-2 bg-black/20 rounded">
                                {currentQuestions.map((q, i) => (
                                    <div key={i} className="text-xs border-b border-white/5 pb-2 mb-2">
                                        <div className="mb-1">{i+1}. {q.q}</div>
                                        <div className="flex justify-between">
                                            <span className={answers[i] === q.a ? 'text-green-400' : 'text-red-400'}>
                                                You: {q.opts[answers[i]] || 'Skipped'}
                                            </span>
                                            <span className="text-gray-500">Ans: {q.opts[q.a]}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <button onClick={() => setScreen('menu')} className="px-6 py-2 bg-brand-primary rounded-lg font-bold">Back to Home</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans">
                    {/* Sidebar: Question Palette */}
                    <div className="w-20 md:w-64 bg-sg-surface border-r border-sg-border p-4 flex flex-col">
                        <div className="text-center mb-6">
                            <div className="text-[10px] uppercase text-gray-500 font-bold">Time Left</div>
                            <div className={`text-2xl font-mono font-bold ${timeLeft < 60 ? 'text-red-500 animate-pulse' : 'text-white'}`}>
                                {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                            </div>
                        </div>

                        <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-2 content-start">
                            {currentQuestions.map((_, i) => (
                                <button
                                    key={i}
                                    onClick={() => setActiveQ(i)}
                                    className={`
                                        aspect-square rounded flex items-center justify-center text-sm font-bold border transition-colors
                                        ${activeQ === i ? 'border-brand-primary text-white' : 
                                          answers[i] !== undefined ? 'bg-green-500/20 text-green-500 border-green-500/50' : 
                                          'bg-white/5 text-gray-400 border-transparent'}
                                    `}
                                >
                                    {i + 1}
                                </button>
                            ))}
                        </div>
                        
                        <button onClick={submit} className="mt-4 w-full py-2 bg-green-600 hover:bg-green-500 rounded text-sm font-bold">Submit Test</button>
                    </div>

                    {/* Main Question Area */}
                    <div className="flex-1 p-8 flex flex-col">
                        <div className="flex-1">
                            <div className="text-sm font-bold text-gray-500 uppercase mb-2">Question {activeQ + 1}</div>
                            <h2 className="text-xl md:text-2xl font-bold mb-8 leading-relaxed">
                                {currentQuestions[activeQ].q}
                            </h2>

                            <div className="space-y-3 max-w-2xl">
                                {currentQuestions[activeQ].opts.map((opt, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setAnswers({...answers, [activeQ]: idx})}
                                        className={`
                                            w-full p-4 rounded-xl text-left border transition-all flex items-center gap-3
                                            ${answers[activeQ] === idx ? 'bg-brand-primary/20 border-brand-primary text-white' : 'bg-white/5 border-white/5 hover:bg-white/10'}
                                        `}
                                    >
                                        <div className={`w-6 h-6 rounded-full border flex items-center justify-center text-xs ${answers[activeQ] === idx ? 'border-brand-primary bg-brand-primary' : 'border-gray-500'}`}>
                                            {String.fromCharCode(65 + idx)}
                                        </div>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="flex justify-between pt-6 border-t border-white/10">
                            <button 
                                disabled={activeQ === 0}
                                onClick={() => setActiveQ(activeQ - 1)}
                                className="px-6 py-2 rounded bg-white/5 hover:bg-white/10 disabled:opacity-50"
                            >
                                Previous
                            </button>
                            <button 
                                disabled={activeQ === currentQuestions.length - 1}
                                onClick={() => setActiveQ(activeQ + 1)}
                                className="px-6 py-2 rounded bg-brand-primary hover:bg-blue-600 disabled:opacity-50"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER EXAM APP ---
        APP_REGISTRY.exam = { id: 'exam', title: 'ExamHall', icon: 'fa-file-signature', color: '#8b5cf6', width: 900, height: 700 };
        
        /* PART 32 COMPLETE: EXAMHALL READY */
        // ==================================================================================
        // 33. APP MODULE: STELLAR MAP (Astronomy Lab)
        // ==================================================================================

        const AstroApp = () => {
            const canvasRef = React.useRef(null);
            const [selectedStar, setSelectedStar] = React.useState(null);
            const [zoom, setZoom] = React.useState(1);

            // --- STAR DATA (Simplified Coordinates) ---
            const constellations = [
                {
                    name: 'Orion',
                    lines: [[0,1], [1,2], [1,3], [2,4], [3,5], [4,6], [5,6]], // Connections
                    stars: [
                        { name: 'Betelgeuse', x: 400, y: 300, mag: 0.5, col: '#ff4d4d', type: 'Red Supergiant', dist: '642 ly' },
                        { name: 'Bellatrix', x: 500, y: 280, mag: 1.6, col: '#a3c2ff', type: 'Blue Giant', dist: '250 ly' },
                        { name: 'Alnitak', x: 460, y: 380, mag: 1.7, col: '#a3c2ff', type: 'Blue Supergiant', dist: '1260 ly' },
                        { name: 'Alnilam', x: 450, y: 390, mag: 1.7, col: '#a3c2ff', type: 'Blue Supergiant', dist: '2000 ly' },
                        { name: 'Mintaka', x: 440, y: 400, mag: 2.2, col: '#a3c2ff', type: 'Blue Bright Giant', dist: '1200 ly' },
                        { name: 'Saiph', x: 420, y: 500, mag: 2.0, col: '#a3c2ff', type: 'Blue Supergiant', dist: '650 ly' },
                        { name: 'Rigel', x: 520, y: 520, mag: 0.1, col: '#a3c2ff', type: 'Blue Supergiant', dist: '860 ly' }
                    ]
                },
                {
                    name: 'Ursa Major',
                    lines: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6]],
                    stars: [
                        { name: 'Dubhe', x: 700, y: 150, mag: 1.8, col: '#ffcc00', type: 'Orange Giant', dist: '123 ly' },
                        { name: 'Merak', x: 700, y: 200, mag: 2.3, col: '#fff', type: 'White Main Seq', dist: '79 ly' },
                        { name: 'Phad', x: 650, y: 220, mag: 2.4, col: '#fff', type: 'White Main Seq', dist: '83 ly' },
                        { name: 'Megrez', x: 640, y: 200, mag: 3.3, col: '#fff', type: 'White Main Seq', dist: '58 ly' },
                        { name: 'Alioth', x: 600, y: 180, mag: 1.7, col: '#fff', type: 'White Giant', dist: '82 ly' },
                        { name: 'Mizar', x: 560, y: 170, mag: 2.2, col: '#fff', type: 'White Main Seq', dist: '83 ly' },
                        { name: 'Alkaid', x: 520, y: 150, mag: 1.8, col: '#a3c2ff', type: 'Blue Main Seq', dist: '103 ly' }
                    ]
                }
            ];

            // --- RENDER ENGINE ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // 1. Background (Deep Space)
                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, '#020617'); // Slate 950
                grad.addColorStop(1, '#0f172a'); // Slate 900
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, w, h);

                // 2. Procedural Stars (Background Noise)
                ctx.fillStyle = '#fff';
                for(let i=0; i<300; i++) {
                    const x = Math.random() * w;
                    const y = Math.random() * h;
                    const r = Math.random() * 1.5;
                    const o = Math.random() * 0.8 + 0.2;
                    ctx.globalAlpha = o;
                    ctx.beginPath();
                    ctx.arc(x, y, r, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;

                // 3. Draw Constellations
                ctx.save();
                ctx.translate(w/2, h/2);
                ctx.scale(zoom, zoom);
                ctx.translate(-w/2, -h/2);

                constellations.forEach(constel => {
                    // Lines
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    constel.lines.forEach(([start, end]) => {
                        const s = constel.stars[start];
                        const e = constel.stars[end];
                        ctx.moveTo(s.x, s.y);
                        ctx.lineTo(e.x, e.y);
                    });
                    ctx.stroke();

                    // Stars
                    constel.stars.forEach(star => {
                        // Glow
                        const glow = ctx.createRadialGradient(star.x, star.y, 0, star.x, star.y, 15);
                        glow.addColorStop(0, star.col);
                        glow.addColorStop(1, 'transparent');
                        ctx.fillStyle = glow;
                        ctx.globalAlpha = 0.4;
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, 15, 0, Math.PI*2);
                        ctx.fill();
                        
                        // Core
                        ctx.globalAlpha = 1;
                        ctx.fillStyle = star.col;
                        ctx.beginPath();
                        const r = Math.max(2, 5 - star.mag); // Brighter = Bigger
                        ctx.arc(star.x, star.y, r, 0, Math.PI*2);
                        ctx.fill();

                        // Label (if zoomed)
                        if (zoom > 1.2) {
                            ctx.fillStyle = '#94a3b8';
                            ctx.font = '10px sans-serif';
                            ctx.fillText(star.name, star.x + 8, star.y - 8);
                        }
                    });
                });
                
                ctx.restore();

            }, [zoom]); // Re-render on zoom

            // Handle Interaction
            const handleMouseMove = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const mx = (e.clientX - rect.left - rect.width/2)/zoom + rect.width/2;
                const my = (e.clientY - rect.top - rect.height/2)/zoom + rect.height/2;

                let found = null;
                constellations.forEach(c => {
                    c.stars.forEach(s => {
                        const dist = Math.sqrt((mx-s.x)**2 + (my-s.y)**2);
                        if (dist < 10) found = s;
                    });
                });
                setSelectedStar(found);
            };

            return (
                <div className="flex h-full bg-black text-white font-sans overflow-hidden relative group">
                    
                    {/* --- CANVAS --- */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas 
                            ref={canvasRef} 
                            onMouseMove={handleMouseMove}
                            className="absolute inset-0 w-full h-full" 
                        />
                    </div>

                    {/* --- HUD OVERLAY --- */}
                    <div className="absolute top-4 right-4 bg-black/40 backdrop-blur border border-white/10 rounded-lg p-2 flex flex-col gap-2">
                        <button onClick={() => setZoom(z => Math.min(z + 0.2, 3))} className="p-2 hover:bg-white/10 rounded"><i className="fas fa-plus"></i></button>
                        <button onClick={() => setZoom(z => Math.max(z - 0.2, 0.5))} className="p-2 hover:bg-white/10 rounded"><i className="fas fa-minus"></i></button>
                    </div>

                    <div className="absolute top-4 left-4 text-xs text-gray-500 font-mono pointer-events-none">
                        RA: 05h 55m | Dec: +07° 24'
                    </div>

                    {/* --- INFO CARD (Dynamic) --- */}
                    {selectedStar && (
                        <div className="absolute bottom-6 left-6 bg-sg-surface/90 backdrop-blur-md border-l-4 border-sci-gold p-4 rounded-r-xl shadow-2xl animate-fadeIn w-64">
                            <h2 className="text-xl font-bold text-white mb-1">{selectedStar.name}</h2>
                            <div className="text-xs text-gray-400 mb-3">{selectedStar.type}</div>
                            
                            <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="bg-white/5 p-2 rounded">
                                    <div className="text-gray-500 uppercase font-bold">Distance</div>
                                    <div className="font-mono text-sci-green">{selectedStar.dist}</div>
                                </div>
                                <div className="bg-white/5 p-2 rounded">
                                    <div className="text-gray-500 uppercase font-bold">Magnitude</div>
                                    <div className="font-mono text-sci-gold">{selectedStar.mag}</div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- REGISTER ASTRO APP ---
        APP_REGISTRY.astro = { id: 'astro', title: 'Stellar Map', icon: 'fa-star', color: '#fbbf24', width: 850, height: 650 };
        
        /* PART 33 COMPLETE: STELLAR MAP READY */
        // ==================================================================================
        // 34. APP MODULE: CHEMI CALC (Stoichiometry Engine)
        // ==================================================================================

        const ChemiApp = () => {
            const [formula, setFormula] = React.useState('C6H12O6');
            const [result, setResult] = React.useState(null);

            // --- ATOMIC DATA (Common Elements) ---
            const atomMass = {
                'H': 1.008, 'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81, 'C': 12.011, 'N': 14.007, 'O': 15.999,
                'F': 18.998, 'Ne': 20.180, 'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.085, 'P': 30.974, 'S': 32.06,
                'Cl': 35.45, 'K': 39.098, 'Ca': 40.078, 'Fe': 55.845, 'Cu': 63.546, 'Zn': 65.38, 'Ag': 107.87, 'Au': 196.97
            };

            // --- PARSER ENGINE ---
            const calculateMass = () => {
                let currentFormula = formula.trim();
                if (!currentFormula) return;

                try {
                    // Regex to match Element + Count (e.g., "C6", "H12", "O")
                    // Note: This simple parser handles basic structures. Parentheses logic is complex, 
                    // so for this demo we focus on flat formulas or simple expansions.
                    const regex = /([A-Z][a-z]*)(\d*)/g;
                    let match;
                    let totalMass = 0;
                    let composition = {};
                    let valid = true;

                    while ((match = regex.exec(currentFormula)) !== null) {
                        const element = match[1];
                        const count = match[2] ? parseInt(match[2]) : 1;
                        
                        if (atomMass[element]) {
                            const mass = atomMass[element] * count;
                            totalMass += mass;
                            composition[element] = (composition[element] || 0) + mass;
                        } else {
                            valid = false; // Element not in our mini-db
                        }
                    }

                    if (valid && totalMass > 0) {
                        setResult({ mass: totalMass, comp: composition });
                    } else {
                        setResult({ error: "Invalid element or syntax. Try 'H2O' or 'NaCl'." });
                    }
                } catch (err) {
                    setResult({ error: "Parsing error." });
                }
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden p-8">
                    
                    {/* --- HEADER --- */}
                    <div className="text-center mb-8">
                        <div className="w-16 h-16 bg-white/5 rounded-2xl mx-auto flex items-center justify-center text-3xl text-sci-gold mb-4 border border-sci-gold/30 shadow-glow">
                            <i className="fas fa-flask"></i>
                        </div>
                        <h1 className="text-2xl font-bold font-cyber">Molar Mass Calculator</h1>
                        <p className="text-gray-400 text-sm">Stoichiometry & Composition Analysis</p>
                    </div>

                    {/* --- INPUT --- */}
                    <div className="w-full max-w-md mx-auto mb-8">
                        <div className="flex gap-2">
                            <div className="flex-1 relative">
                                <input 
                                    type="text" 
                                    value={formula}
                                    onChange={e => setFormula(e.target.value)}
                                    placeholder="Enter formula (e.g., H2SO4)"
                                    className="w-full bg-black/30 border border-white/20 rounded-xl py-3 pl-4 pr-12 text-lg font-mono text-white focus:border-sci-gold outline-none transition-all"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500 font-bold">IUPAC</span>
                            </div>
                            <button 
                                onClick={calculateMass}
                                className="bg-sci-gold hover:bg-yellow-500 text-black font-bold px-6 rounded-xl transition-transform active:scale-95"
                            >
                                Calculate
                            </button>
                        </div>
                        <div className="flex gap-2 mt-2 justify-center">
                            {['H2O', 'CO2', 'C6H12O6', 'NaCl', 'H2SO4'].map(f => (
                                <button 
                                    key={f} 
                                    onClick={() => setFormula(f)}
                                    className="text-[10px] px-2 py-1 bg-white/5 rounded border border-white/5 hover:border-white/20 text-gray-400 hover:text-white"
                                >
                                    {f}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* --- RESULTS --- */}
                    {result && (
                        <div className="w-full max-w-md mx-auto animate-fadeIn">
                            {result.error ? (
                                <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-center text-sm font-bold">
                                    <i className="fas fa-triangle-exclamation mr-2"></i> {result.error}
                                </div>
                            ) : (
                                <div className="bg-sg-surface border border-white/10 rounded-xl overflow-hidden">
                                    {/* Main Mass */}
                                    <div className="p-6 text-center border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent">
                                        <div className="text-xs text-gray-400 uppercase font-bold mb-1">Molar Mass</div>
                                        <div className="text-4xl font-mono font-bold text-white">
                                            {result.mass.toFixed(3)} <span className="text-base text-gray-500">g/mol</span>
                                        </div>
                                    </div>

                                    {/* Elemental Breakdown */}
                                    <div className="p-4">
                                        <div className="text-xs font-bold text-gray-500 uppercase mb-3">Composition by Mass</div>
                                        <div className="space-y-3">
                                            {Object.entries(result.comp).map(([el, mass]) => {
                                                const percent = ((mass / result.mass) * 100).toFixed(2);
                                                return (
                                                    <div key={el} className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded bg-white/5 flex items-center justify-center font-bold text-sci-gold border border-white/5">
                                                            {el}
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between text-xs mb-1">
                                                                <span className="text-gray-300">{mass.toFixed(2)} g</span>
                                                                <span className="font-bold text-white">{percent}%</span>
                                                            </div>
                                                            <div className="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                                                                <div 
                                                                    className="h-full bg-sci-gold" 
                                                                    style={{ width: `${percent}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- REGISTER CHEMI APP ---
        APP_REGISTRY.chemi = { id: 'chemi', title: 'ChemiCalc', icon: 'fa-flask-vial', color: '#fbbf24', width: 600, height: 700 };
        
        /* PART 34 COMPLETE: CHEMI CALC READY */
        // ==================================================================================
        // 35. APP MODULE: WAVELAB (Oscillation & Waves)
        // ==================================================================================

        const WaveApp = () => {
            const canvasRef = React.useRef(null);
            const [params, setParams] = React.useState({
                amp: 50,    // Amplitude (px)
                freq: 1,    // Frequency (Hz)
                damp: 0.05, // Damping factor
                mass: 1     // Mass (kg)
            });
            const [isRunning, setIsRunning] = React.useState(true);
            const timeRef = React.useRef(0);

            // --- ANIMATION LOOP ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;

                const render = () => {
                    if (!isRunning) return;

                    const w = canvas.width = canvas.parentElement.clientWidth;
                    const h = canvas.height = canvas.parentElement.clientHeight;
                    const t = timeRef.current;

                    // Physics Calc: Damped Harmonic Motion
                    // x(t) = A * e^(-bt) * cos(wt)
                    const omega = 2 * Math.PI * params.freq;
                    const displacement = params.amp * Math.exp(-params.damp * t) * Math.cos(omega * t);

                    // Clear
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(0, 0, w, h);

                    // --- 1. PHYSICAL VIEW (Left) ---
                    const centerX = w * 0.25;
                    const centerY = h / 2;
                    
                    // Spring
                    ctx.beginPath();
                    ctx.strokeStyle = '#94a3b8';
                    ctx.lineWidth = 2;
                    ctx.moveTo(centerX, 50); // Ceiling
                    
                    // Draw zigzag spring
                    const springLen = centerY + displacement - 50;
                    const segments = 20;
                    for(let i=0; i<=segments; i++) {
                        const xOffset = (i % 2 === 0 ? -10 : 10) * (1 - i/segments); // Tapering
                        ctx.lineTo(centerX + xOffset, 50 + (i/segments)*springLen);
                    }
                    ctx.stroke();

                    // Mass Block
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(centerX - 20, centerY + displacement, 40, 40);
                    
                    // Ceiling Line
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.moveTo(centerX - 40, 50); ctx.lineTo(centerX + 40, 50); ctx.stroke();

                    // --- 2. GRAPH VIEW (Right) ---
                    const graphX = w * 0.5;
                    const graphW = w * 0.45;
                    
                    // Axes
                    ctx.strokeStyle = '#334155';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(graphX, centerY); ctx.lineTo(graphX + graphW, centerY); // Time Axis
                    ctx.moveTo(graphX, centerY - 100); ctx.lineTo(graphX, centerY + 100); // Disp Axis
                    ctx.stroke();

                    // Plot Wave History
                    ctx.beginPath();
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    
                    // We plot t from (now - 5s) to (now)
                    for (let dt = 0; dt < 5; dt += 0.05) {
                        const histT = t - dt;
                        if (histT < 0) break;
                        
                        const histDisp = params.amp * Math.exp(-params.damp * histT) * Math.cos(omega * histT);
                        const plotX = graphX + (dt / 5) * graphW; // Map time to width (reversed for scrolling effect)
                        // Actually, to make it scroll left-to-right like an oscilloscope:
                        // plotX needs to represent `t`. Let's stick to a static window:
                        // We'll plot the function for the last 5 seconds.
                        
                        const screenX = graphX + (dt/5) * graphW; // dt=0 is left? No, let's reverse.
                        // Let's visualize the "trail"
                        
                        // Recalculate for static plotting:
                        // Draw moving dot on graph
                    }
                    
                    // Real-time Dot on Graph
                    // Y-axis corresponds to displacement
                    // X-axis is time. We can just draw a scrolling sine wave.
                    // Simplified for performance: Draw the mathematical function F(t)
                    
                    ctx.beginPath();
                    ctx.strokeStyle = '#f43f5e';
                    for(let px = 0; px < graphW; px++) {
                        // Map px to time offset
                        const dt = (px / graphW) * 2; // Show 2 seconds window
                        const simT = t + dt; 
                        const y = params.amp * Math.exp(-params.damp * simT) * Math.cos(omega * simT);
                        
                        if (px===0) ctx.moveTo(graphX + px, centerY + y);
                        else ctx.lineTo(graphX + px, centerY + y);
                    }
                    ctx.stroke();
                    
                    // Current Indicator
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(graphX, centerY + displacement, 4, 0, Math.PI*2);
                    ctx.fill();

                    // Update Time
                    timeRef.current += 0.016; // Approx 60fps
                    animationId = requestAnimationFrame(render);
                };
                
                render();
                return () => cancelAnimationFrame(animationId);
            }, [isRunning, params]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls Sidebar */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-sci-green flex items-center gap-2">
                            <i className="fas fa-wave-square"></i> WaveLab
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Amplitude (A)</span>
                                    <span>{params.amp} px</span>
                                </div>
                                <input 
                                    type="range" min="10" max="100" 
                                    value={params.amp}
                                    onChange={e => setParams({...params, amp: Number(e.target.value)})}
                                    className="w-full accent-sci-green h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Frequency (f)</span>
                                    <span>{params.freq} Hz</span>
                                </div>
                                <input 
                                    type="range" min="0.1" max="5" step="0.1"
                                    value={params.freq}
                                    onChange={e => setParams({...params, freq: Number(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Damping (b)</span>
                                    <span>{params.damp}</span>
                                </div>
                                <input 
                                    type="range" min="0" max="0.5" step="0.01"
                                    value={params.damp}
                                    onChange={e => setParams({...params, damp: Number(e.target.value)})}
                                    className="w-full accent-red-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        <div className="mt-auto">
                            <button 
                                onClick={() => { setIsRunning(!isRunning); if(!isRunning) timeRef.current = 0; }}
                                className={`w-full py-3 rounded-xl font-bold transition-all ${isRunning ? 'bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white' : 'bg-green-500/20 text-green-500 hover:bg-green-500 hover:text-white'}`}
                            >
                                {isRunning ? 'Stop Simulation' : 'Start Simulation'}
                            </button>
                        </div>
                    </div>

                    {/* Canvas Area */}
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                        
                        {/* Overlay Equation */}
                        <div className="absolute top-4 right-4 bg-black/40 backdrop-blur px-4 py-2 rounded-lg border border-white/10 text-xs font-mono text-sci-green">
                            x(t) = {params.amp}e<sup>-{params.damp}t</sup> cos(2π{params.freq}t)
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER WAVE APP ---
        APP_REGISTRY.wave = { id: 'wave', title: 'WaveLab', icon: 'fa-water', color: '#3b82f6', width: 800, height: 500 };
        
        /* PART 35 COMPLETE: WAVELAB READY */
        // ==================================================================================
        // 36. APP MODULE: CIRCUITSIM (Electronics Lab)
        // ==================================================================================

        const CircuitApp = () => {
            const canvasRef = React.useRef(null);
            const [vals, setVals] = React.useState({
                voltage: 12,   // Volts
                resistance: 10 // Ohms
            });

            // Derived Physics
            const current = vals.voltage / vals.resistance; // I = V/R
            const power = current * vals.voltage;           // P = VI

            // --- RENDER ENGINE ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let frameId;
                let offset = 0;

                const draw = () => {
                    const w = canvas.width = canvas.parentElement.clientWidth;
                    const h = canvas.height = canvas.parentElement.clientHeight;

                    // Clear
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(0, 0, w, h);

                    const cx = w / 2;
                    const cy = h / 2;
                    const size = 150;

                    // Circuit Path (Rectangle)
                    ctx.beginPath();
                    ctx.strokeStyle = '#64748b'; // Wire Color
                    ctx.lineWidth = 4;
                    ctx.rect(cx - size, cy - size, size * 2, size * 2);
                    ctx.stroke();

                    // --- COMPONENT: BATTERY (Left Side) ---
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(cx - size - 10, cy - 20, 20, 40); // Clear wire
                    // Positive Plate
                    ctx.beginPath();
                    ctx.moveTo(cx - size, cy - 15); ctx.lineTo(cx - size, cy + 15);
                    ctx.lineWidth = 4; ctx.strokeStyle = '#f43f5e'; ctx.stroke();
                    // Negative Plate
                    ctx.beginPath();
                    ctx.moveTo(cx - size + 8, cy - 8); ctx.lineTo(cx - size + 8, cy + 8);
                    ctx.lineWidth = 2; ctx.strokeStyle = '#fff'; ctx.stroke();
                    
                    // Label
                    ctx.fillStyle = '#f43f5e';
                    ctx.font = '12px font-mono';
                    ctx.fillText(`${vals.voltage}V`, cx - size - 35, cy);

                    // --- COMPONENT: RESISTOR (Top Side) ---
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(cx - 30, cy - size - 10, 60, 20); // Clear wire
                    // ZigZag
                    ctx.beginPath();
                    ctx.moveTo(cx - 30, cy - size);
                    for(let i=0; i<=6; i++) {
                        ctx.lineTo(cx - 25 + i*10 - 5, cy - size + (i%2===0 ? -10 : 10));
                    }
                    ctx.strokeStyle = power > 50 ? '#ef4444' : '#fbbf24'; // Red if hot
                    ctx.lineWidth = 4;
                    ctx.stroke();

                    // Label
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillText(`${vals.resistance}Ω`, cx - 10, cy - size - 20);

                    // --- ELECTRON FLOW ANIMATION ---
                    // Dots moving along the path
                    ctx.fillStyle = '#3b82f6';
                    const speed = current * 2; // Speed prop to current
                    offset = (offset + speed) % (size * 8); // Perimeter length approx

                    // Draw 8 electrons
                    for(let i=0; i<8; i++) {
                        let pos = (offset + i * (size * 8 / 8)) % (size * 8);
                        let ex, ey;

                        // Map linear position to rectangle coordinates
                        if (pos < size * 2) { // Top edge
                            ex = (cx - size) + pos; ey = cy - size;
                        } else if (pos < size * 4) { // Right edge
                            ex = cx + size; ey = (cy - size) + (pos - size * 2);
                        } else if (pos < size * 6) { // Bottom edge
                            ex = (cx + size) - (pos - size * 4); ey = cy + size;
                        } else { // Left edge
                            ex = cx - size; ey = (cy + size) - (pos - size * 6);
                        }

                        ctx.beginPath();
                        ctx.arc(ex, ey, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    frameId = requestAnimationFrame(draw);
                };
                
                draw();
                return () => cancelAnimationFrame(frameId);
            }, [vals]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-brand-primary flex items-center gap-2">
                            <i className="fas fa-bolt"></i> CircuitSim
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Voltage (V)</span>
                                    <span>{vals.voltage} V</span>
                                </div>
                                <input 
                                    type="range" min="1" max="50" 
                                    value={vals.voltage}
                                    onChange={e => setVals({...vals, voltage: Number(e.target.value)})}
                                    className="w-full accent-red-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Resistance (R)</span>
                                    <span>{vals.resistance} Ω</span>
                                </div>
                                <input 
                                    type="range" min="1" max="100" 
                                    value={vals.resistance}
                                    onChange={e => setVals({...vals, resistance: Number(e.target.value)})}
                                    className="w-full accent-yellow-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        {/* Live Meters */}
                        <div className="mt-auto bg-black/20 rounded-xl p-4 space-y-3">
                            <div className="flex justify-between items-center border-b border-white/5 pb-2">
                                <span className="text-xs text-gray-400 uppercase">Current (I)</span>
                                <span className="text-xl font-mono text-blue-400 font-bold">{current.toFixed(2)} A</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-400 uppercase">Power (P)</span>
                                <span className={`text-xl font-mono font-bold ${power > 50 ? 'text-red-500 animate-pulse' : 'text-green-400'}`}>
                                    {power.toFixed(1)} W
                                </span>
                            </div>
                        </div>
                        {power > 50 && (
                            <div className="text-[10px] text-red-400 text-center font-bold">
                                <i className="fas fa-triangle-exclamation"></i> Warning: High Power Dissipation
                            </div>
                        )}
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER CIRCUIT APP ---
        APP_REGISTRY.circuit = { id: 'circuit', title: 'CircuitSim', icon: 'fa-bolt', color: '#ef4444', width: 700, height: 500 };

        /* PART 36 COMPLETE: CIRCUIT APP READY */
        // ==================================================================================
        // 37. APP MODULE: ORGANIC CANVAS (Chemistry Drawing)
        // ==================================================================================

        const OrganicApp = () => {
            const canvasRef = React.useRef(null);
            const [tool, setTool] = React.useState('bond'); // bond, ring, text
            const [shapes, setShapes] = React.useState([]);
            const [color, setColor] = React.useState('#ffffff');

            // --- RENDERER ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                // Canvas resizing logic is handled by parent, but let's ensure it's synced
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // Background grid (Graph paper style)
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, w, h);
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for(let x=0; x<w; x+=20) { ctx.moveTo(x,0); ctx.lineTo(x,h); }
                for(let y=0; y<h; y+=20) { ctx.moveTo(0,y); ctx.lineTo(w,y); }
                ctx.stroke();

                // Draw Shapes
                shapes.forEach(s => {
                    ctx.strokeStyle = s.col;
                    ctx.fillStyle = s.col;
                    ctx.lineWidth = 2;

                    if (s.type === 'bond') {
                        ctx.beginPath();
                        ctx.moveTo(s.x1, s.y1);
                        ctx.lineTo(s.x2, s.y2);
                        ctx.stroke();
                    } 
                    else if (s.type === 'ring') {
                        // Draw Hexagon
                        ctx.beginPath();
                        for (let i = 0; i < 6; i++) {
                            const angle = (Math.PI / 3) * i;
                            const hx = s.x + 30 * Math.cos(angle);
                            const hy = s.y + 30 * Math.sin(angle);
                            if (i === 0) ctx.moveTo(hx, hy);
                            else ctx.lineTo(hx, hy);
                        }
                        ctx.closePath();
                        ctx.stroke();
                        
                        // Inner circle for Benzene
                        ctx.beginPath();
                        ctx.arc(s.x, s.y, 15, 0, Math.PI*2);
                        ctx.stroke();
                    }
                    else if (s.type === 'text') {
                        ctx.font = '20px sans-serif';
                        ctx.fillText(s.txt, s.x, s.y);
                    }
                });
            }, [shapes]);

            const handleCanvasClick = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (tool === 'ring') {
                    setShapes([...shapes, { type: 'ring', x, y, col: color }]);
                } else if (tool === 'bond') {
                    // Simple logic: If no "start" point exists, set one. If exists, draw line.
                    // For this simple demo, we just draw a fixed bond length to the right
                    // A real sketcher handles drag-and-drop. Let's simulate a click-to-place bond.
                    setShapes([...shapes, { type: 'bond', x1: x, y1: y, x2: x+40, y2: y-20, col: color }]);
                } else if (tool === 'text') {
                    const txt = prompt("Enter Element (C, H, O...)", "C");
                    if (txt) setShapes([...shapes, { type: 'text', x, y, txt, col: color }]);
                }
            };

            const undo = () => setShapes(shapes.slice(0, -1));

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Toolbar */}
                    <div className="w-16 bg-sg-surface border-r border-sg-border flex flex-col items-center py-4 gap-2">
                        {[
                            { id: 'bond', i: 'fa-slash', t: 'Bond' },
                            { id: 'ring', i: 'fa-hexagon', t: 'Benzene' }, // Requires FA Pro or custom icon
                            { id: 'text', i: 'fa-font', t: 'Atom' }
                        ].map(btn => (
                            <button 
                                key={btn.id}
                                onClick={() => setTool(btn.id)}
                                className={`w-10 h-10 rounded flex items-center justify-center transition-all ${tool === btn.id ? 'bg-sci-gold text-black' : 'text-gray-400 hover:bg-white/10'}`}
                                title={btn.t}
                            >
                                <i className={`fas ${btn.i}`}></i>
                            </button>
                        ))}
                        
                        <div className="w-8 h-px bg-white/10 my-2"></div>
                        
                        <input 
                            type="color" 
                            value={color} 
                            onChange={e => setColor(e.target.value)} 
                            className="w-8 h-8 rounded overflow-hidden cursor-pointer"
                        />
                        
                        <button onClick={undo} className="mt-auto mb-4 w-10 h-10 rounded text-gray-400 hover:text-white hover:bg-white/10">
                            <i className="fas fa-rotate-left"></i>
                        </button>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas ref={canvasRef} onClick={handleCanvasClick} className="absolute inset-0 w-full h-full" />
                        <div className="absolute top-2 left-2 text-[10px] text-gray-500 bg-black/20 px-2 rounded pointer-events-none">
                            Click to place {tool}
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER ORGANIC APP ---
        APP_REGISTRY.organic = { id: 'organic', title: 'Organic Canvas', icon: 'fa-bacterium', color: '#10b981', width: 800, height: 600 };
        
        /* PART 37 COMPLETE: ORGANIC CANVAS READY */
        // ==================================================================================
        // 38. APP MODULE: LOGICSIM (Digital Logic Simulator)
        // ==================================================================================

        const LogicApp = () => {
            const canvasRef = React.useRef(null);
            const [components, setComponents] = React.useState([
                { id: 1, type: 'switch', x: 50, y: 100, state: 0 },
                { id: 2, type: 'switch', x: 50, y: 200, state: 0 },
                { id: 3, type: 'and', x: 200, y: 150 },
                { id: 4, type: 'led', x: 350, y: 150, state: 0 }
            ]);
            const [wires, setWires] = React.useState([
                { from: 1, to: 3, port: 0 }, // Switch 1 -> AND Input A
                { from: 2, to: 3, port: 1 }, // Switch 2 -> AND Input B
                { from: 3, to: 4, port: 0 }  // AND Output -> LED
            ]);

            // --- SIMULATION ENGINE ---
            React.useEffect(() => {
                const simulate = () => {
                    let changed = false;
                    const newComps = [...components];

                    // Reset derived states first? No, propagate forward.
                    // Simple propagation loop (max 10 iterations to settle)
                    for(let iter=0; iter<5; iter++) {
                        wires.forEach(w => {
                            const source = newComps.find(c => c.id === w.from);
                            const target = newComps.find(c => c.id === w.to);
                            
                            if (source && target) {
                                // Calculate logic based on gate type
                                let inputVal = source.state;
                                
                                // Store input value on target component temporarily
                                if (!target.inputs) target.inputs = [];
                                target.inputs[w.port] = inputVal;
                            }
                        });

                        // Compute Gate Outputs
                        newComps.forEach(c => {
                            if (c.type === 'switch') return; // Manual control

                            const i0 = c.inputs ? (c.inputs[0] || 0) : 0;
                            const i1 = c.inputs ? (c.inputs[1] || 0) : 0;
                            let out = 0;

                            if (c.type === 'and') out = i0 & i1;
                            if (c.type === 'or') out = i0 | i1;
                            if (c.type === 'not') out = !i0 ? 1 : 0;
                            if (c.type === 'xor') out = i0 ^ i1;
                            if (c.type === 'nand') out = !(i0 & i1) ? 1 : 0;
                            if (c.type === 'led') out = i0; // LED state matches input

                            if (c.state !== out) {
                                c.state = out;
                                changed = true;
                            }
                        });
                    }
                    if (changed) setComponents(newComps);
                };
                simulate();
            }, [components, wires]); // Re-run on topology change

            // --- RENDERER ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // Clear
                ctx.fillStyle = '#1e1e1e';
                ctx.fillRect(0, 0, w, h);

                // Draw Wires
                ctx.lineWidth = 3;
                wires.forEach(wire => {
                    const s = components.find(c => c.id === wire.from);
                    const t = components.find(c => c.id === wire.to);
                    if (s && t) {
                        ctx.strokeStyle = s.state ? '#4ade80' : '#4b5563'; // Green if high
                        ctx.beginPath();
                        ctx.moveTo(s.x + 40, s.y + 20); // Output is right-center
                        ctx.lineTo(t.x, t.y + 20 + (wire.port * 10)); // Input is left-offset
                        ctx.stroke();
                    }
                });

                // Draw Components
                components.forEach(c => {
                    // Body
                    ctx.fillStyle = '#374151';
                    ctx.strokeStyle = c.state ? '#4ade80' : '#9ca3af';
                    ctx.lineWidth = 2;
                    
                    if (c.type === 'switch') {
                        ctx.fillRect(c.x, c.y, 40, 40);
                        ctx.fillStyle = c.state ? '#4ade80' : '#ef4444';
                        ctx.fillRect(c.x + 10, c.y + 10, 20, 20);
                    } 
                    else if (c.type === 'led') {
                        ctx.beginPath();
                        ctx.arc(c.x + 20, c.y + 20, 15, 0, Math.PI*2);
                        ctx.fillStyle = c.state ? '#ef4444' : '#374151';
                        ctx.fill();
                        ctx.stroke();
                        // Glow
                        if (c.state) {
                            ctx.shadowBlur = 20;
                            ctx.shadowColor = '#ef4444';
                            ctx.stroke();
                            ctx.shadowBlur = 0;
                        }
                    }
                    else {
                        // Gates (AND, OR...) - simplified rects with labels for now
                        ctx.fillStyle = '#1f2937';
                        ctx.fillRect(c.x, c.y, 50, 40);
                        ctx.strokeRect(c.x, c.y, 50, 40);
                        ctx.fillStyle = '#fff';
                        ctx.font = '12px sans-serif';
                        ctx.fillText(c.type.toUpperCase(), c.x + 10, c.y + 25);
                    }
                });

            }, [components, wires]);

            const toggleSwitch = (id) => {
                setComponents(components.map(c => 
                    c.id === id ? { ...c, state: c.state ? 0 : 1 } : c
                ));
            };

            const handleCanvasClick = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check clicks on switches
                components.forEach(c => {
                    if (c.type === 'switch' && x >= c.x && x <= c.x+40 && y >= c.y && y <= c.y+40) {
                        toggleSwitch(c.id);
                    }
                });
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    <div className="w-16 bg-sg-surface border-r border-sg-border flex flex-col items-center py-4 gap-2">
                        {['and', 'or', 'not', 'xor'].map(type => (
                            <button 
                                key={type}
                                className="w-10 h-10 rounded bg-white/5 border border-white/10 hover:border-sci-green text-[10px] font-bold uppercase"
                            >
                                {type}
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} onClick={handleCanvasClick} className="absolute inset-0 w-full h-full" />
                        <div className="absolute top-2 left-2 text-xs text-gray-500 pointer-events-none">
                            Click switches to toggle input.
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER LOGIC APP ---
        APP_REGISTRY.logic = { id: 'logic', title: 'LogicSim', icon: 'fa-microchip', color: '#8b5cf6', width: 800, height: 600 };
        
        /* PART 38 COMPLETE: LOGIC SIMULATOR READY */
        // ==================================================================================
        // 39. APP MODULE: VECTORVIS (3D Vectors)
        // ==================================================================================

        const VectorApp = () => {
            const [v1, setV1] = React.useState({ x: 1, y: 2, z: 3 });
            const [v2, setV2] = React.useState({ x: 4, y: -1, z: 2 });
            const plotRef = React.useRef(null);

            // --- CALCULATIONS ---
            const mag1 = Math.sqrt(v1.x**2 + v1.y**2 + v1.z**2);
            const mag2 = Math.sqrt(v2.x**2 + v2.y**2 + v2.z**2);
            const dot = v1.x*v2.x + v1.y*v2.y + v1.z*v2.z;
            const angleRad = Math.acos(dot / (mag1 * mag2));
            const angleDeg = (angleRad * 180 / Math.PI).toFixed(2);
            
            const cross = {
                x: v1.y*v2.z - v1.z*v2.y,
                y: v1.z*v2.x - v1.x*v2.z,
                z: v1.x*v2.y - v1.y*v2.x
            };

            // --- PLOTLY 3D ---
            React.useEffect(() => {
                if (!window.Plotly) return;

                const data = [
                    // Vector A (Blue)
                    {
                        type: 'scatter3d',
                        mode: 'lines+markers',
                        x: [0, v1.x], y: [0, v1.y], z: [0, v1.z],
                        line: { width: 6, color: '#3b82f6' },
                        marker: { size: 4, color: '#3b82f6' },
                        name: 'Vector A'
                    },
                    // Vector B (Red)
                    {
                        type: 'scatter3d',
                        mode: 'lines+markers',
                        x: [0, v2.x], y: [0, v2.y], z: [0, v2.z],
                        line: { width: 6, color: '#ef4444' },
                        marker: { size: 4, color: '#ef4444' },
                        name: 'Vector B'
                    },
                    // Cross Product (Green) - Normal Vector
                    {
                        type: 'scatter3d',
                        mode: 'lines+markers',
                        x: [0, cross.x], y: [0, cross.y], z: [0, cross.z],
                        line: { width: 4, color: '#10b981', dash: 'dash' },
                        marker: { size: 3, color: '#10b981' },
                        name: 'A x B'
                    }
                ];

                const layout = {
                    margin: { t: 0, r: 0, b: 0, l: 0 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    scene: {
                        xaxis: { title: 'X', gridcolor: '#334155', zerolinecolor: '#fff' },
                        yaxis: { title: 'Y', gridcolor: '#334155', zerolinecolor: '#fff' },
                        zaxis: { title: 'Z', gridcolor: '#334155', zerolinecolor: '#fff' },
                        camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
                    },
                    showlegend: false
                };

                Plotly.newPlot(plotRef.current, data, layout, { displayModeBar: false });

            }, [v1, v2]);

            const InputGroup = ({ label, vec, setVec, color }) => (
                <div className="mb-4">
                    <div className="text-xs font-bold mb-2 flex items-center gap-2" style={{ color }}>
                        <i className="fas fa-arrow-right"></i> {label}
                    </div>
                    <div className="flex gap-2">
                        {['x', 'y', 'z'].map(axis => (
                            <div key={axis} className="relative flex-1">
                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-gray-500 uppercase">{axis}</span>
                                <input 
                                    type="number" 
                                    value={vec[axis]} 
                                    onChange={e => setVec({...vec, [axis]: parseFloat(e.target.value) || 0})}
                                    className="w-full bg-black/20 border border-white/10 rounded px-2 py-1 pl-5 text-sm font-mono text-white outline-none focus:border-white/30"
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-4 flex flex-col overflow-y-auto">
                        <InputGroup label="Vector A" vec={v1} setVec={setV1} color="#3b82f6" />
                        <InputGroup label="Vector B" vec={v2} setVec={setV2} color="#ef4444" />
                        
                        <div className="mt-4 pt-4 border-t border-white/10 space-y-3">
                            <div className="text-xs font-bold text-gray-400 uppercase">Results</div>
                            <div className="bg-white/5 p-2 rounded">
                                <div className="text-[10px] text-gray-500">Dot Product (A · B)</div>
                                <div className="font-mono text-lg">{dot}</div>
                            </div>
                            <div className="bg-white/5 p-2 rounded">
                                <div className="text-[10px] text-gray-500">Angle (θ)</div>
                                <div className="font-mono text-lg">{angleDeg}°</div>
                            </div>
                            <div className="bg-white/5 p-2 rounded">
                                <div className="text-[10px] text-gray-500">Cross Product (A × B)</div>
                                <div className="font-mono text-sm text-sci-green">
                                    {cross.x}i {cross.y >= 0 ? '+' : ''}{cross.y}j {cross.z >= 0 ? '+' : ''}{cross.z}k
                                </div>
                            </div>
                            <div className="bg-white/5 p-2 rounded">
                                <div className="text-[10px] text-gray-500">Magnitude |A|</div>
                                <div className="font-mono text-sm">{mag1.toFixed(3)}</div>
                            </div>
                        </div>
                    </div>

                    {/* 3D View */}
                    <div className="flex-1 relative">
                        <div id="vector-plot" ref={plotRef} className="w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER VECTOR APP ---
        APP_REGISTRY.vector = { id: 'vector', title: 'VectorVis', icon: 'fa-arrows-to-dot', color: '#06b6d4', width: 800, height: 600 };
        
        /* PART 39 COMPLETE: VECTOR VISUALIZER READY */
        // ==================================================================================
        // 40. APP MODULE: THERMOSTATE (Thermodynamics Lab)
        // ==================================================================================

        const ThermoApp = () => {
            const plotRef = React.useRef(null);
            const [process, setProcess] = React.useState('isothermal'); // isothermal, adiabatic, isobaric, isochoric
            const [params, setParams] = React.useState({
                p1: 5, v1: 2, v2: 6, gamma: 1.4
            });

            // --- PHYSICS ENGINE ---
            React.useEffect(() => {
                if (!window.Plotly) return;

                const xVals = [];
                const yVals = [];
                const steps = 50;
                let work = 0;

                // Generate path points
                if (process === 'isochoric') {
                    // Vertical line (V is constant)
                    // P changes. Let's assume P2 = P1 * 2 for demo
                    const p2 = params.p1 * 0.5; // Drop pressure
                    xVals.push(params.v1, params.v1);
                    yVals.push(params.p1, p2);
                    work = 0;
                } 
                else if (process === 'isobaric') {
                    // Horizontal line (P is constant)
                    xVals.push(params.v1, params.v2);
                    yVals.push(params.p1, params.p1);
                    work = params.p1 * (params.v2 - params.v1);
                } 
                else {
                    // Curves
                    const stepSize = (params.v2 - params.v1) / steps;
                    for (let i = 0; i <= steps; i++) {
                        const v = params.v1 + i * stepSize;
                        let p = 0;
                        
                        if (process === 'isothermal') {
                            // PV = k => P = P1V1 / V
                            const k = params.p1 * params.v1;
                            p = k / v;
                        } else if (process === 'adiabatic') {
                            // PV^gamma = k => P = P1V1^gamma / V^gamma
                            const k = params.p1 * Math.pow(params.v1, params.gamma);
                            p = k / Math.pow(v, params.gamma);
                        }
                        
                        xVals.push(v);
                        yVals.push(p);
                    }
                    
                    // Work Calculation (Integration)
                    if (process === 'isothermal') {
                        // W = nRT ln(V2/V1) = P1V1 ln(V2/V1)
                        work = params.p1 * params.v1 * Math.log(params.v2 / params.v1);
                    } else if (process === 'adiabatic') {
                        // W = (P1V1 - P2V2) / (gamma - 1)
                        const p2 = yVals[yVals.length - 1];
                        work = (params.p1 * params.v1 - p2 * params.v2) / (params.gamma - 1);
                    }
                }

                const data = [
                    {
                        x: xVals,
                        y: yVals,
                        mode: 'lines',
                        fill: 'tozeroy', // Shade area under curve
                        fillcolor: 'rgba(59, 130, 246, 0.2)',
                        line: { color: '#3b82f6', width: 3 },
                        name: process.charAt(0).toUpperCase() + process.slice(1)
                    },
                    // Markers for Initial and Final states
                    {
                        x: [xVals[0], xVals[xVals.length-1]],
                        y: [yVals[0], yVals[yVals.length-1]],
                        mode: 'markers+text',
                        text: ['Initial (P1, V1)', 'Final (P2, V2)'],
                        textposition: 'top right',
                        marker: { size: 8, color: '#ef4444' }
                    }
                ];

                const layout = {
                    title: { text: 'P-V Diagram', font: { color: '#fff' } },
                    margin: { t: 40, r: 20, b: 40, l: 50 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    xaxis: { title: 'Volume (m³)', gridcolor: '#334155', color: '#94a3b8' },
                    yaxis: { title: 'Pressure (Pa)', gridcolor: '#334155', color: '#94a3b8' },
                    showlegend: false,
                    annotations: [{
                        x: (params.v1 + params.v2) / 2,
                        y: Math.max(...yVals) * 1.1,
                        text: `Work Done: ${work.toFixed(2)} J`,
                        showarrow: false,
                        font: { color: '#10b981', size: 14 }
                    }]
                };

                Plotly.newPlot(plotRef.current, data, layout, { displayModeBar: false });

            }, [process, params]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-orange-500 flex items-center gap-2">
                            <i className="fas fa-fire"></i> ThermoState
                        </h2>

                        <div className="grid grid-cols-2 gap-2">
                            {['isothermal', 'adiabatic', 'isobaric', 'isochoric'].map(p => (
                                <button
                                    key={p}
                                    onClick={() => setProcess(p)}
                                    className={`
                                        p-2 rounded text-[10px] font-bold uppercase transition-all
                                        ${process === p ? 'bg-orange-500 text-black' : 'bg-white/5 text-gray-400 hover:bg-white/10'}
                                    `}
                                >
                                    {p}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Initial Pressure (P1)</span>
                                    <span>{params.p1} Pa</span>
                                </div>
                                <input 
                                    type="range" min="1" max="20" 
                                    value={params.p1}
                                    onChange={e => setParams({...params, p1: Number(e.target.value)})}
                                    className="w-full accent-orange-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Initial Volume (V1)</span>
                                    <span>{params.v1} m³</span>
                                </div>
                                <input 
                                    type="range" min="1" max="10" 
                                    value={params.v1}
                                    onChange={e => setParams({...params, v1: Number(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Final Volume (V2)</span>
                                    <span>{params.v2} m³</span>
                                </div>
                                <input 
                                    type="range" min="1" max="20" 
                                    value={params.v2}
                                    onChange={e => setParams({...params, v2: Number(e.target.value)})}
                                    className="w-full accent-green-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            {process === 'adiabatic' && (
                                <div>
                                    <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                        <span>Adiabatic Index (γ)</span>
                                        <span>{params.gamma}</span>
                                    </div>
                                    <input 
                                        type="range" min="1.1" max="1.67" step="0.01"
                                        value={params.gamma}
                                        onChange={e => setParams({...params, gamma: Number(e.target.value)})}
                                        className="w-full accent-purple-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                    />
                                    <div className="text-[10px] text-gray-500 mt-1">
                                        γ=1.4 (Diatomic), γ=1.67 (Monoatomic)
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Graph Area */}
                    <div className="flex-1 relative">
                        <div ref={plotRef} className="absolute inset-0 w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER THERMO APP ---
        APP_REGISTRY.thermo = { id: 'thermo', title: 'ThermoState', icon: 'fa-fire-burner', color: '#f97316', width: 800, height: 600 };
        
        /* PART 40 COMPLETE: THERMO APP READY */
        // ==================================================================================
        // 41. APP MODULE: MATRIX MASTER (Linear Algebra)
        // ==================================================================================

        const MatrixApp = () => {
            const [matA, setMatA] = React.useState([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);
            const [matB, setMatB] = React.useState([[1, 0, 0], [0, 1, 0], [0, 0, 1]]);
            const [result, setResult] = React.useState(null);
            const [op, setOp] = React.useState('');

            const handleChange = (mat, setMat, r, c, val) => {
                const newMat = [...mat];
                newMat[r][c] = parseFloat(val) || 0;
                setMat(newMat);
            };

            const calculate = (operation) => {
                setOp(operation);
                try {
                    let res;
                    const A = math.matrix(matA);
                    const B = math.matrix(matB);

                    switch(operation) {
                        case 'detA': 
                            res = math.det(A); 
                            break;
                        case 'invA': 
                            res = math.inv(A); 
                            break;
                        case 'transA': 
                            res = math.transpose(A); 
                            break;
                        case 'add': 
                            res = math.add(A, B); 
                            break;
                        case 'mul': 
                            res = math.multiply(A, B); 
                            break;
                        default: res = null;
                    }
                    
                    // Format Result
                    if (res && res.toArray) setResult(res.toArray()); // Matrix
                    else setResult(res); // Scalar (Determinant)

                } catch (err) {
                    setResult("Error: Singular Matrix or Invalid Op");
                }
            };

            const MatrixGrid = ({ data, setData, label, color }) => (
                <div className="bg-sg-surface p-4 rounded-xl border border-white/10">
                    <div className="text-xs font-bold mb-2 flex justify-between" style={{ color }}>
                        <span>{label}</span>
                        <span className="opacity-50">[3x3]</span>
                    </div>
                    <div className="grid grid-cols-3 gap-1">
                        {data.map((row, r) => (
                            row.map((val, c) => (
                                <input
                                    key={`${r}-${c}`}
                                    type="number"
                                    value={val}
                                    onChange={(e) => handleChange(data, setData, r, c, e.target.value)}
                                    className="w-full bg-black/30 border border-white/5 rounded p-2 text-center text-sm font-mono text-white outline-none focus:border-white/30"
                                />
                            ))
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans p-6 overflow-y-auto custom-scroll">
                    
                    {/* Header */}
                    <div className="flex items-center gap-4 mb-6">
                        <div className="w-12 h-12 bg-indigo-500/20 rounded-lg flex items-center justify-center text-2xl text-indigo-400 border border-indigo-500/30">
                            <i className="fas fa-table-cells"></i>
                        </div>
                        <h1 className="text-2xl font-bold font-math">Matrix Master</h1>
                    </div>

                    {/* Input Area */}
                    <div className="flex flex-col md:flex-row gap-6 mb-6">
                        <div className="flex-1"><MatrixGrid data={matA} setData={setMatA} label="Matrix A" color="#3b82f6" /></div>
                        
                        {/* Operations Toolbar */}
                        <div className="flex flex-col justify-center gap-2">
                            <button onClick={() => calculate('add')} className="w-10 h-10 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center" title="A + B"><i className="fas fa-plus"></i></button>
                            <button onClick={() => calculate('mul')} className="w-10 h-10 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center" title="A × B"><i className="fas fa-xmark"></i></button>
                            <button onClick={() => calculate('detA')} className="w-10 h-10 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center text-xs font-bold" title="Determinant A">|A|</button>
                            <button onClick={() => calculate('invA')} className="w-10 h-10 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center text-xs font-bold" title="Inverse A">A⁻¹</button>
                            <button onClick={() => calculate('transA')} className="w-10 h-10 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center text-xs font-bold" title="Transpose A">Aᵀ</button>
                        </div>

                        <div className="flex-1"><MatrixGrid data={matB} setData={setMatB} label="Matrix B" color="#ef4444" /></div>
                    </div>

                    {/* Result Area */}
                    {result !== null && (
                        <div className="animate-slideUp">
                            <h2 className="text-sm font-bold text-gray-500 uppercase mb-2">Result: {op}</h2>
                            <div className="bg-black/30 border border-white/10 rounded-xl p-6 flex justify-center">
                                {typeof result === 'object' ? (
                                    <div className="grid grid-cols-3 gap-2">
                                        {result.map((row, r) => (
                                            row.map((val, c) => (
                                                <div key={`${r}-${c}`} className="w-16 h-12 flex items-center justify-center font-mono text-lg text-sci-green bg-white/5 rounded">
                                                    {Number(val).toFixed(2)}
                                                </div>
                                            ))
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-3xl font-mono text-sci-gold">{result}</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- REGISTER MATRIX APP ---
        APP_REGISTRY.matrix = { id: 'matrix', title: 'Matrix Master', icon: 'fa-table-cells', color: '#6366f1', width: 750, height: 600 };
        
        /* PART 41 COMPLETE: MATRIX APP READY */
        // ==================================================================================
        // 42. APP MODULE: TRIGWHEEL (Unit Circle Visualizer)
        // ==================================================================================

        const TrigApp = () => {
            const canvasRef = React.useRef(null);
            const [angle, setAngle] = React.useState(45); // Degrees
            const [isDragging, setIsDragging] = React.useState(false);

            // --- MATH HELPERS ---
            const rad = angle * (Math.PI / 180);
            const sin = Math.sin(rad);
            const cos = Math.cos(rad);
            const tan = Math.tan(rad);

            // Exact value formatter
            const formatVal = (v) => {
                const eps = 0.01;
                if (Math.abs(v) < eps) return "0";
                if (Math.abs(v - 0.5) < eps) return "1/2";
                if (Math.abs(v + 0.5) < eps) return "-1/2";
                if (Math.abs(v - Math.sqrt(2)/2) < eps) return "√2/2";
                if (Math.abs(v + Math.sqrt(2)/2) < eps) return "-√2/2";
                if (Math.abs(v - Math.sqrt(3)/2) < eps) return "√3/2";
                if (Math.abs(v + Math.sqrt(3)/2) < eps) return "-√3/2";
                if (Math.abs(v - 1) < eps) return "1";
                if (Math.abs(v + 1) < eps) return "-1";
                return v.toFixed(3);
            };

            // --- RENDERER ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;
                const cx = w / 2;
                const cy = h / 2;
                const r = Math.min(w, h) * 0.35; // Radius

                // Clear
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke(); // Y-axis
                ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke(); // X-axis

                // Unit Circle
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.stroke();

                // Angle Line (Hypotenuse)
                const px = cx + cos * r;
                const py = cy - sin * r; // Canvas Y is inverted
                
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, py); ctx.stroke();

                // Cosine (Blue Horizontal)
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, cy); ctx.stroke();

                // Sine (Red Vertical)
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(px, cy); ctx.lineTo(px, py); ctx.stroke();

                // Tangent (Orange Tangent Line)
                // Draw line perpendicular to radius at point P, intersecting X-axis
                if (Math.abs(cos) > 0.01) {
                    ctx.strokeStyle = '#f97316';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    const tanLen = tan * r;
                    // Point on circle is (px, py). Vector is (cos, -sin). Normal is (sin, cos).
                    // This is complex to draw perfectly clipped. Simplified visualization:
                    // Draw vertical line at x=1 (or x=-1) up to the extended radius
                    const tanX = cos >= 0 ? cx + r : cx - r;
                    const tanY = cy - tan * r * (cos >= 0 ? 1 : -1); 
                    // ctx.beginPath(); ctx.moveTo(tanX, cy); ctx.lineTo(tanX, tanY); ctx.stroke();
                    // Let's stick to the visual triangle components for clarity
                }
                ctx.setLineDash([]);

                // Point Marker
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI * 2); ctx.fill();

                // Angle Arc
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.arc(cx, cy, 30, 0, -rad, true); // Counter-clockwise for canvas
                ctx.stroke();

            }, [angle]);

            // Interaction
            const handleInteract = (e) => {
                if (!isDragging && e.type !== 'click') return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width/2;
                const y = e.clientY - rect.top - rect.height/2;
                
                // Atan2 gives angle in radians
                let th = Math.atan2(-y, x) * (180 / Math.PI); // Invert Y
                if (th < 0) th += 360;
                
                // Snap to common angles
                [0, 30, 45, 60, 90, 120, 135, 150, 180, 270].forEach(snap => {
                    if (Math.abs(th - snap) < 5) th = snap;
                });

                setAngle(th);
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-sci-purple flex items-center gap-2">
                            <i className="fas fa-circle-notch"></i> TrigWheel
                        </h2>

                        <div className="bg-white/5 rounded-xl p-4 text-center">
                            <div className="text-xs text-gray-500 uppercase font-bold mb-1">Angle (θ)</div>
                            <div className="text-4xl font-mono font-bold text-white">{Math.round(angle)}°</div>
                            <div className="text-xs text-gray-400 mt-1">{(rad/Math.PI).toFixed(2)}π rad</div>
                        </div>

                        <div className="space-y-3">
                            <div className="flex items-center justify-between p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                <span className="text-blue-400 font-bold">cos(θ)</span>
                                <span className="font-mono text-xl">{formatVal(cos)}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                <span className="text-red-400 font-bold">sin(θ)</span>
                                <span className="font-mono text-xl">{formatVal(sin)}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                <span className="text-orange-400 font-bold">tan(θ)</span>
                                <span className="font-mono text-xl">{Math.abs(tan) > 100 ? '∞' : formatVal(tan)}</span>
                            </div>
                        </div>

                        <div className="mt-auto text-xs text-gray-500 text-center">
                            Drag the point on the circle to change the angle.
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas 
                            ref={canvasRef} 
                            onMouseDown={() => setIsDragging(true)}
                            onMouseUp={() => setIsDragging(false)}
                            onMouseLeave={() => setIsDragging(false)}
                            onMouseMove={handleInteract}
                            onClick={handleInteract}
                            className="absolute inset-0 w-full h-full" 
                        />
                    </div>
                </div>
            );
        };

        // --- REGISTER TRIG APP ---
        APP_REGISTRY.trig = { id: 'trig', title: 'TrigWheel', icon: 'fa-circle-notch', color: '#a855f7', width: 750, height: 600 };
        
        /* PART 42 COMPLETE: TRIGWHEEL READY */
        // ==================================================================================
        // 42. APP MODULE: TRIGWHEEL (Unit Circle Visualizer)
        // ==================================================================================

        const TrigApp = () => {
            const canvasRef = React.useRef(null);
            const [angle, setAngle] = React.useState(45); // Degrees
            const [isDragging, setIsDragging] = React.useState(false);

            // --- MATH HELPERS ---
            const rad = angle * (Math.PI / 180);
            const sin = Math.sin(rad);
            const cos = Math.cos(rad);
            const tan = Math.tan(rad);

            // Exact value formatter
            const formatVal = (v) => {
                const eps = 0.01;
                if (Math.abs(v) < eps) return "0";
                if (Math.abs(v - 0.5) < eps) return "1/2";
                if (Math.abs(v + 0.5) < eps) return "-1/2";
                if (Math.abs(v - Math.sqrt(2)/2) < eps) return "√2/2";
                if (Math.abs(v + Math.sqrt(2)/2) < eps) return "-√2/2";
                if (Math.abs(v - Math.sqrt(3)/2) < eps) return "√3/2";
                if (Math.abs(v + Math.sqrt(3)/2) < eps) return "-√3/2";
                if (Math.abs(v - 1) < eps) return "1";
                if (Math.abs(v + 1) < eps) return "-1";
                return v.toFixed(3);
            };

            // --- RENDERER ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;
                const cx = w / 2;
                const cy = h / 2;
                const r = Math.min(w, h) * 0.35; // Radius

                // Clear
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke(); // Y-axis
                ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke(); // X-axis

                // Unit Circle
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.stroke();

                // Angle Line (Hypotenuse)
                const px = cx + cos * r;
                const py = cy - sin * r; // Canvas Y is inverted
                
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, py); ctx.stroke();

                // Cosine (Blue Horizontal)
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, cy); ctx.stroke();

                // Sine (Red Vertical)
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(px, cy); ctx.lineTo(px, py); ctx.stroke();

                // Tangent (Orange Tangent Line)
                // Draw line perpendicular to radius at point P, intersecting X-axis
                if (Math.abs(cos) > 0.01) {
                    ctx.strokeStyle = '#f97316';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    const tanLen = tan * r;
                    // Point on circle is (px, py). Vector is (cos, -sin). Normal is (sin, cos).
                    // This is complex to draw perfectly clipped. Simplified visualization:
                    // Draw vertical line at x=1 (or x=-1) up to the extended radius
                    const tanX = cos >= 0 ? cx + r : cx - r;
                    const tanY = cy - tan * r * (cos >= 0 ? 1 : -1); 
                    // ctx.beginPath(); ctx.moveTo(tanX, cy); ctx.lineTo(tanX, tanY); ctx.stroke();
                    // Let's stick to the visual triangle components for clarity
                }
                ctx.setLineDash([]);

                // Point Marker
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI * 2); ctx.fill();

                // Angle Arc
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.arc(cx, cy, 30, 0, -rad, true); // Counter-clockwise for canvas
                ctx.stroke();

            }, [angle]);

            // Interaction
            const handleInteract = (e) => {
                if (!isDragging && e.type !== 'click') return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width/2;
                const y = e.clientY - rect.top - rect.height/2;
                
                // Atan2 gives angle in radians
                let th = Math.atan2(-y, x) * (180 / Math.PI); // Invert Y
                if (th < 0) th += 360;
                
                // Snap to common angles
                [0, 30, 45, 60, 90, 120, 135, 150, 180, 270].forEach(snap => {
                    if (Math.abs(th - snap) < 5) th = snap;
                });

                setAngle(th);
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-sci-purple flex items-center gap-2">
                            <i className="fas fa-circle-notch"></i> TrigWheel
                        </h2>

                        <div className="bg-white/5 rounded-xl p-4 text-center">
                            <div className="text-xs text-gray-500 uppercase font-bold mb-1">Angle (θ)</div>
                            <div className="text-4xl font-mono font-bold text-white">{Math.round(angle)}°</div>
                            <div className="text-xs text-gray-400 mt-1">{(rad/Math.PI).toFixed(2)}π rad</div>
                        </div>

                        <div className="space-y-3">
                            <div className="flex items-center justify-between p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                <span className="text-blue-400 font-bold">cos(θ)</span>
                                <span className="font-mono text-xl">{formatVal(cos)}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                <span className="text-red-400 font-bold">sin(θ)</span>
                                <span className="font-mono text-xl">{formatVal(sin)}</span>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                <span className="text-orange-400 font-bold">tan(θ)</span>
                                <span className="font-mono text-xl">{Math.abs(tan) > 100 ? '∞' : formatVal(tan)}</span>
                            </div>
                        </div>

                        <div className="mt-auto text-xs text-gray-500 text-center">
                            Drag the point on the circle to change the angle.
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas 
                            ref={canvasRef} 
                            onMouseDown={() => setIsDragging(true)}
                            onMouseUp={() => setIsDragging(false)}
                            onMouseLeave={() => setIsDragging(false)}
                            onMouseMove={handleInteract}
                            onClick={handleInteract}
                            className="absolute inset-0 w-full h-full" 
                        />
                    </div>
                </div>
            );
        };

        // --- REGISTER TRIG APP ---
        APP_REGISTRY.trig = { id: 'trig', title: 'TrigWheel', icon: 'fa-circle-notch', color: '#a855f7', width: 750, height: 600 };
        
        /* PART 42 COMPLETE: TRIGWHEEL READY */
        // ==================================================================================
        // 43. APP MODULE: PROJECTILESIM (Kinematics Lab)
        // ==================================================================================

        const ProjectileApp = () => {
            const canvasRef = React.useRef(null);
            const [params, setParams] = React.useState({ v0: 50, theta: 45, g: 9.8 });
            const [animating, setAnimating] = React.useState(false);

            // --- CALCULATIONS ---
            const rad = params.theta * (Math.PI / 180);
            const R = (Math.pow(params.v0, 2) * Math.sin(2 * rad)) / params.g;
            const H = (Math.pow(params.v0, 2) * Math.pow(Math.sin(rad), 2)) / (2 * params.g);
            const T = (2 * params.v0 * Math.sin(rad)) / params.g;

            // --- ANIMATION ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let startT = null;
                let frameId;

                const draw = (timestamp) => {
                    const w = canvas.width = canvas.parentElement.clientWidth;
                    const h = canvas.height = canvas.parentElement.clientHeight;
                    
                    // Scaling: Map Range to Canvas Width (keep margins)
                    // Let's say max range approx 300m fits in 80% width
                    const scale = (w * 0.8) / 300; 
                    const groundY = h - 50;
                    const startX = 50;

                    // Clear
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(0, 0, w, h);

                    // Ground
                    ctx.fillStyle = '#10b981';
                    ctx.fillRect(0, groundY, w, 50);

                    // Cannon
                    ctx.save();
                    ctx.translate(startX, groundY);
                    ctx.rotate(-rad);
                    ctx.fillStyle = '#64748b';
                    ctx.fillRect(0, -10, 40, 20); // Barrel
                    ctx.restore();

                    // Trajectory Path (Dotted)
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(startX, groundY);
                    
                    for(let t=0; t<=T; t+=0.1) {
                        const x = params.v0 * Math.cos(rad) * t;
                        const y = params.v0 * Math.sin(rad) * t - 0.5 * params.g * t*t;
                        ctx.lineTo(startX + x * scale, groundY - y * scale);
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Animation Ball
                    if (animating) {
                        if (!startT) startT = timestamp;
                        const elapsed = (timestamp - startT) / 1000 * 5; // 5x Speed
                        
                        if (elapsed <= T) {
                            const curX = params.v0 * Math.cos(rad) * elapsed;
                            const curY = params.v0 * Math.sin(rad) * elapsed - 0.5 * params.g * elapsed*elapsed;
                            
                            ctx.fillStyle = '#f43f5e';
                            ctx.beginPath();
                            ctx.arc(startX + curX * scale, groundY - curY * scale, 8, 0, Math.PI*2);
                            ctx.fill();
                            frameId = requestAnimationFrame(draw);
                        } else {
                            setAnimating(false);
                            draw(timestamp); // Final state
                        }
                    } else {
                        // Resting state (or end)
                        // Just show start pos
                    }
                };

                if (animating) {
                    frameId = requestAnimationFrame(draw);
                } else {
                    draw(performance.now());
                }

                return () => cancelAnimationFrame(frameId);
            }, [animating, params]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-red-500 flex items-center gap-2">
                            <i className="fas fa-meteor"></i> Projectile
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Velocity (v0)</span>
                                    <span>{params.v0} m/s</span>
                                </div>
                                <input 
                                    type="range" min="10" max="100" 
                                    value={params.v0}
                                    onChange={e => setParams({...params, v0: Number(e.target.value)})}
                                    className="w-full accent-red-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Angle (θ)</span>
                                    <span>{params.theta}°</span>
                                </div>
                                <input 
                                    type="range" min="0" max="90" 
                                    value={params.theta}
                                    onChange={e => setParams({...params, theta: Number(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        <button 
                            onClick={() => setAnimating(true)}
                            className="w-full py-3 bg-red-500 hover:bg-red-600 rounded-xl font-bold transition-all shadow-glow"
                        >
                            <i className="fas fa-play mr-2"></i> Fire
                        </button>

                        <div className="mt-auto bg-black/20 rounded-xl p-4 space-y-2 text-xs">
                            <div className="flex justify-between">
                                <span className="text-gray-400">Max Height (H)</span>
                                <span className="font-mono text-sci-gold">{H.toFixed(2)} m</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Range (R)</span>
                                <span className="font-mono text-sci-green">{R.toFixed(2)} m</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Flight Time (T)</span>
                                <span className="font-mono text-white">{T.toFixed(2)} s</span>
                            </div>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER PROJECTILE APP ---
        APP_REGISTRY.proj = { id: 'proj', title: 'ProjectileSim', icon: 'fa-meteor', color: '#f43f5e', width: 800, height: 600 };
        
        /* PART 43 COMPLETE: PROJECTILE SIM READY */
        // ==================================================================================
        // 44. APP MODULE: DICTIONARY (Lexicon)
        // ==================================================================================

        const DictApp = () => {
            const [search, setSearch] = React.useState('');
            
            const db = [
                { w: 'Acceleration', d: 'The rate of change of velocity of an object with respect to time.' },
                { w: 'Algorithm', d: 'A process or set of rules to be followed in calculations or other problem-solving operations.' },
                { w: 'Atom', d: 'The smallest particle of a chemical element that can exist.' },
                { w: 'Calculus', d: 'The mathematical study of continuous change.' },
                { w: 'Derivative', d: 'A measure of how a function changes as its input changes.' },
                { w: 'Electron', d: 'A stable subatomic particle with a charge of negative electricity.' },
                { w: 'Force', d: 'An interaction that will change the motion of an object.' },
                { w: 'Gravity', d: 'The force that attracts a body toward the center of the earth.' },
                { w: 'Hypothesis', d: 'A supposition or proposed explanation made on the basis of limited evidence.' },
                { w: 'Integral', d: 'Assigns numbers to functions in a way that describes displacement, area, volume.' },
                { w: 'Isotope', d: 'Each of two or more forms of the same element that contain equal numbers of protons but different numbers of neutrons.' },
                { w: 'Kinetic Energy', d: 'Energy which a body possesses by virtue of being in motion.' },
                { w: 'Logarithm', d: 'The exponent to which a fixed number, the base, must be raised to produce a given number.' },
                { w: 'Matrix', d: 'A rectangular array or table of numbers, symbols, or expressions.' },
                { w: 'Mitosis', d: 'A type of cell division that results in two daughter cells each having the same number and kind of chromosomes.' },
                { w: 'Mole', d: 'The SI unit of material quantity, equal to 6.022 x 10^23 particles.' },
                { w: 'Momentum', d: 'The quantity of motion of a moving body, measured as a product of its mass and velocity.' },
                { w: 'Nucleus', d: 'The central and most important part of an object, movement, or group.' },
                { w: 'Oscillation', d: 'Movement back and forth at a regular speed.' },
                { w: 'Photon', d: 'A particle representing a quantum of light or other electromagnetic radiation.' },
                { w: 'Quantum', d: 'A discrete quantity of energy proportional in magnitude to the frequency of the radiation it represents.' },
                { w: 'Resistor', d: 'A device having a designed resistance to the passage of an electric current.' },
                { w: 'Stoichiometry', d: 'The relationship between the relative quantities of substances taking part in a reaction.' },
                { w: 'Vector', d: 'A quantity having direction as well as magnitude.' },
                { w: 'Velocity', d: 'The speed of something in a given direction.' }
            ];

            const filtered = db.filter(item => item.w.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans p-6 overflow-hidden">
                    <div className="text-center mb-6">
                        <i className="fas fa-book text-4xl text-gray-400 mb-2"></i>
                        <h1 className="text-2xl font-bold font-serif">Lexicon</h1>
                        <p className="text-xs text-gray-500">Academic Reference</p>
                    </div>

                    <div className="relative mb-6">
                        <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                        <input 
                            type="text" 
                            value={search}
                            onChange={e => setSearch(e.target.value)}
                            placeholder="Define a term..."
                            className="w-full bg-sg-surface border border-white/10 rounded-full py-3 pl-10 pr-4 text-white outline-none focus:border-white/30"
                        />
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scroll space-y-3">
                        {filtered.map((item, i) => (
                            <div key={i} className="bg-white/5 border border-white/5 rounded-xl p-4 hover:border-white/20 transition-colors">
                                <h2 className="text-lg font-bold text-sci-gold mb-1 font-serif">{item.w}</h2>
                                <p className="text-sm text-gray-300 leading-relaxed">{item.d}</p>
                            </div>
                        ))}
                        {filtered.length === 0 && (
                            <div className="text-center text-gray-500 mt-10">
                                No definitions found for "{search}".
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- REGISTER DICT APP ---
        APP_REGISTRY.dict = { id: 'dict', title: 'Dictionary', icon: 'fa-book', color: '#94a3b8', width: 500, height: 600 };
        
        /* PART 44 COMPLETE: DICTIONARY READY */
        // ==================================================================================
        // 45. APP MODULE: CALCVISUAL (Riemann Integration)
        // ==================================================================================

        const CalculusApp = () => {
            const canvasRef = React.useRef(null);
            const [funcStr, setFuncStr] = React.useState('x^2');
            const [bounds, setBounds] = React.useState({ a: 0, b: 4, n: 10 });
            const [mode, setMode] = React.useState('left'); // left, right, mid
            const [stats, setStats] = React.useState({ approx: 0, exact: 0, error: 0 });

            // --- ENGINE ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // 1. Parse Function
                let expr;
                try { expr = math.compile(funcStr); } catch(e) { return; }

                // 2. Setup Scale
                // We need to map [a-1, b+1] to width and [minY, maxY] to height
                // For simplicity, let's fix the view to a slightly larger window than [a,b]
                const xMin = parseFloat(bounds.a) - 1;
                const xMax = parseFloat(bounds.b) + 1;
                const xRange = xMax - xMin;

                // Find Y range
                let yMin = 0, yMax = 0;
                for(let i=0; i<=100; i++) {
                    const x = xMin + (i/100)*xRange;
                    try {
                        const y = expr.evaluate({x});
                        if (y < yMin) yMin = y;
                        if (y > yMax) yMax = y;
                    } catch(e) {}
                }
                if (yMax === 0) yMax = 10;
                yMax *= 1.2; // Padding
                const yRange = yMax - yMin;

                // Transform Helpers
                const toX = (val) => ((val - xMin) / xRange) * w;
                const toY = (val) => h - ((val - yMin) / yRange) * h;

                // Clear
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, w, h);

                // Grid
                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 1;
                ctx.beginPath();
                // X-Axis (y=0)
                const y0 = toY(0);
                if (y0 >= 0 && y0 <= h) { ctx.moveTo(0, y0); ctx.lineTo(w, y0); }
                // Y-Axis (x=0)
                const x0 = toX(0);
                if (x0 >= 0 && x0 <= w) { ctx.moveTo(x0, 0); ctx.lineTo(x0, h); }
                ctx.stroke();

                // 3. Draw Rectangles (Riemann Sum)
                const dx = (bounds.b - bounds.a) / bounds.n;
                let sumArea = 0;

                ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 1;

                for(let i=0; i<bounds.n; i++) {
                    let xVal;
                    if (mode === 'left') xVal = parseFloat(bounds.a) + i*dx;
                    else if (mode === 'right') xVal = parseFloat(bounds.a) + (i+1)*dx;
                    else xVal = parseFloat(bounds.a) + (i+0.5)*dx;

                    let height;
                    try { height = expr.evaluate({x: xVal}); } catch(e) { height = 0; }
                    
                    sumArea += height * dx;

                    // Draw Rect
                    const rx = toX(parseFloat(bounds.a) + i*dx);
                    const ry = toY(height); // Top Y
                    const rBase = toY(0);   // Bottom Y
                    const rw = toX(parseFloat(bounds.a) + (i+1)*dx) - rx;
                    
                    ctx.beginPath();
                    ctx.rect(rx, ry, rw, rBase - ry);
                    ctx.fill();
                    ctx.stroke();
                }

                // 4. Draw Function Curve
                ctx.strokeStyle = '#f43f5e';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for(let i=0; i<=w; i+=2) {
                    const simX = xMin + (i/w)*xRange;
                    try {
                        const simY = expr.evaluate({x: simX});
                        const plotY = toY(simY);
                        if (i===0) ctx.moveTo(i, plotY);
                        else ctx.lineTo(i, plotY);
                    } catch(e) {}
                }
                ctx.stroke();

                // 5. Calculate Exact (Algebrite)
                let exact = 0;
                try {
                    // Algebrite integral: defint(func, x, a, b)
                    // Note: Algebrite might be slow for complex numerical evaluation, 
                    // so we simulate exact using Simpson's Rule with high N for this demo
                    const N = 1000;
                    const h_sim = (bounds.b - bounds.a) / N;
                    let s = expr.evaluate({x: bounds.a}) + expr.evaluate({x: bounds.b});
                    for(let i=1; i<N; i+=2) s += 4 * expr.evaluate({x: parseFloat(bounds.a) + i*h_sim});
                    for(let i=2; i<N-1; i+=2) s += 2 * expr.evaluate({x: parseFloat(bounds.a) + i*h_sim});
                    exact = (s * h_sim) / 3;
                } catch(e) {}

                setStats({
                    approx: sumArea,
                    exact: exact,
                    error: Math.abs(((sumArea - exact)/exact)*100)
                });

            }, [funcStr, bounds, mode]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-blue-500 flex items-center gap-2">
                            <i className="fas fa-chart-area"></i> Calculus Lab
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-400">Function f(x)</label>
                                <input 
                                    value={funcStr}
                                    onChange={e => setFuncStr(e.target.value)}
                                    className="w-full bg-black/30 border border-white/20 rounded-lg p-2 font-mono text-sm mt-1"
                                />
                            </div>
                            <div className="flex gap-2">
                                <div>
                                    <label className="text-xs font-bold text-gray-400">Start (a)</label>
                                    <input 
                                        type="number"
                                        value={bounds.a}
                                        onChange={e => setBounds({...bounds, a: parseFloat(e.target.value)})}
                                        className="w-full bg-black/30 border border-white/20 rounded-lg p-2 font-mono text-sm mt-1"
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-400">End (b)</label>
                                    <input 
                                        type="number"
                                        value={bounds.b}
                                        onChange={e => setBounds({...bounds, b: parseFloat(e.target.value)})}
                                        className="w-full bg-black/30 border border-white/20 rounded-lg p-2 font-mono text-sm mt-1"
                                    />
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Partitions (n)</span>
                                    <span>{bounds.n}</span>
                                </div>
                                <input 
                                    type="range" min="2" max="100" 
                                    value={bounds.n}
                                    onChange={e => setBounds({...bounds, n: parseInt(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div className="flex bg-black/20 rounded p-1">
                                {['left', 'mid', 'right'].map(m => (
                                    <button 
                                        key={m}
                                        onClick={() => setMode(m)}
                                        className={`flex-1 py-1 rounded text-[10px] font-bold uppercase ${mode === m ? 'bg-blue-500 text-white' : 'text-gray-400'}`}
                                    >
                                        {m}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="mt-auto bg-black/20 rounded-xl p-4 space-y-2 text-xs">
                            <div className="flex justify-between">
                                <span className="text-gray-400">Approx Area</span>
                                <span className="font-mono text-blue-400">{stats.approx.toFixed(4)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Exact Integral</span>
                                <span className="font-mono text-green-400">{stats.exact.toFixed(4)}</span>
                            </div>
                            <div className="flex justify-between pt-2 border-t border-white/5">
                                <span className="text-gray-400">Error</span>
                                <span className="font-mono text-red-400">{stats.error.toFixed(2)}%</span>
                            </div>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                        <div className="absolute top-4 right-4 text-xs font-mono text-blue-500 bg-black/40 px-3 py-1 rounded border border-blue-500/30">
                            ∫ {funcStr} dx
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER CALCULUS APP ---
        APP_REGISTRY.calc = { id: 'calc', title: 'Calculus Lab', icon: 'fa-chart-area', color: '#3b82f6', width: 800, height: 600 };
        
        /* PART 45 COMPLETE: CALCULUS LAB READY */
        // ==================================================================================
        // 46. APP MODULE: FRACTAL EXPLORER (Mathematical Art)
        // ==================================================================================

        const FractalApp = () => {
            const canvasRef = React.useRef(null);
            const [view, setView] = React.useState({ x: -0.5, y: 0, zoom: 1 });
            const [quality, setQuality] = React.useState('med'); // low, med, high

            // --- FRACTAL ENGINE ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const w = canvas.width = canvas.parentElement.clientWidth;
                const h = canvas.height = canvas.parentElement.clientHeight;

                // Resolution settings
                const res = quality === 'low' ? 4 : (quality === 'med' ? 2 : 1);
                const maxIter = quality === 'low' ? 50 : (quality === 'med' ? 100 : 200);

                const imgData = ctx.createImageData(w, h);
                const data = imgData.data;

                // Fractal bounds
                const ratio = w / h;
                const scale = 3.0 / view.zoom;
                const xMin = view.x - scale/2;
                const yMin = view.y - (scale/ratio)/2;

                // Loop pixels
                for (let px = 0; px < w; px += res) {
                    for (let py = 0; py < h; py += res) {
                        
                        // Map pixel to complex plane
                        let cx = xMin + (px / w) * scale;
                        let cy = yMin + (py / h) * (scale / ratio);

                        let zx = 0, zy = 0;
                        let iter = 0;

                        // Mandelbrot Formula: z = z^2 + c
                        while (zx*zx + zy*zy < 4 && iter < maxIter) {
                            let tmp = zx*zx - zy*zy + cx;
                            zy = 2*zx*zy + cy;
                            zx = tmp;
                            iter++;
                        }

                        // Color Logic (HSV to RGB approx)
                        let r, g, b;
                        if (iter === maxIter) {
                            r = g = b = 0; // Inside set = Black
                        } else {
                            // Smooth coloring
                            const hue = iter / maxIter;
                            r = Math.floor(255 * hue);
                            g = Math.floor(255 * (1 - hue));
                            b = Math.floor(255 * 0.5 * hue);
                        }

                        // Fill pixel block
                        for (let rx = 0; rx < res; rx++) {
                            for (let ry = 0; ry < res; ry++) {
                                if (px+rx < w && py+ry < h) {
                                    const idx = 4 * ((py+ry) * w + (px+rx));
                                    data[idx] = r;     // R
                                    data[idx+1] = g;   // G
                                    data[idx+2] = b;   // B
                                    data[idx+3] = 255; // Alpha
                                }
                            }
                        }
                    }
                }
                ctx.putImageData(imgData, 0, 0);

            }, [view, quality]);

            return (
                <div className="flex h-full bg-black text-white font-sans overflow-hidden group">
                    <canvas ref={canvasRef} className="w-full h-full cursor-move" />
                    
                    {/* HUD */}
                    <div className="absolute top-4 left-4 bg-black/60 backdrop-blur rounded-xl p-4 border border-white/10 opacity-0 group-hover:opacity-100 transition-opacity">
                        <h2 className="text-lg font-bold font-math text-purple-400">Mandelbrot Set</h2>
                        <p className="text-xs text-gray-400 mb-3">z<sub>n+1</sub> = z<sub>n</sub><sup>2</sup> + c</p>
                        
                        <div className="flex gap-2 mb-2">
                            <button onClick={() => setView({...view, zoom: view.zoom * 1.5})} className="px-3 py-1 bg-white/10 rounded hover:bg-white/20">+</button>
                            <button onClick={() => setView({...view, zoom: view.zoom / 1.5})} className="px-3 py-1 bg-white/10 rounded hover:bg-white/20">-</button>
                        </div>
                        
                        <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">Quality</div>
                        <div className="flex bg-white/5 rounded p-1">
                            {['low', 'med', 'high'].map(q => (
                                <button 
                                    key={q} 
                                    onClick={() => setQuality(q)}
                                    className={`flex-1 text-[10px] uppercase ${quality === q ? 'bg-purple-500 text-white' : 'text-gray-500'}`}
                                >
                                    {q}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER FRACTAL APP ---
        APP_REGISTRY.fractal = { id: 'fractal', title: 'Fractal Explorer', icon: 'fa-snowflake', color: '#a855f7', width: 600, height: 600 };
        
        /* PART 46 COMPLETE: FRACTAL READY */
        // ==================================================================================
        // 47. APP MODULE: CANVASBOARD (Digital Whiteboard)
        // ==================================================================================

        const BoardApp = () => {
            const canvasRef = React.useRef(null);
            const [isDrawing, setIsDrawing] = React.useState(false);
            const [tool, setTool] = React.useState('pen'); // pen, marker, eraser
            const [color, setColor] = React.useState('#ffffff');
            const [size, setSize] = React.useState(2);
            const [showGrid, setShowGrid] = React.useState(true);

            // --- SETUP & RESIZE ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                // Handle Resize (Naive approach: clears canvas on resize, 
                // in prod we'd save/restore image data)
                const resize = () => {
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                    if (showGrid) drawGrid(ctx, canvas.width, canvas.height);
                };
                
                resize();
                // window.addEventListener('resize', resize); // Omitted to prevent clear on win resize
                return () => window.removeEventListener('resize', resize);
            }, [showGrid]);

            const drawGrid = (ctx, w, h) => {
                ctx.fillStyle = '#1e1e1e';
                ctx.fillRect(0, 0, w, h);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for(let x=0; x<w; x+=40) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
                for(let y=0; y<h; y+=40) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();
            };

            // --- DRAWING HANDLERS ---
            const startDraw = (e) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                
                ctx.strokeStyle = tool === 'eraser' ? '#1e1e1e' : color;
                ctx.lineWidth = tool === 'marker' ? 10 : (tool === 'eraser' ? 20 : size);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                if (tool === 'marker') ctx.globalAlpha = 0.5;
                else ctx.globalAlpha = 1.0;
                
                ctx.stroke();
            };

            const stopDraw = () => {
                setIsDrawing(false);
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
            };

            const clear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (showGrid) drawGrid(ctx, canvas.width, canvas.height);
            };

            const download = () => {
                const link = document.createElement('a');
                link.download = `Whiteboard_${Date.now()}.png`;
                link.href = canvasRef.current.toDataURL();
                link.click();
            };

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Toolbar */}
                    <div className="w-16 bg-sg-surface border-r border-sg-border flex flex-col items-center py-4 gap-3 z-10">
                        <button 
                            onClick={() => setTool('pen')}
                            className={`w-10 h-10 rounded flex items-center justify-center transition-all ${tool === 'pen' ? 'bg-brand-primary text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}
                            title="Pen"
                        >
                            <i className="fas fa-pen"></i>
                        </button>
                        <button 
                            onClick={() => setTool('marker')}
                            className={`w-10 h-10 rounded flex items-center justify-center transition-all ${tool === 'marker' ? 'bg-brand-primary text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}
                            title="Highlighter"
                        >
                            <i className="fas fa-highlighter"></i>
                        </button>
                        <button 
                            onClick={() => setTool('eraser')}
                            className={`w-10 h-10 rounded flex items-center justify-center transition-all ${tool === 'eraser' ? 'bg-red-500 text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}
                            title="Eraser"
                        >
                            <i className="fas fa-eraser"></i>
                        </button>

                        <div className="w-8 h-px bg-white/10 my-1"></div>

                        {/* Color Picker */}
                        {['#ffffff', '#f43f5e', '#3b82f6', '#10b981', '#fbbf24'].map(c => (
                            <button
                                key={c}
                                onClick={() => { setColor(c); setTool('pen'); }}
                                className={`w-6 h-6 rounded-full border-2 ${color === c && tool !== 'eraser' ? 'border-white scale-110' : 'border-transparent'}`}
                                style={{ backgroundColor: c }}
                            />
                        ))}

                        <div className="mt-auto flex flex-col gap-3 mb-2">
                            <button onClick={() => setShowGrid(!showGrid)} className="text-gray-400 hover:text-white" title="Toggle Grid">
                                <i className={`fas fa-border-all ${showGrid ? 'text-brand-primary' : ''}`}></i>
                            </button>
                            <button onClick={clear} className="text-gray-400 hover:text-red-400" title="Clear All">
                                <i className="fas fa-trash-alt"></i>
                            </button>
                            <button onClick={download} className="text-gray-400 hover:text-white" title="Save Image">
                                <i className="fas fa-download"></i>
                            </button>
                        </div>
                    </div>

                    {/* Canvas Area */}
                    <div className="flex-1 relative cursor-crosshair bg-[#1e1e1e]">
                        <canvas 
                            ref={canvasRef}
                            onMouseDown={startDraw}
                            onMouseMove={draw}
                            onMouseUp={stopDraw}
                            onMouseLeave={stopDraw}
                            className="absolute inset-0 block touch-none"
                        />
                    </div>
                </div>
            );
        };

        // --- REGISTER BOARD APP ---
        APP_REGISTRY.board = { id: 'board', title: 'CanvasBoard', icon: 'fa-pen-to-square', color: '#ffffff', width: 900, height: 700 };
        
        /* PART 47 COMPLETE: CANVASBOARD READY */
        // ==================================================================================
        // 48. APP MODULE: LOFI STATION (Music Player)
        // ==================================================================================

        const MusicApp = () => {
            const [playing, setPlaying] = React.useState(false);
            const [track, setTrack] = React.useState(0);
            
            const tracks = [
                { title: 'Study Beats 24/7', artist: 'Lofi Girl', color: '#a855f7' },
                { title: 'Alpha Waves', artist: 'Focus Minds', color: '#3b82f6' },
                { title: 'Rainy Night', artist: 'Ambience', color: '#64748b' },
                { title: 'Coffee Shop', artist: 'Ambient Noise', color: '#f59e0b' }
            ];

            // Simulated Audio Visualizer (CSS Animation)
            const Visualizer = ({ active }) => (
                <div className="flex items-end justify-center gap-1 h-12 w-full mb-4">
                    {[...Array(12)].map((_, i) => (
                        <div 
                            key={i}
                            className={`w-2 bg-white rounded-t transition-all duration-300 ${active ? 'animate-bounce' : 'h-1 opacity-20'}`}
                            style={{ 
                                height: active ? `${Math.random() * 100}%` : '4px',
                                animationDelay: `${i * 0.05}s`,
                                animationDuration: '0.8s',
                                backgroundColor: tracks[track].color
                            }}
                        />
                    ))}
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden relative">
                    {/* Background Album Art Blur */}
                    <div 
                        className="absolute inset-0 opacity-20 bg-cover bg-center blur-xl transition-all duration-1000"
                        style={{ backgroundColor: tracks[track].color }}
                    ></div>

                    <div className="relative z-10 flex flex-col h-full p-6">
                        {/* Header */}
                        <div className="flex items-center gap-3 mb-6">
                            <i className="fas fa-headphones-simple text-2xl"></i>
                            <span className="text-sm font-bold tracking-widest uppercase">Focus FM</span>
                        </div>

                        {/* Main Player */}
                        <div className="flex-1 flex flex-col items-center justify-center text-center">
                            <div className="w-40 h-40 rounded-2xl bg-white/10 border border-white/10 shadow-2xl mb-6 flex items-center justify-center relative overflow-hidden group">
                                <div className={`absolute inset-0 bg-gradient-to-br from-black/50 to-transparent ${playing ? 'opacity-0' : 'opacity-100'} transition-opacity`}></div>
                                <i className={`fas fa-music text-4xl opacity-50 ${playing ? 'animate-pulse' : ''}`}></i>
                            </div>

                            <h2 className="text-2xl font-bold mb-1">{tracks[track].title}</h2>
                            <p className="text-sm text-gray-400 mb-6">{tracks[track].artist}</p>

                            <Visualizer active={playing} />

                            {/* Controls */}
                            <div className="flex items-center gap-6 mt-4">
                                <button 
                                    onClick={() => setTrack((track - 1 + tracks.length) % tracks.length)}
                                    className="text-gray-400 hover:text-white transition-colors"
                                >
                                    <i className="fas fa-backward-step text-xl"></i>
                                </button>
                                
                                <button 
                                    onClick={() => setPlaying(!playing)}
                                    className="w-16 h-16 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition-transform shadow-glow-white"
                                >
                                    <i className={`fas ${playing ? 'fa-pause' : 'fa-play'} text-xl`}></i>
                                </button>
                                
                                <button 
                                    onClick={() => setTrack((track + 1) % tracks.length)}
                                    className="text-gray-400 hover:text-white transition-colors"
                                >
                                    <i className="fas fa-forward-step text-xl"></i>
                                </button>
                            </div>
                        </div>

                        {/* Volume Sim */}
                        <div className="mt-8 flex items-center gap-3 text-xs text-gray-400">
                            <i className="fas fa-volume-low"></i>
                            <div className="flex-1 h-1 bg-white/10 rounded-full overflow-hidden">
                                <div className="w-[70%] h-full bg-white rounded-full"></div>
                            </div>
                            <i className="fas fa-volume-high"></i>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER MUSIC APP ---
        APP_REGISTRY.music = { id: 'music', title: 'LoFi Station', icon: 'fa-headphones', color: '#d946ef', width: 350, height: 550 };
        
        /* PART 48 COMPLETE: LOFI STATION READY */
        // ==================================================================================
        // 49. APP MODULE: FOCUSFLOW (Pomodoro Timer)
        // ==================================================================================

        const FocusApp = () => {
            const [timeLeft, setTimeLeft] = React.useState(25 * 60);
            const [isActive, setIsActive] = React.useState(false);
            const [mode, setMode] = React.useState('focus'); // focus, short, long
            const [sessions, setSessions] = React.useState(0);
            const circleRef = React.useRef(null);

            // --- TIMER LOGIC ---
            React.useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft(t => t - 1);
                    }, 1000);
                } else if (timeLeft === 0) {
                    setIsActive(false);
                    if (mode === 'focus') setSessions(s => s + 1);
                    // Play chime sound (simulated)
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode]);

            // --- PROGRESS RING CALC ---
            const totalTime = mode === 'focus' ? 25 * 60 : (mode === 'short' ? 5 * 60 : 15 * 60);
            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const progress = (timeLeft / totalTime) * circumference;
            const offset = circumference - progress;

            const switchMode = (m) => {
                setMode(m);
                setIsActive(false);
                setTimeLeft(m === 'focus' ? 25 * 60 : (m === 'short' ? 5 * 60 : 15 * 60));
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans items-center justify-center p-6 relative overflow-hidden">
                    {/* Background Glow */}
                    <div className={`absolute inset-0 bg-gradient-to-b ${mode === 'focus' ? 'from-red-500/10' : 'from-green-500/10'} to-transparent transition-colors duration-500`}></div>

                    {/* Mode Switcher */}
                    <div className="relative z-10 flex bg-white/5 rounded-full p-1 mb-8 border border-white/10">
                        {[
                            { id: 'focus', l: 'Focus' },
                            { id: 'short', l: 'Short Break' },
                            { id: 'long', l: 'Long Break' }
                        ].map(m => (
                            <button
                                key={m.id}
                                onClick={() => switchMode(m.id)}
                                className={`
                                    px-4 py-2 rounded-full text-xs font-bold uppercase transition-all
                                    ${mode === m.id ? 'bg-white text-black shadow-lg' : 'text-gray-400 hover:text-white'}
                                `}
                            >
                                {m.l}
                            </button>
                        ))}
                    </div>

                    {/* Circular Timer */}
                    <div className="relative z-10 mb-8">
                        <svg width="200" height="200" className="transform -rotate-90">
                            {/* Track */}
                            <circle
                                cx="100" cy="100" r={radius}
                                stroke="rgba(255,255,255,0.1)" strokeWidth="8" fill="transparent"
                            />
                            {/* Progress */}
                            <circle
                                ref={circleRef}
                                cx="100" cy="100" r={radius}
                                stroke={mode === 'focus' ? '#ef4444' : '#10b981'}
                                strokeWidth="8" fill="transparent"
                                strokeDasharray={circumference}
                                strokeDashoffset={offset}
                                strokeLinecap="round"
                                className="transition-all duration-1000 ease-linear"
                            />
                        </svg>
                        
                        {/* Time Display */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <div className="text-4xl font-mono font-bold tracking-wider">
                                {formatTime(timeLeft)}
                            </div>
                            <div className="text-xs uppercase text-gray-500 font-bold mt-1">
                                {isActive ? 'Running' : 'Paused'}
                            </div>
                        </div>
                    </div>

                    {/* Controls */}
                    <button
                        onClick={() => setIsActive(!isActive)}
                        className={`
                            relative z-10 px-8 py-3 rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-95 flex items-center gap-2
                            ${isActive ? 'bg-white/10 text-white border border-white/20' : 'bg-white text-black'}
                        `}
                    >
                        <i className={`fas ${isActive ? 'fa-pause' : 'fa-play'}`}></i>
                        {isActive ? 'Pause Timer' : 'Start Focus'}
                    </button>

                    {/* Stats */}
                    <div className="absolute bottom-6 flex gap-8 text-center opacity-60">
                        <div>
                            <div className="text-2xl font-bold">{sessions}</div>
                            <div className="text-[10px] uppercase">Sessions</div>
                        </div>
                        <div>
                            <div className="text-2xl font-bold">{Math.floor(sessions * 25)}m</div>
                            <div className="text-[10px] uppercase">Focus Time</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER FOCUS APP ---
        APP_REGISTRY.focus = { id: 'focus', title: 'FocusFlow', icon: 'fa-clock', color: '#ef4444', width: 400, height: 500 };
        
        /* PART 49 COMPLETE: POMODORO READY */
        // ==================================================================================
        // 50. APP MODULE: SYSTEM MONITOR (Task Manager)
        // ==================================================================================

        const TaskMgrApp = () => {
            const { state, dispatch } = useOS();
            const [refresh, setRefresh] = React.useState(0);

            // Auto-refresh stats every 2 seconds
            React.useEffect(() => {
                const interval = setInterval(() => setRefresh(r => r + 1), 2000);
                return () => clearInterval(interval);
            }, []);

            // Generate fake stats based on app type
            const getStats = (id) => {
                const baseCpu = Math.random() * 5;
                const baseMem = 50 + Math.random() * 100;
                
                if (['fractal', 'bio', 'astro'].includes(id)) return { cpu: (baseCpu * 4).toFixed(1), mem: (baseMem * 3).toFixed(0) };
                if (['calc', 'graph', 'board'].includes(id)) return { cpu: (baseCpu * 2).toFixed(1), mem: (baseMem * 2).toFixed(0) };
                return { cpu: baseCpu.toFixed(1), mem: baseMem.toFixed(0) };
            };

            const processes = state.windows.map(win => ({
                ...win,
                ...getStats(win.id)
            }));

            // Calculate totals
            const totalCpu = processes.reduce((acc, p) => acc + parseFloat(p.cpu), 2).toFixed(1); // +2% system idle
            const totalMem = processes.reduce((acc, p) => acc + parseFloat(p.mem), 450); // +450MB OS kernel

            const killProcess = (instanceId) => {
                dispatch({ type: 'CLOSE_WINDOW', payload: instanceId });
            };

            return (
                <div className="flex flex-col h-full bg-[#1e1e1e] text-white font-sans overflow-hidden border-t-4 border-brand-primary">
                    {/* Header Charts */}
                    <div className="grid grid-cols-2 gap-4 p-4 bg-[#252526] border-b border-black">
                        <div className="bg-black/40 p-3 rounded border border-white/5">
                            <div className="text-xs text-gray-400 uppercase font-bold mb-1">CPU Usage</div>
                            <div className="flex items-end gap-2">
                                <span className="text-2xl font-mono text-blue-400">{totalCpu}%</span>
                                <div className="flex-1 h-1 bg-gray-800 mb-2 rounded overflow-hidden">
                                    <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${Math.min(totalCpu, 100)}%` }}></div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-black/40 p-3 rounded border border-white/5">
                            <div className="text-xs text-gray-400 uppercase font-bold mb-1">Memory (RAM)</div>
                            <div className="flex items-end gap-2">
                                <span className="text-2xl font-mono text-purple-400">{(totalMem / 1024).toFixed(1)} GB</span>
                                <div className="flex-1 h-1 bg-gray-800 mb-2 rounded overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-500" style={{ width: `${Math.min((totalMem/4096)*100, 100)}%` }}></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Process List */}
                    <div className="flex-1 overflow-y-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-[#252526] text-xs uppercase text-gray-400 sticky top-0">
                                <tr>
                                    <th className="p-3 font-bold border-b border-black">App Name</th>
                                    <th className="p-3 font-bold border-b border-black w-20">CPU</th>
                                    <th className="p-3 font-bold border-b border-black w-24">Memory</th>
                                    <th className="p-3 font-bold border-b border-black w-16">Action</th>
                                </tr>
                            </thead>
                            <tbody className="text-sm font-mono">
                                {processes.map(p => (
                                    <tr key={p.instanceId} className="hover:bg-white/5 border-b border-white/5 transition-colors group">
                                        <td className="p-3 flex items-center gap-3">
                                            <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                            {p.title}
                                            <span className="text-xs text-gray-600 ml-auto">PID: {p.instanceId}</span>
                                        </td>
                                        <td className="p-3 text-blue-300">{p.cpu}%</td>
                                        <td className="p-3 text-purple-300">{p.mem} MB</td>
                                        <td className="p-3 text-center">
                                            <button 
                                                onClick={() => killProcess(p.instanceId)}
                                                className="text-gray-600 hover:text-red-500 transition-colors"
                                                title="End Task"
                                            >
                                                <i className="fas fa-power-off"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {/* OS Kernel Mock */}
                                <tr className="opacity-50 pointer-events-none">
                                    <td className="p-3 flex items-center gap-3">
                                        <div className="w-2 h-2 rounded-full bg-gray-500"></div>
                                        System Kernel
                                    </td>
                                    <td className="p-3">1.2%</td>
                                    <td className="p-3">450 MB</td>
                                    <td className="p-3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="p-2 bg-[#252526] text-[10px] text-gray-500 text-center border-t border-black">
                        Processes: {processes.length + 42} • Threads: {processes.length * 4 + 120} • Uptime: 04:20:00
                    </div>
                </div>
            );
        };

        // --- REGISTER TASK MGR APP ---
        APP_REGISTRY.task = { id: 'task', title: 'System Monitor', icon: 'fa-microchip', color: '#64748b', width: 600, height: 500 };
        
        /* PART 50 COMPLETE: SYSTEM MONITOR READY */
        // ==================================================================================
        // 51. APP MODULE: ALGOVIS (Sorting Algorithms)
        // ==================================================================================

        const AlgoApp = () => {
            const [array, setArray] = React.useState([]);
            const [size, setSize] = React.useState(30);
            const [speed, setSpeed] = React.useState(50);
            const [algo, setAlgo] = React.useState('bubble');
            const [sorting, setSorting] = React.useState(false);
            
            // Visual State
            const [active, setActive] = React.useState([]); // Indices being compared
            const [sorted, setSorted] = React.useState([]); // Indices sorted

            // --- INITIALIZATION ---
            React.useEffect(() => {
                resetArray();
            }, [size]);

            const resetArray = () => {
                if (sorting) return;
                const arr = [];
                for (let i = 0; i < size; i++) {
                    arr.push(Math.floor(Math.random() * 100) + 5);
                }
                setArray(arr);
                setSorted([]);
                setActive([]);
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- ALGORITHMS ---
            const runSort = async () => {
                setSorting(true);
                const arr = [...array];
                const delay = 101 - speed;

                if (algo === 'bubble') {
                    for (let i = 0; i < arr.length; i++) {
                        for (let j = 0; j < arr.length - i - 1; j++) {
                            setActive([j, j + 1]);
                            await sleep(delay);

                            if (arr[j] > arr[j + 1]) {
                                let temp = arr[j];
                                arr[j] = arr[j + 1];
                                arr[j + 1] = temp;
                                setArray([...arr]);
                            }
                        }
                        setSorted(prev => [...prev, arr.length - i - 1]);
                    }
                } 
                else if (algo === 'selection') {
                    for (let i = 0; i < arr.length; i++) {
                        let minIdx = i;
                        for (let j = i + 1; j < arr.length; j++) {
                            setActive([minIdx, j]);
                            await sleep(delay);
                            if (arr[j] < arr[minIdx]) minIdx = j;
                        }
                        if (minIdx !== i) {
                            let temp = arr[i];
                            arr[i] = arr[minIdx];
                            arr[minIdx] = temp;
                            setArray([...arr]);
                        }
                        setSorted(prev => [...prev, i]);
                    }
                }
                else if (algo === 'insertion') {
                    for (let i = 1; i < arr.length; i++) {
                        let key = arr[i];
                        let j = i - 1;
                        while (j >= 0 && arr[j] > key) {
                            setActive([j, j + 1]);
                            await sleep(delay);
                            arr[j + 1] = arr[j];
                            setArray([...arr]);
                            j = j - 1;
                        }
                        arr[j + 1] = key;
                        setArray([...arr]);
                    }
                    // Mark all as sorted at end
                    setSorted(arr.map((_, i) => i));
                }

                setSorting(false);
                setActive([]);
                if (algo !== 'insertion') setSorted(arr.map((_, i) => i)); // Ensure full blue
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Header / Controls */}
                    <div className="h-16 bg-sg-surface border-b border-sg-border px-4 flex items-center justify-between gap-4">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-layer-group text-purple-500"></i>
                            <span className="font-bold hidden sm:block">AlgoVis</span>
                        </div>

                        <div className="flex bg-black/20 rounded p-1">
                            {['bubble', 'selection', 'insertion'].map(a => (
                                <button
                                    key={a}
                                    onClick={() => setAlgo(a)}
                                    disabled={sorting}
                                    className={`px-3 py-1 rounded text-xs uppercase font-bold transition-colors ${algo === a ? 'bg-purple-500 text-white' : 'text-gray-400 hover:text-white disabled:opacity-50'}`}
                                >
                                    {a}
                                </button>
                            ))}
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="w-24">
                                <label className="text-[8px] uppercase text-gray-500 font-bold block">Size</label>
                                <input 
                                    type="range" min="10" max="100" value={size} 
                                    onChange={e => setSize(Number(e.target.value))}
                                    disabled={sorting}
                                    className="w-full accent-purple-500 h-1 bg-gray-700 rounded cursor-pointer" 
                                />
                            </div>
                            <div className="w-24">
                                <label className="text-[8px] uppercase text-gray-500 font-bold block">Speed</label>
                                <input 
                                    type="range" min="1" max="100" value={speed} 
                                    onChange={e => setSpeed(Number(e.target.value))}
                                    disabled={sorting}
                                    className="w-full accent-green-500 h-1 bg-gray-700 rounded cursor-pointer" 
                                />
                            </div>
                        </div>

                        <div className="flex gap-2">
                            <button 
                                onClick={resetArray} 
                                disabled={sorting}
                                className="w-8 h-8 rounded bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400"
                            >
                                <i className="fas fa-rotate-right"></i>
                            </button>
                            <button 
                                onClick={runSort} 
                                disabled={sorting}
                                className={`px-4 py-1 rounded font-bold shadow-glow text-sm transition-all ${sorting ? 'bg-gray-600 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600'}`}
                            >
                                {sorting ? 'Running...' : 'Sort'}
                            </button>
                        </div>
                    </div>

                    {/* Visualization Area */}
                    <div className="flex-1 flex items-end justify-center gap-0.5 p-4 bg-[#1e1e1e]">
                        {array.map((val, idx) => {
                            let color = '#3b82f6'; // Default Blue
                            if (active.includes(idx)) color = '#ef4444'; // Red (Compare)
                            if (sorted.includes(idx)) color = '#10b981'; // Green (Sorted)
                            
                            return (
                                <div 
                                    key={idx}
                                    style={{ 
                                        height: `${val}%`, 
                                        width: `${100/size}%`, 
                                        backgroundColor: color,
                                        transition: 'height 0.1s ease'
                                    }}
                                    className="rounded-t-sm shadow-sm"
                                ></div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- REGISTER ALGO APP ---
        APP_REGISTRY.algo = { id: 'algo', title: 'AlgoVis', icon: 'fa-arrow-down-short-wide', color: '#8b5cf6', width: 800, height: 500 };

        /* PART 51 COMPLETE: ALGOVIS READY */
        // ==================================================================================
        // 52. APP MODULE: CRYPTOLAB (Cybersecurity)
        // ==================================================================================

        const CryptoApp = () => {
            const [input, setInput] = React.useState('Hello World');
            const [shift, setShift] = React.useState(3);
            const [key, setKey] = React.useState('KEY');
            const [mode, setMode] = React.useState('caesar'); // caesar, vigenere, hash

            // --- ENGINES ---
            const caesar = (str, amount) => {
                return str.split('').map(c => {
                    if (c.match(/[a-z]/i)) {
                        const code = c.charCodeAt(0);
                        const base = code >= 65 && code <= 90 ? 65 : 97;
                        return String.fromCharCode(((code - base + amount) % 26) + base);
                    }
                    return c;
                }).join('');
            };

            const vigenere = (str, key) => {
                let res = '';
                let j = 0;
                for (let i = 0; i < str.length; i++) {
                    const c = str[i];
                    if (c.match(/[a-z]/i)) {
                        const code = c.charCodeAt(0);
                        const base = code >= 65 && code <= 90 ? 65 : 97;
                        const kChar = key[j % key.length];
                        const shift = kChar.toLowerCase().charCodeAt(0) - 97;
                        res += String.fromCharCode(((code - base + shift) % 26) + base);
                        j++;
                    } else {
                        res += c;
                    }
                }
                return res;
            };

            // Simple Hash (DJB2 variant for demo purposes)
            const simpleHash = (str) => {
                let hash = 5381;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
                }
                return (hash >>> 0).toString(16).padStart(16, '0'); // Hex
            };

            let output = '';
            if (mode === 'caesar') output = caesar(input, parseInt(shift));
            if (mode === 'vigenere') output = vigenere(input, key);
            if (mode === 'hash') output = simpleHash(input);

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-mono overflow-hidden p-8">
                    <div className="text-center mb-8">
                        <i className="fas fa-user-secret text-5xl text-green-500 mb-4 animate-pulse"></i>
                        <h1 className="text-3xl font-bold font-cyber">CryptoLab</h1>
                        <p className="text-xs text-gray-500 uppercase tracking-widest">Encryption & Hashing Engine</p>
                    </div>

                    <div className="grid grid-cols-3 gap-2 mb-8 bg-white/5 p-1 rounded-lg">
                        {['caesar', 'vigenere', 'hash'].map(m => (
                            <button 
                                key={m} 
                                onClick={() => setMode(m)}
                                className={`py-2 rounded uppercase text-xs font-bold transition-all ${mode === m ? 'bg-green-600 text-black shadow-glow' : 'text-gray-400 hover:text-white'}`}
                            >
                                {m}
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* Input */}
                        <div className="space-y-4">
                            <label className="text-xs font-bold text-gray-500 uppercase">Plaintext Input</label>
                            <textarea 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                className="w-full h-32 bg-black/40 border border-green-500/30 rounded-xl p-4 text-green-400 focus:border-green-500 outline-none resize-none"
                                placeholder="Enter secret message..."
                            />
                            
                            {/* Settings */}
                            <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                {mode === 'caesar' && (
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs text-gray-400">Shift Amount: {shift}</span>
                                        <input 
                                            type="range" min="1" max="25" 
                                            value={shift} onChange={e => setShift(e.target.value)}
                                            className="w-32 accent-green-500"
                                        />
                                    </div>
                                )}
                                {mode === 'vigenere' && (
                                    <div>
                                        <label className="text-xs text-gray-400 block mb-1">Secret Key</label>
                                        <input 
                                            type="text" value={key} onChange={e => setKey(e.target.value)}
                                            className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-sm uppercase"
                                        />
                                    </div>
                                )}
                                {mode === 'hash' && (
                                    <div className="text-xs text-gray-500 italic">
                                        Hashes are one-way functions. They cannot be decrypted back to the original text.
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Output */}
                        <div className="space-y-4">
                            <label className="text-xs font-bold text-gray-500 uppercase">Ciphertext Output</label>
                            <div className="relative group">
                                <textarea 
                                    readOnly
                                    value={output}
                                    className="w-full h-32 bg-black/40 border border-red-500/30 rounded-xl p-4 text-red-400 outline-none resize-none font-bold"
                                />
                                <button 
                                    onClick={() => navigator.clipboard.writeText(output)}
                                    className="absolute top-2 right-2 bg-black/50 p-2 rounded text-xs hover:text-white text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <i className="fas fa-copy"></i>
                                </button>
                            </div>

                            <div className="bg-white/5 p-4 rounded-xl border border-white/5 text-xs text-gray-400">
                                {mode === 'caesar' && "A simple substitution cipher where each letter is shifted by a fixed number."}
                                {mode === 'vigenere' && "A polyalphabetic cipher that uses a keyword to shift letters variably."}
                                {mode === 'hash' && "A mathematical algorithm that maps data of arbitrary size to a bit string of fixed size."}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER CRYPTO APP ---
        APP_REGISTRY.crypto = { id: 'crypto', title: 'CryptoLab', icon: 'fa-user-secret', color: '#10b981', width: 700, height: 600 };
        
        /* PART 52 COMPLETE: CRYPTO APP READY */
        // ==================================================================================
        // 53. APP MODULE: RESISTORCAL (Color Code Calculator)
        // ==================================================================================

        const ResistorApp = () => {
            const [bands, setBands] = React.useState(4); // 4 or 5
            const [colors, setColors] = React.useState({
                b1: 1, // Brown
                b2: 0, // Black
                b3: 0, // Black (for 5-band)
                mul: 2, // Red (x100)
                tol: 0.05 // Gold (+/- 5%)
            });

            const colorMap = [
                { n: 'Black', v: 0, c: '#000000', txt: '#fff' },
                { n: 'Brown', v: 1, c: '#8B4513', txt: '#fff' },
                { n: 'Red', v: 2, c: '#FF0000', txt: '#fff' },
                { n: 'Orange', v: 3, c: '#FFA500', txt: '#000' },
                { n: 'Yellow', v: 4, c: '#FFFF00', txt: '#000' },
                { n: 'Green', v: 5, c: '#008000', txt: '#fff' },
                { n: 'Blue', v: 6, c: '#0000FF', txt: '#fff' },
                { n: 'Violet', v: 7, c: '#EE82EE', txt: '#000' },
                { n: 'Grey', v: 8, c: '#808080', txt: '#fff' },
                { n: 'White', v: 9, c: '#FFFFFF', txt: '#000' },
            ];

            const tolMap = {
                0.01: { n: 'Brown', c: '#8B4513' },
                0.02: { n: 'Red', c: '#FF0000' },
                0.05: { n: 'Gold', c: '#D4AF37' },
                0.10: { n: 'Silver', c: '#C0C0C0' }
            };

            // --- CALCULATE ---
            let resistance = 0;
            if (bands === 4) {
                resistance = (colors.b1 * 10 + colors.b2) * Math.pow(10, colors.mul);
            } else {
                resistance = (colors.b1 * 100 + colors.b2 * 10 + colors.b3) * Math.pow(10, colors.mul);
            }

            const formatRes = (r) => {
                if (r >= 1000000) return (r / 1000000).toFixed(2) + ' MΩ';
                if (r >= 1000) return (r / 1000).toFixed(2) + ' kΩ';
                return r + ' Ω';
            };

            const BandSelector = ({ label, val, onChange, opts }) => (
                <div className="flex flex-col gap-1">
                    <span className="text-[10px] uppercase text-gray-500 font-bold">{label}</span>
                    <select 
                        value={val} 
                        onChange={e => onChange(Number(e.target.value))}
                        className="bg-black/20 border border-white/10 rounded p-2 text-sm text-white outline-none"
                    >
                        {opts.map((o, i) => (
                            <option key={i} value={o.v !== undefined ? o.v : o.val}>{o.n}</option>
                        ))}
                    </select>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans p-8 items-center justify-center">
                    
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-3xl font-bold font-cyber text-yellow-500 mb-2">ResistorCal</h1>
                        <div className="flex bg-white/5 rounded-full p-1 w-48 mx-auto border border-white/10">
                            <button onClick={() => setBands(4)} className={`flex-1 py-1 rounded-full text-xs font-bold transition-all ${bands===4 ? 'bg-yellow-500 text-black' : 'text-gray-400'}`}>4 Band</button>
                            <button onClick={() => setBands(5)} className={`flex-1 py-1 rounded-full text-xs font-bold transition-all ${bands===5 ? 'bg-yellow-500 text-black' : 'text-gray-400'}`}>5 Band</button>
                        </div>
                    </div>

                    {/* Resistor Visual */}
                    <div className="relative w-full max-w-lg h-32 flex items-center justify-center mb-10">
                        {/* Wire Left */}
                        <div className="absolute left-0 w-[10%] h-2 bg-gray-400"></div>
                        {/* Body */}
                        <div className="relative w-[80%] h-24 bg-[#e5e7eb] rounded-full flex items-center justify-evenly px-8 shadow-inner overflow-hidden border-4 border-[#d1d5db]">
                            {/* Band 1 */}
                            <div className="w-4 h-full" style={{ backgroundColor: colorMap[colors.b1].c }}></div>
                            {/* Band 2 */}
                            <div className="w-4 h-full" style={{ backgroundColor: colorMap[colors.b2].c }}></div>
                            {/* Band 3 (Only 5-band) */}
                            {bands === 5 && <div className="w-4 h-full" style={{ backgroundColor: colorMap[colors.b3].c }}></div>}
                            {/* Multiplier */}
                            <div className="w-4 h-full" style={{ backgroundColor: colorMap[colors.mul] ? colorMap[colors.mul].c : '#D4AF37' }}></div>
                            {/* Spacer */}
                            <div className="w-8"></div>
                            {/* Tolerance */}
                            <div className="w-4 h-full" style={{ backgroundColor: tolMap[colors.tol].c }}></div>
                        </div>
                        {/* Wire Right */}
                        <div className="absolute right-0 w-[10%] h-2 bg-gray-400"></div>
                    </div>

                    {/* Result */}
                    <div className="text-center mb-8 animate-fadeIn">
                        <div className="text-5xl font-mono font-bold text-white mb-2">{formatRes(resistance)}</div>
                        <div className="text-xl text-yellow-500 font-bold">± {colors.tol * 100}%</div>
                    </div>

                    {/* Controls */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 w-full max-w-3xl bg-white/5 p-6 rounded-xl border border-white/10">
                        <BandSelector label="Band 1" val={colors.b1} onChange={v => setColors({...colors, b1: v})} opts={colorMap} />
                        <BandSelector label="Band 2" val={colors.b2} onChange={v => setColors({...colors, b2: v})} opts={colorMap} />
                        {bands === 5 && (
                            <BandSelector label="Band 3" val={colors.b3} onChange={v => setColors({...colors, b3: v})} opts={colorMap} />
                        )}
                        <BandSelector 
                            label="Multiplier" 
                            val={colors.mul} 
                            onChange={v => setColors({...colors, mul: v})} 
                            opts={[...colorMap, {n: 'Gold (x0.1)', v: -1}, {n: 'Silver (x0.01)', v: -2}]} 
                        />
                        <BandSelector 
                            label="Tolerance" 
                            val={colors.tol} 
                            onChange={v => setColors({...colors, tol: v})} 
                            opts={[
                                {n: 'Brown (1%)', val: 0.01}, 
                                {n: 'Red (2%)', val: 0.02}, 
                                {n: 'Gold (5%)', val: 0.05}, 
                                {n: 'Silver (10%)', val: 0.10}
                            ]} 
                        />
                    </div>
                </div>
            );
        };

        // --- REGISTER RESISTOR APP ---
        APP_REGISTRY.resistor = { id: 'resistor', title: 'ResistorCal', icon: 'fa-microchip', color: '#eab308', width: 700, height: 600 };
        
        /* PART 53 COMPLETE: RESISTORCAL READY */
        // ==================================================================================
        // 54. APP MODULE: BASECONVERTER (Binary/Hex/Dec)
        // ==================================================================================

        const BaseApp = () => {
            const [val, setVal] = React.useState(42); // Internal storage as decimal
            const [bits, setBits] = React.useState(8); // 8 or 16

            // Helpers
            const maxVal = Math.pow(2, bits) - 1;
            const binaryString = val.toString(2).padStart(bits, '0');

            const toggleBit = (idx) => {
                // Reverse index because string is MSB->LSB
                const realIdx = bits - 1 - idx;
                // XOR with bitmask
                const newVal = val ^ (1 << realIdx);
                setVal(newVal);
            };

            const handleInput = (type, v) => {
                let n = parseInt(v, type === 'hex' ? 16 : (type === 'oct' ? 8 : 10));
                if (isNaN(n)) n = 0;
                n = Math.min(Math.max(0, n), maxVal); // Clamp
                setVal(n);
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-mono p-8 items-center justify-center">
                    
                    <div className="text-center mb-10">
                        <i className="fas fa-network-wired text-5xl text-blue-500 mb-4"></i>
                        <h1 className="text-3xl font-bold font-cyber">BaseConverter</h1>
                        <div className="flex bg-white/5 rounded p-1 w-32 mx-auto mt-4 border border-white/10">
                            <button onClick={() => {setBits(8); setVal(v => v > 255 ? 255 : v)}} className={`flex-1 text-xs py-1 rounded ${bits===8 ? 'bg-blue-500' : 'text-gray-500'}`}>8-bit</button>
                            <button onClick={() => setBits(16)} className={`flex-1 text-xs py-1 rounded ${bits===16 ? 'bg-blue-500' : 'text-gray-500'}`}>16-bit</button>
                        </div>
                    </div>

                    {/* Interactive Bits */}
                    <div className="flex gap-2 mb-10 flex-wrap justify-center max-w-2xl">
                        {binaryString.split('').map((bit, i) => (
                            <button
                                key={i}
                                onClick={() => toggleBit(i)}
                                className={`
                                    w-10 h-14 sm:w-12 sm:h-16 rounded-lg flex flex-col items-center justify-center border-b-4 transition-all active:scale-95
                                    ${bit === '1' 
                                        ? 'bg-blue-500 border-blue-700 text-white shadow-[0_0_15px_rgba(59,130,246,0.5)]' 
                                        : 'bg-gray-800 border-gray-900 text-gray-600'}
                                `}
                            >
                                <span className="text-2xl font-bold">{bit}</span>
                                <span className="text-[8px] opacity-50 mt-1">{Math.pow(2, bits - 1 - i)}</span>
                            </button>
                        ))}
                    </div>

                    {/* Inputs */}
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl">
                        <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                            <label className="text-xs text-blue-400 font-bold uppercase mb-2 block">Decimal (10)</label>
                            <input 
                                type="text" 
                                value={val.toString(10)}
                                onChange={e => handleInput('dec', e.target.value)}
                                className="w-full bg-transparent text-3xl font-bold outline-none border-b border-gray-600 focus:border-blue-500"
                            />
                        </div>
                        <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                            <label className="text-xs text-green-400 font-bold uppercase mb-2 block">Hexadecimal (16)</label>
                            <div className="flex items-center">
                                <span className="text-gray-500 text-xl mr-2">0x</span>
                                <input 
                                    type="text" 
                                    value={val.toString(16).toUpperCase()}
                                    onChange={e => handleInput('hex', e.target.value)}
                                    className="w-full bg-transparent text-3xl font-bold outline-none border-b border-gray-600 focus:border-green-500 uppercase"
                                />
                            </div>
                        </div>
                        <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                            <label className="text-xs text-purple-400 font-bold uppercase mb-2 block">Octal (8)</label>
                            <input 
                                type="text" 
                                value={val.toString(8)}
                                onChange={e => handleInput('oct', e.target.value)}
                                className="w-full bg-transparent text-3xl font-bold outline-none border-b border-gray-600 focus:border-purple-500"
                            />
                        </div>
                    </div>

                </div>
            );
        };

        // --- REGISTER BASE APP ---
        APP_REGISTRY.base = { id: 'base', title: 'BaseConverter', icon: 'fa-binary', color: '#3b82f6', width: 800, height: 600 };
        
        /* PART 54 COMPLETE: BASECONVERTER READY */
        // ==================================================================================
        // 55. APP MODULE: TRUTHTABLE (Logic Generator)
        // ==================================================================================

        const TruthApp = () => {
            const [expr, setExpr] = React.useState('A && (B || !C)');
            const [table, setTable] = React.useState(null);
            const [error, setError] = React.useState(null);

            const generate = () => {
                setError(null);
                try {
                    // 1. Extract Variables
                    // Match letters, exclude keywords like AND, OR, true, false
                    const tokens = expr.match(/[a-zA-Z]+/g) || [];
                    const vars = [...new Set(tokens.filter(t => !['true', 'false', 'and', 'or', 'not', 'xor'].includes(t.toLowerCase())))].sort();

                    if (vars.length === 0) throw new Error("No variables found.");
                    if (vars.length > 5) throw new Error("Too many variables (max 5).");

                    // 2. Generate Rows (2^n)
                    const rows = [];
                    const numRows = Math.pow(2, vars.length);

                    for (let i = 0; i < numRows; i++) {
                        const row = {};
                        // Create context for this row
                        vars.forEach((v, idx) => {
                            // MSB logic: High bit first
                            const val = (i >> (vars.length - 1 - idx)) & 1;
                            row[v] = val === 1;
                        });

                        // Evaluate Expression
                        // Sanitize input for JS eval (Risk: Low, client-side only app)
                        let evalStr = expr
                            .replace(/AND/gi, '&&')
                            .replace(/OR/gi, '||')
                            .replace(/NOT/gi, '!')
                            .replace(/XOR/gi, '^'); // JS bitwise XOR works for bools as 0/1

                        // Replace vars with values
                        // Sort by length desc to avoid replacing 'AB' with 'trueB' if 'A' is replaced
                        const sortedVars = [...vars].sort((a, b) => b.length - a.length);
                        sortedVars.forEach(v => {
                            const regex = new RegExp(`\\b${v}\\b`, 'g');
                            evalStr = evalStr.replace(regex, row[v]);
                        });

                        try {
                            // eslint-disable-next-line no-eval
                            const res = eval(evalStr); 
                            row.result = res ? 1 : 0;
                            rows.push(row);
                        } catch (e) {
                            throw new Error("Invalid Syntax");
                        }
                    }

                    setTable({ vars, rows });

                } catch (err) {
                    setError(err.message);
                    setTable(null);
                }
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-mono overflow-hidden p-6">
                    <div className="mb-6 border-b border-white/10 pb-4">
                        <h1 className="text-xl font-bold font-cyber text-purple-400 mb-2">Truth Table Generator</h1>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={expr}
                                onChange={e => setExpr(e.target.value)}
                                placeholder="Enter expression e.g. A && (!B || C)"
                                className="flex-1 bg-black/30 border border-white/20 rounded-lg px-4 py-2 text-sm outline-none focus:border-purple-500 transition-all"
                            />
                            <button 
                                onClick={generate}
                                className="bg-purple-600 hover:bg-purple-500 px-6 rounded-lg font-bold text-sm shadow-glow transition-all"
                            >
                                Generate
                            </button>
                        </div>
                        <div className="text-[10px] text-gray-500 mt-2">
                            Supports: && (AND), || (OR), ! (NOT). Example: <code className="text-gray-300">P && Q</code>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto custom-scroll bg-[#1e1e1e] rounded-xl border border-white/5">
                        {error && (
                            <div className="h-full flex items-center justify-center text-red-400 font-bold">
                                {error}
                            </div>
                        )}
                        
                        {table && (
                            <table className="w-full text-center border-collapse">
                                <thead className="bg-[#252526] sticky top-0 text-gray-400 text-xs uppercase">
                                    <tr>
                                        {table.vars.map(v => (
                                            <th key={v} className="p-3 border-b border-black w-16">{v}</th>
                                        ))}
                                        <th className="p-3 border-b border-black text-purple-400 font-bold bg-[#2d2d30]">Result</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm">
                                    {table.rows.map((row, i) => (
                                        <tr key={i} className="hover:bg-white/5 border-b border-white/5 transition-colors">
                                            {table.vars.map(v => (
                                                <td key={v} className={`p-3 ${row[v] ? 'text-green-400 font-bold' : 'text-gray-600'}`}>
                                                    {row[v] ? '1' : '0'}
                                                </td>
                                            ))}
                                            <td className={`p-3 font-bold border-l border-white/10 ${row.result ? 'text-purple-400 bg-purple-500/10' : 'text-gray-600'}`}>
                                                {row.result}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}

                        {!table && !error && (
                            <div className="h-full flex flex-col items-center justify-center text-gray-600 opacity-50">
                                <i className="fas fa-table text-4xl mb-2"></i>
                                <p className="text-sm">Enter logic to generate table</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- REGISTER TRUTH APP ---
        APP_REGISTRY.truth = { id: 'truth', title: 'TruthTable', icon: 'fa-table', color: '#a855f7', width: 600, height: 600 };
        
        /* PART 55 COMPLETE: TRUTH TABLE READY */
        // ==================================================================================
        // 56. APP MODULE: REGEXPRO (Regex Tester)
        // ==================================================================================

        const RegexApp = () => {
            const [pattern, setPattern] = React.useState('\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b');
            const [flags, setFlags] = React.useState('gim');
            const [text, setText] = React.useState('Contact us at support@studytools.in or admin@google.com for help.');
            const [matches, setMatches] = React.useState([]);

            React.useEffect(() => {
                try {
                    const regex = new RegExp(pattern, flags);
                    const found = text.match(regex) || [];
                    setMatches(found);
                } catch (e) {
                    setMatches([]);
                }
            }, [pattern, flags, text]);

            // Highlight Logic (Simplified)
            // Splitting string by regex matches is tricky in React without dangerous HTML.
            // We'll show a "Match List" instead for safety and simplicity in this simulation.

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden">
                    <div className="p-6 border-b border-sg-border bg-sg-surface">
                        <div className="flex items-center gap-2 mb-4">
                            <span className="text-gray-500 text-xl font-mono">/</span>
                            <input 
                                type="text" 
                                value={pattern}
                                onChange={e => setPattern(e.target.value)}
                                className="flex-1 bg-transparent border-none outline-none text-xl font-mono text-blue-400 placeholder-gray-600"
                                placeholder="Regex Pattern..."
                            />
                            <span className="text-gray-500 text-xl font-mono">/</span>
                            <input 
                                type="text" 
                                value={flags}
                                onChange={e => setFlags(e.target.value)}
                                className="w-16 bg-transparent border-none outline-none text-xl font-mono text-green-500 placeholder-gray-600 text-right"
                                placeholder="flags"
                            />
                        </div>
                        <div className="flex gap-2 text-[10px] text-gray-500 font-mono">
                            <span className="bg-white/10 px-2 py-1 rounded">g: global</span>
                            <span className="bg-white/10 px-2 py-1 rounded">i: case-insensitive</span>
                            <span className="bg-white/10 px-2 py-1 rounded">m: multiline</span>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row min-h-0">
                        {/* Input Text */}
                        <div className="flex-1 p-4 border-r border-sg-border flex flex-col">
                            <label className="text-xs font-bold text-gray-500 uppercase mb-2">Test String</label>
                            <textarea 
                                value={text}
                                onChange={e => setText(e.target.value)}
                                className="flex-1 w-full bg-black/20 border border-white/5 rounded-lg p-4 font-mono text-sm resize-none outline-none focus:border-blue-500 transition-colors"
                            />
                        </div>

                        {/* Matches */}
                        <div className="w-64 bg-[#1e1e1e] p-4 flex flex-col">
                            <label className="text-xs font-bold text-gray-500 uppercase mb-2">Matches ({matches.length})</label>
                            <div className="flex-1 overflow-y-auto custom-scroll space-y-2">
                                {matches.map((m, i) => (
                                    <div key={i} className="bg-blue-500/10 border border-blue-500/30 text-blue-300 font-mono text-sm p-2 rounded break-all">
                                        {m}
                                    </div>
                                ))}
                                {matches.length === 0 && (
                                    <div className="text-center text-gray-600 text-xs mt-10 italic">
                                        No matches found.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER REGEX APP ---
        APP_REGISTRY.regex = { id: 'regex', title: 'RegexPro', icon: 'fa-code', color: '#3b82f6', width: 700, height: 500 };
        
        /* PART 56 COMPLETE: REGEXPRO READY */
        // ==================================================================================
        // 57. APP MODULE: OPTICSLAB (Ray Optics)
        // ==================================================================================

        const OpticsApp = () => {
            const canvasRef = React.useRef(null);
            const [f, setF] = React.useState(100); // Focal length (px)
            const [u, setU] = React.useState(200); // Object distance (px)
            const [h, setH] = React.useState(50);  // Object height (px)
            const [type, setType] = React.useState('convex');

            // --- PHYSICS ENGINE ---
            // Lens Formula: 1/v - 1/u = 1/f  =>  1/v = 1/f + 1/u
            // Sign Convention: Light travels Left -> Right.
            // Pole at (0,0). Object is at -u.
            // Convex: f > 0. Concave: f < 0.
            
            const focal = type === 'convex' ? f : -f;
            const objDist = -u; // Always negative (real object)
            
            let imgDist = 0;
            // 1/v = 1/f + 1/u
            const invV = (1/focal) + (1/objDist);
            imgDist = 1 / invV;

            const m = imgDist / objDist;
            const imgH = m * h;

            // --- RENDERER ---
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const width = canvas.width = canvas.parentElement.clientWidth;
                const height = canvas.height = canvas.parentElement.clientHeight;
                const cx = width / 2;
                const cy = height / 2;

                // Clear
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, width, height);

                // Principal Axis
                ctx.strokeStyle = '#334155';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(width, cy); ctx.stroke();
                ctx.setLineDash([]);

                // Lens (Schematic)
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 2;
                ctx.beginPath();
                if (type === 'convex') {
                    ctx.ellipse(cx, cy, 10, 100, 0, 0, Math.PI*2);
                } else {
                    // Concave shape simplified
                    ctx.moveTo(cx-10, cy-100); ctx.lineTo(cx+10, cy-100);
                    ctx.lineTo(cx+5, cy); ctx.lineTo(cx+10, cy+100);
                    ctx.lineTo(cx-10, cy+100); ctx.lineTo(cx-5, cy);
                    ctx.closePath();
                }
                ctx.fill();
                ctx.stroke();

                // Points (F, 2F)
                ctx.fillStyle = '#fbbf24'; // Focus
                ctx.beginPath(); ctx.arc(cx + focal, cy, 4, 0, Math.PI*2); ctx.fill(); // F2
                ctx.beginPath(); ctx.arc(cx - focal, cy, 4, 0, Math.PI*2); ctx.fill(); // F1
                ctx.fillStyle = '#fff';
                ctx.fillText('F', cx + focal - 3, cy + 15);
                ctx.fillText('F\'', cx - focal - 3, cy + 15);

                // --- DRAW OBJECT ---
                const ox = cx + objDist;
                const oy = cy - h; // Up is negative Y in canvas
                
                ctx.strokeStyle = '#3b82f6'; // Blue Object
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(ox, cy); ctx.lineTo(ox, oy); ctx.stroke();
                // Arrowhead
                ctx.beginPath(); ctx.moveTo(ox-5, oy+5); ctx.lineTo(ox, oy); ctx.lineTo(ox+5, oy+5); ctx.stroke();

                // --- DRAW IMAGE ---
                const ix = cx + imgDist;
                const iy = cy - imgH;

                ctx.strokeStyle = imgDist > 0 ? '#10b981' : '#f43f5e'; // Green (Real), Red (Virtual)
                ctx.setLineDash(imgDist < 0 ? [5, 5] : []); // Dashed if virtual
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(ix, cy); ctx.lineTo(ix, iy); ctx.stroke();
                // Arrowhead
                ctx.beginPath(); 
                if (imgH > 0) { // Upright
                    ctx.moveTo(ix-5, iy+5); ctx.lineTo(ix, iy); ctx.lineTo(ix+5, iy+5);
                } else { // Inverted
                    ctx.moveTo(ix-5, iy-5); ctx.lineTo(ix, iy); ctx.lineTo(ix+5, iy-5);
                }
                ctx.stroke();
                ctx.setLineDash([]);

                // --- RAY TRACING (Simplified) ---
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#fbbf24'; // Ray Color
                ctx.globalAlpha = 0.6;

                // Ray 1: Parallel to Axis -> Refracts through Focus
                ctx.beginPath();
                ctx.moveTo(ox, oy); ctx.lineTo(cx, oy); // Incident
                // Refracted
                if (type === 'convex') {
                    // Goes to F2 (Right side)
                    // If image is virtual (on left), we calculate line equation or just extend
                    // For visualization, draw straight line passing through (cx, oy) and (cx+f, cy)
                    // Extend to image point
                    ctx.lineTo(ix, iy); 
                } else {
                    // Diverges as if from F1
                    ctx.lineTo(ix, iy);
                }
                ctx.stroke();

                // Ray 2: Through Optical Center (Undeviated)
                ctx.beginPath();
                ctx.moveTo(ox, oy); 
                ctx.lineTo(ix, iy); // Straight line
                ctx.stroke();

                ctx.globalAlpha = 1.0;

            }, [f, u, h, type]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Controls */}
                    <div className="w-64 bg-sg-surface border-r border-sg-border p-6 flex flex-col gap-6">
                        <h2 className="text-xl font-bold text-blue-400 flex items-center gap-2">
                            <i className="fas fa-glasses"></i> OpticsLab
                        </h2>

                        <div className="flex bg-white/5 rounded p-1">
                            <button onClick={() => setType('convex')} className={`flex-1 py-1 rounded text-xs uppercase font-bold ${type === 'convex' ? 'bg-blue-500 text-white' : 'text-gray-400'}`}>Convex</button>
                            <button onClick={() => setType('concave')} className={`flex-1 py-1 rounded text-xs uppercase font-bold ${type === 'concave' ? 'bg-blue-500 text-white' : 'text-gray-400'}`}>Concave</button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Focal Length (f)</span>
                                    <span>{f} cm</span>
                                </div>
                                <input 
                                    type="range" min="50" max="150" 
                                    value={f}
                                    onChange={e => setF(Number(e.target.value))}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Object Dist (u)</span>
                                    <span>{u} cm</span>
                                </div>
                                <input 
                                    type="range" min="50" max="300" 
                                    value={u}
                                    onChange={e => setU(Number(e.target.value))}
                                    className="w-full accent-green-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold text-gray-400 mb-1">
                                    <span>Object Height (h)</span>
                                    <span>{h} cm</span>
                                </div>
                                <input 
                                    type="range" min="20" max="80" 
                                    value={h}
                                    onChange={e => setH(Number(e.target.value))}
                                    className="w-full accent-orange-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        <div className="mt-auto bg-black/20 rounded-xl p-4 space-y-2 text-xs">
                            <div className="flex justify-between">
                                <span className="text-gray-400">Image Dist (v)</span>
                                <span className={`font-mono font-bold ${imgDist < 0 ? 'text-red-400' : 'text-green-400'}`}>
                                    {Math.abs(imgDist).toFixed(1)} cm
                                </span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Magnification (m)</span>
                                <span className="font-mono text-white">{Math.abs(m).toFixed(2)}x</span>
                            </div>
                            <div className="flex justify-between pt-2 border-t border-white/5 font-bold">
                                <span className="text-gray-400">Nature</span>
                                <span className={imgDist < 0 ? 'text-red-400' : 'text-green-400'}>
                                    {imgDist < 0 ? 'Virtual & Erect' : 'Real & Inverted'}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="flex-1 relative">
                        <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                    </div>
                </div>
            );
        };

        // --- REGISTER OPTICS APP ---
        APP_REGISTRY.optics = { id: 'optics', title: 'OpticsLab', icon: 'fa-glasses', color: '#0ea5e9', width: 800, height: 500 };
        
        /* PART 57 COMPLETE: OPTICS LAB READY */
        // ==================================================================================
        // 58. APP MODULE: GENETICGRID (Punnett Square)
        // ==================================================================================

        const GeneticApp = () => {
            const [p1, setP1] = React.useState('Tt'); // Parent 1
            const [p2, setP2] = React.useState('Tt'); // Parent 2
            const [trait, setTrait] = React.useState({ dom: 'Tall', rec: 'Short' });

            // --- GENETICS ENGINE ---
            const g1 = p1.split('');
            const g2 = p2.split('');
            
            // Generate Offspring
            const grid = [
                g1[0] + g2[0], g1[0] + g2[1],
                g1[1] + g2[0], g1[1] + g2[1]
            ].map(s => {
                // Normalize 'tT' to 'Tt' (Dominant first)
                return s.split('').sort().join('') === 'tT' ? 'Tt' : s.split('').sort().join('');
            });
            // Actually, sort puts Uppercase first in ASCII? No, 'T' (84) < 't' (116).
            // So standard sort() works for Tt.

            // Analysis
            const counts = {};
            grid.forEach(x => counts[x] = (counts[x] || 0) + 1);
            
            const phenotypes = { dom: 0, rec: 0 };
            grid.forEach(x => {
                if (x.includes('T')) phenotypes.dom++;
                else phenotypes.rec++;
            });

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden p-8 items-center justify-center">
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12 w-full max-w-4xl">
                        
                        {/* LEFT: INPUTS & STATS */}
                        <div className="space-y-8">
                            <div>
                                <h1 className="text-3xl font-bold font-serif text-green-400 mb-2">GeneticGrid</h1>
                                <p className="text-sm text-gray-400">Mendelian Cross Calculator</p>
                            </div>

                            <div className="flex gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Parent 1</label>
                                    <select value={p1} onChange={e => setP1(e.target.value)} className="bg-white/10 border border-white/10 rounded p-2 text-lg font-bold w-32 outline-none">
                                        <option value="TT">Homo Dom (TT)</option>
                                        <option value="Tt">Hetero (Tt)</option>
                                        <option value="tt">Homo Rec (tt)</option>
                                    </select>
                                </div>
                                <div className="flex items-center text-gray-500 font-bold">X</div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Parent 2</label>
                                    <select value={p2} onChange={e => setP2(e.target.value)} className="bg-white/10 border border-white/10 rounded p-2 text-lg font-bold w-32 outline-none">
                                        <option value="TT">Homo Dom (TT)</option>
                                        <option value="Tt">Hetero (Tt)</option>
                                        <option value="tt">Homo Rec (tt)</option>
                                    </select>
                                </div>
                            </div>

                            <div className="bg-white/5 rounded-xl p-6 border border-white/10">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-4">Results</h3>
                                
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-green-400 font-bold">Phenotype Ratio</span>
                                        <span className="font-mono text-xl">{phenotypes.dom} : {phenotypes.rec}</span>
                                    </div>
                                    <div className="text-sm text-gray-300">
                                        {((phenotypes.dom/4)*100)}% {trait.dom}, {((phenotypes.rec/4)*100)}% {trait.rec}
                                    </div>
                                    
                                    <div className="h-px bg-white/10 my-2"></div>

                                    <div className="flex justify-between items-center">
                                        <span className="text-blue-400 font-bold">Genotype Ratio</span>
                                        <div className="text-xs space-x-2">
                                            {Object.entries(counts).map(([geno, count]) => (
                                                <span key={geno} className="bg-black/20 px-2 py-1 rounded border border-white/5">
                                                    {geno}: {count*25}%
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: GRID VISUALIZER */}
                        <div className="flex flex-col items-center justify-center">
                            <div className="relative">
                                {/* Headers */}
                                <div className="absolute -top-8 left-0 w-full flex justify-around text-xl font-bold text-blue-400">
                                    <span>{g2[0]}</span><span>{g2[1]}</span>
                                </div>
                                <div className="absolute top-0 -left-8 h-full flex flex-col justify-around text-xl font-bold text-pink-400">
                                    <span>{g1[0]}</span><span>{g1[1]}</span>
                                </div>

                                {/* The Square */}
                                <div className="grid grid-cols-2 w-64 h-64 border-4 border-white/20 rounded-xl overflow-hidden shadow-2xl">
                                    {grid.map((geno, i) => {
                                        const isDom = geno.includes('T');
                                        return (
                                            <div 
                                                key={i} 
                                                className={`
                                                    flex items-center justify-center text-3xl font-bold border border-white/10 transition-colors
                                                    ${isDom ? 'bg-green-500/10 text-green-400' : 'bg-gray-500/10 text-gray-400'}
                                                `}
                                            >
                                                {geno}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="mt-8 text-center text-xs text-gray-500">
                                <span className="text-green-400 font-bold">T</span> = Dominant (Tall)<br/>
                                <span className="text-gray-400 font-bold">t</span> = Recessive (Short)
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- REGISTER GENETIC APP ---
        APP_REGISTRY.genetic = { id: 'genetic', title: 'GeneticGrid', icon: 'fa-dna', color: '#10b981', width: 800, height: 600 };
        
        /* PART 58 COMPLETE: GENETICGRID READY */
        // ==================================================================================
        // 59. APP MODULE: EQUATION BALANCER (Chemistry Solver)
        // ==================================================================================

        const BalanceApp = () => {
            const [input, setInput] = React.useState('H2 + O2 = H2O');
            const [result, setResult] = React.useState(null);

            const solve = () => {
                // Hardcoded DB for demonstration reliability in this simulated environment.
                // A full Gaussian solver in JS requires a heavy matrix library (math.js is included but setting up the matrix is complex).
                // We will use a lookup for common ISC/CBSE reactions + a heuristic parser.
                
                const db = {
                    'h2+o2=h2o': '2H₂ + O₂ → 2H₂O',
                    'n2+h2=nh3': 'N₂ + 3H₂ → 2NH₃',
                    'ch4+o2=co2+h2o': 'CH₄ + 2O₂ → CO₂ + 2H₂O',
                    'fe+o2=fe2o3': '4Fe + 3O₂ → 2Fe₂O₃',
                    'h2so4+naoh=na2so4+h2o': 'H₂SO₄ + 2NaOH → Na₂SO₄ + 2H₂O',
                    'c6h12o6+o2=co2+h2o': 'C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O',
                    'h2+cl2=hcl': 'H₂ + Cl₂ → 2HCl',
                    'mg+o2=mgo': '2Mg + O₂ → 2MgO',
                    'kclo3=kcl+o2': '2KClO₃ → 2KCl + 3O₂',
                    'al+o2=al2o3': '4Al + 3O₂ → 2Al₂O₃'
                };

                const clean = input.toLowerCase().replace(/\s/g, '');
                
                if (db[clean]) {
                    setResult({ success: true, eq: db[clean] });
                } else {
                    setResult({ success: false, msg: "Complex reaction or not in database. Try 'H2 + O2 = H2O'" });
                }
            };

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans p-8 items-center justify-center">
                    <div className="text-center mb-10">
                        <div className="w-20 h-20 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-purple-500/50 shadow-glow">
                            <i className="fas fa-scale-balanced text-4xl text-purple-400"></i>
                        </div>
                        <h1 className="text-3xl font-bold font-cyber">Balancer</h1>
                        <p className="text-sm text-gray-500">Chemical Equation Solver</p>
                    </div>

                    <div className="w-full max-w-xl space-y-6">
                        <div className="relative">
                            <input 
                                type="text" 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && solve()}
                                placeholder="e.g. CH4 + O2 = CO2 + H2O"
                                className="w-full bg-black/30 border border-white/20 rounded-2xl py-4 pl-6 pr-16 text-xl font-mono text-white outline-none focus:border-purple-500 transition-all shadow-inner"
                            />
                            <button 
                                onClick={solve}
                                className="absolute right-2 top-2 bottom-2 bg-purple-600 hover:bg-purple-500 text-white px-6 rounded-xl font-bold transition-all"
                            >
                                <i className="fas fa-arrow-right"></i>
                            </button>
                        </div>

                        {result && (
                            <div className={`p-6 rounded-2xl border ${result.success ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'} animate-slideUp`}>
                                {result.success ? (
                                    <div className="text-center">
                                        <div className="text-xs text-green-400 uppercase font-bold mb-2">Balanced Equation</div>
                                        <div className="text-2xl md:text-3xl font-bold font-serif text-white">
                                            {result.eq}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center text-red-400 font-bold">
                                        <i className="fas fa-circle-xmark mr-2"></i> {result.msg}
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex flex-wrap gap-2 justify-center mt-8">
                            {['N2 + H2 = NH3', 'Fe + O2 = Fe2O3', 'C6H12O6 + O2 = CO2 + H2O'].map(eq => (
                                <button 
                                    key={eq}
                                    onClick={() => setInput(eq)}
                                    className="px-3 py-1 bg-white/5 hover:bg-white/10 rounded-full text-[10px] text-gray-400 border border-white/5 transition-colors"
                                >
                                    {eq}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- REGISTER BALANCE APP ---
        APP_REGISTRY.balance = { id: 'balance', title: 'EquationBalancer', icon: 'fa-scale-balanced', color: '#a855f7', width: 600, height: 400 };
        
        /* PART 59 COMPLETE: BALANCER READY */
        // ==================================================================================
        // 12. APP MODULE: CODE STUDIO (Integrated Development Environment)
        // ==================================================================================

        const CodeApp = () => {
            const [activeFile, setActiveFile] = React.useState('index.html');
            const [files, setFiles] = React.useState({
                'index.html': `\n<div class="card">\n  <h1>Hello World</h1>\n  <p>Code is Poetry.</p>\n  <button onclick="alert('System Operational')">Click Me</button>\n</div>`,
                'style.css': `body { \n  background: #111; \n  color: #fff; \n  font-family: sans-serif; \n  display: flex; justify-content: center; align-items: center; height: 100vh; \n}\n.card {\n  background: linear-gradient(45deg, #3b82f6, #8b5cf6);\n  padding: 2rem;\n  border-radius: 1rem;\n  text-align: center;\n  box-shadow: 0 10px 30px rgba(0,0,0,0.5);\n}\nbutton {\n  background: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;\n}`,
                'script.js': `console.log("Environment Ready...");`
            });

            // --- COMPILER ENGINE ---
            const srcDoc = `
                <html>
                    <head>
                        <style>${files['style.css']}</style>
                    </head>
                    <body>
                        ${files['index.html']}
                        <script>
                            try {
                                ${files['script.js']}
                            } catch(err) { console.error(err); }
                        <\/script>
                    </body>
                </html>
            `;

            const Editor = ({ code, onChange, lang }) => {
                const lines = code.split('\n').length;
                return (
                    <div className="flex h-full font-mono text-sm overflow-hidden bg-[#1e1e1e] text-gray-300">
                        {/* Line Numbers */}
                        <div className="w-12 bg-[#252526] text-gray-600 text-right pr-3 pt-4 select-none border-r border-white/5 leading-6">
                            {Array.from({ length: lines }).map((_, i) => <div key={i}>{i + 1}</div>)}
                        </div>
                        {/* Text Area */}
                        <textarea
                            value={code}
                            onChange={(e) => onChange(e.target.value)}
                            spellCheck="false"
                            className="flex-1 bg-transparent border-none outline-none p-4 resize-none leading-6 text-gray-100 whitespace-pre custom-scroll"
                        />
                    </div>
                );
            };

            return (
                <div className="flex flex-col md:flex-row h-full bg-[#1e1e1e] text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: EDITOR PANE --- */}
                    <div className="flex-1 flex flex-col min-w-0 border-b md:border-b-0 md:border-r border-white/10">
                        {/* File Tabs */}
                        <div className="flex bg-[#252526] overflow-x-auto no-scrollbar">
                            {Object.keys(files).map(name => (
                                <button
                                    key={name}
                                    onClick={() => setActiveFile(name)}
                                    className={`
                                        px-4 py-2 text-xs flex items-center gap-2 border-r border-white/5 transition-colors whitespace-nowrap
                                        ${activeFile === name ? 'bg-[#1e1e1e] text-white border-t-2 border-t-brand-primary' : 'text-gray-500 hover:text-gray-300'}
                                    `}
                                >
                                    <i className={`
                                        ${name.endsWith('html') ? 'fab fa-html5 text-orange-500' : ''}
                                        ${name.endsWith('css') ? 'fab fa-css3-alt text-blue-500' : ''}
                                        ${name.endsWith('js') ? 'fab fa-js text-yellow-500' : ''}
                                    `}></i>
                                    {name}
                                </button>
                            ))}
                        </div>

                        {/* Editor Area */}
                        <div className="flex-1 relative">
                            <Editor 
                                code={files[activeFile]} 
                                onChange={(val) => setFiles({ ...files, [activeFile]: val })}
                            />
                            <div className="absolute bottom-2 right-4 text-[10px] text-gray-500 bg-black/50 px-2 rounded">
                                UTF-8 • {files[activeFile].length} chars
                            </div>
                        </div>
                    </div>

                    {/* --- RIGHT: PREVIEW PANE --- */}
                    <div className="h-1/2 md:h-full md:w-[40%] flex flex-col bg-white">
                        <div className="h-8 bg-gray-100 border-b border-gray-300 flex items-center px-3 justify-between">
                            <span className="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                Live Server
                            </span>
                            <i className="fas fa-rotate text-gray-400 text-xs cursor-pointer hover:text-black"></i>
                        </div>
                        <iframe 
                            srcDoc={srcDoc}
                            title="preview"
                            sandbox="allow-scripts"
                            className="flex-1 w-full border-none bg-white"
                        />
                    </div>

                </div>
            );
        };

        /* PART 12 COMPLETE: CODE STUDIO READY */
        // ==================================================================================
        // 13. APP MODULE: SETTINGS (System Configuration)
        // ==================================================================================

        const SettingsApp = () => {
            const { state, dispatch } = useOS();
            const [tab, setTab] = React.useState('system');

            const renderContent = () => {
                switch(tab) {
                    case 'system': return (
                        <div className="space-y-6 animate-fadeIn">
                            <div className="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/5">
                                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-brand-primary to-sci-purple flex items-center justify-center text-xl font-bold text-white shadow-glow">
                                    SK
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold">Shashank Kushwaha</h2>
                                    <p className="text-xs text-gray-400">Administrator • Local Account</p>
                                    <div className="mt-1 flex gap-2">
                                        <span className="px-2 py-0.5 bg-sci-green/20 text-sci-green text-[10px] rounded font-bold">ISC Student</span>
                                        <span className="px-2 py-0.5 bg-brand-primary/20 text-brand-primary text-[10px] rounded font-bold">Developer</span>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">OS Version</div>
                                    <div className="text-sm font-mono text-white">StudyGraphs v2.0</div>
                                </div>
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">Kernel</div>
                                    <div className="text-sm font-mono text-white">React-Fiber 18.2</div>
                                </div>
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5 col-span-2">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">Storage Status</div>
                                    <div className="w-full h-2 bg-gray-700 rounded-full mt-2 overflow-hidden">
                                        <div className="h-full bg-brand-primary w-[35%]"></div>
                                    </div>
                                    <div className="flex justify-between mt-1 text-[10px] text-gray-400">
                                        <span>Used: 350 MB</span>
                                        <span>Total: 1 GB (Local)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );

                    case 'display': return (
                        <div className="space-y-6 animate-fadeIn">
                            <div>
                                <h3 className="text-sm font-bold mb-3">Appearance</h3>
                                <div className="flex gap-4">
                                    <div className="flex-1 aspect-video bg-sg-bg border-2 border-brand-primary rounded-lg flex items-center justify-center relative overflow-hidden cursor-pointer">
                                        <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 to-transparent"></div>
                                        <span className="relative z-10 text-xs font-bold">Dark Mode</span>
                                        <div className="absolute bottom-2 right-2 text-brand-primary"><i className="fas fa-check-circle"></i></div>
                                    </div>
                                    <div className="flex-1 aspect-video bg-gray-100 border-2 border-transparent rounded-lg flex items-center justify-center opacity-50 cursor-not-allowed grayscale">
                                        <span className="text-xs font-bold text-black">Light Mode</span>
                                        <div className="absolute top-2 right-2 text-[10px] bg-yellow-500 text-black px-1 rounded font-bold">SOON</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 className="text-sm font-bold mb-3">Interface</h3>
                                <label className="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors">
                                    <span className="text-sm">Show Grid Lines</span>
                                    <div className="w-10 h-5 bg-brand-primary rounded-full relative">
                                        <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    );

                    case 'about': return (
                        <div className="text-center pt-8 animate-fadeIn">
                            <i className="fas fa-atom text-4xl text-brand-primary mb-4 animate-spin-slow"></i>
                            <h1 className="text-2xl font-bold font-sans">StudyGraphs India</h1>
                            <p className="text-xs text-gray-400 mt-2 max-w-xs mx-auto">
                                An advanced educational operating system simulation designed to assist STEM students with visualization and calculation.
                            </p>
                            <div className="mt-8 pt-8 border-t border-white/10 text-[10px] text-gray-600">
                                © 2026 Shashank Kushwaha<br/>
                                Built with React, Three.js, Matter.js, Plotly
                            </div>
                        </div>
                    );
                }
            };

            const menu = [
                { id: 'system', l: 'System', i: 'fa-server' },
                { id: 'display', l: 'Display', i: 'fa-desktop' },
                { id: 'about', l: 'About', i: 'fa-info-circle' }
            ];

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-48 bg-sg-surface border-r border-sg-border p-2 flex flex-col gap-1">
                        {menu.map(m => (
                            <button
                                key={m.id}
                                onClick={() => setTab(m.id)}
                                className={`
                                    w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-3 transition-colors
                                    ${tab === m.id ? 'bg-white/10 text-white font-bold' : 'text-gray-400 hover:bg-white/5'}
                                `}
                            >
                                <i className={`fas ${m.i} w-4 text-center`}></i>
                                {m.l}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        <div className="max-w-lg mx-auto">
                            <h1 className="text-2xl font-bold mb-6 capitalize">{tab} Settings</h1>
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 13 COMPLETE: SETTINGS READY */
        // ==================================================================================
       // ==================================================================================
        // 60. SYSTEM CORE: START MENU & TASKBAR INTEGRATION
        // ==================================================================================

        const StartMenu = ({ isOpen, onClose }) => {
            const { dispatch, APP_REGISTRY } = useOS();
            const [search, setSearch] = React.useState('');

            if (!isOpen) return null;

            const apps = Object.values(APP_REGISTRY).filter(app => 
                app.title.toLowerCase().includes(search.toLowerCase())
            );

            return (
                <div className="absolute bottom-16 left-4 z-[9999] w-[90vw] max-w-2xl bg-sg-surface/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slideUp origin-bottom-left">
                    {/* Search Bar */}
                    <div className="p-4 border-b border-white/5">
                        <div className="relative">
                            <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input 
                                type="text" 
                                autoFocus
                                placeholder="Search apps, files, or settings..." 
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                className="w-full bg-black/20 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white outline-none focus:border-brand-primary transition-all"
                            />
                        </div>
                    </div>

                    {/* App Grid */}
                    <div className="flex-1 p-6 overflow-y-auto max-h-[60vh] custom-scroll">
                        <div className="grid grid-cols-4 sm:grid-cols-6 gap-4">
                            {apps.map(app => (
                                <button
                                    key={app.id}
                                    onClick={() => { dispatch({ type: 'OPEN_APP', payload: app.id }); onClose(); }}
                                    className="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-white/10 transition-all group"
                                >
                                    <div 
                                        className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-lg transition-transform group-hover:scale-110"
                                        style={{ background: `linear-gradient(135deg, ${app.color}20, ${app.color}10)`, border: `1px solid ${app.color}40`, color: app.color }}
                                    >
                                        <i className={`fas ${app.icon}`}></i>
                                    </div>
                                    <span className="text-[10px] font-medium text-gray-300 group-hover:text-white text-center line-clamp-1 w-full">
                                        {app.title}
                                    </span>
                                </button>
                            ))}
                        </div>
                        {apps.length === 0 && (
                            <div className="text-center py-10 text-gray-500">
                                No apps found for "{search}"
                            </div>
                        )}
                    </div>

                    {/* Footer: User Profile */}
                    <div className="p-4 bg-black/20 border-t border-white/5 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold">SK</div>
                            <span className="text-sm font-bold">Shashank Kushwaha</span>
                        </div>
                        <button className="text-gray-400 hover:text-red-400 transition-colors" title="Shut Down">
                            <i className="fas fa-power-off"></i>
                        </button>
                    </div>
                </div>
            );
        };

        // --- UPDATED TASKBAR (Overrides Part 4) ---
        // We need to re-render the Taskbar to include the Start Menu logic
        const TaskbarV2 = () => {
            const { state, dispatch, APP_REGISTRY } = useOS();
            const [startOpen, setStartOpen] = React.useState(false);

            return (
                <>
                    <StartMenu isOpen={startOpen} onClose={() => setStartOpen(false)} />
                    
                    <div className="absolute bottom-0 left-0 right-0 h-12 bg-sg-surface/80 backdrop-blur-md border-t border-sg-border flex items-center justify-center px-4 z-[5000]">
                        <div className="flex items-center gap-2 h-full">
                            {/* Start Button */}
                            <button 
                                onClick={() => setStartOpen(!startOpen)}
                                className={`w-10 h-10 rounded-lg flex items-center justify-center transition-all ${startOpen ? 'bg-brand-primary text-white' : 'hover:bg-white/10 text-sci-blue'}`}
                            >
                                <i className="fab fa-windows text-xl"></i>
                            </button>

                            <div className="w-px h-6 bg-white/10 mx-2"></div>

                            {/* Pinned / Active Apps */}
                            {/* We show pinned apps + any open windows not pinned */}
                            {['graph', 'solver', 'periodic', 'code'].map(id => {
                                const isActive = state.windows.some(w => w.id === id);
                                const isFocused = state.activeWindow === state.windows.find(w => w.id === id)?.instanceId;
                                const app = APP_REGISTRY[id];
                                
                                return (
                                    <button
                                        key={id}
                                        onClick={() => {
                                            if (isActive) {
                                                const win = state.windows.find(w => w.id === id);
                                                if (win.minimized) dispatch({ type: 'RESTORE_WINDOW', payload: win.instanceId });
                                                else dispatch({ type: 'FOCUS_WINDOW', payload: win.instanceId });
                                            } else {
                                                dispatch({ type: 'OPEN_APP', payload: id });
                                            }
                                        }}
                                        className={`
                                            relative w-10 h-10 rounded-lg flex items-center justify-center transition-all group
                                            ${isActive ? 'bg-white/5' : 'hover:bg-white/5'}
                                        `}
                                    >
                                        <i className={`fas ${app.icon} text-lg transition-transform group-hover:-translate-y-1`} style={{ color: app.color }}></i>
                                        {isActive && (
                                            <div className={`absolute bottom-0.5 w-1.5 h-1.5 rounded-full ${isFocused ? 'bg-brand-primary w-4' : 'bg-gray-400'} transition-all`}></div>
                                        )}
                                        {/* Tooltip */}
                                        <div className="absolute bottom-full mb-2 bg-black/80 px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-white/10">
                                            {app.title}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>

                        {/* System Tray */}
                        <div className="absolute right-4 flex items-center gap-4 text-xs text-white/80">
                            <div className="hidden sm:flex items-center gap-2">
                                <i className="fas fa-wifi"></i>
                                <i className="fas fa-volume-high"></i>
                                <i className="fas fa-battery-three-quarters"></i>
                            </div>
                            <div className="text-right">
                                <div className="font-bold">{new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                <div className="text-[10px] opacity-60">{new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // --- FINAL RENDER OVERRIDE ---
        // Add this BEFORE 'const RootApp = ...'
const BootScreen = ({ onComplete }) => {
    React.useEffect(() => {
        // Simulate a 2-second boot sequence
        const timer = setTimeout(onComplete, 2000);
        return () => clearTimeout(timer);
    }, [onComplete]);

    return (
        <div className="flex items-center justify-center h-full w-full bg-black text-white flex-col gap-4">
            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div className="text-xl font-mono animate-pulse">System Booting...</div>
        </div>
    );
};
        // ADD THIS COMPONENT
const BootScreen = ({ onComplete }) => {
    React.useEffect(() => {
        const timer = setTimeout(onComplete, 2000);
        return () => clearTimeout(timer);
    }, [onComplete]);

    return (
        <div className="flex items-center justify-center h-full w-full bg-black text-white flex-col gap-4">
            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div className="text-xl font-mono animate-pulse">System Booting...</div>
        </div>
    );
};
        const RootApp = () => {
            const [booted, setBooted] = React.useState(false);
            
            // On mount, check if user has visited before (simulate persistence)
            React.useEffect(() => {
                // Pre-load assets or check local storage here
            }, []);

            if (!booted) return <BootScreen onComplete={() => setBooted(true)} />;

            return (
                <OSProvider>
                    <div className="relative w-full h-full text-white select-none overflow-hidden bg-black">
                        <Desktop />
                        {/* Use the V2 Taskbar with Start Menu */}
                        <TaskbarV2 />
                        <DynamicWindowRenderer />
                    </div>
                </OSProvider>
            );
        };

        // Mount
        const rootNode = document.getElementById('root');
    const root = ReactDOM.createRoot(rootNode);
    root.render(<RootApp />);
</script>
</body>
</html>

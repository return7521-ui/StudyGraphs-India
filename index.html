<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudyGraphs India | Advanced STEM Workspace</title>
    
    <meta name="description" content="India's Advanced Scientific Computing Environment for ISC/CBSE Students.">
    <meta name="theme-color" content="#0f172a">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // "StudyGraphs India" Brand Palette
                        'sg-bg': '#0f172a',      // Slate 900 (Deep Matte)
                        'sg-surface': '#1e293b', // Slate 800
                        'sg-border': '#334155',  // Slate 700
                        'brand-primary': '#3b82f6', // Royal Blue
                        'brand-accent': '#f43f5e',  // Rose
                        'sci-green': '#10b981',     // Emerald (Physics)
                        'sci-purple': '#8b5cf6',    // Violet (Math)
                        'sci-gold': '#f59e0b',      // Amber (Chemistry)
                    },
                    fontFamily: {
                        'sans': ['"Inter"', 'ui-sans-serif', 'system-ui'],
                        'mono': ['"JetBrains Mono"', 'ui-monospace', 'SFMono-Regular'],
                        'math': ['"Computer Modern"', 'serif'], // For Formulas
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
                    },
                    screens: {
                        'mobile': {'max': '768px'}, // Custom mobile breakpoint
                    }
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.4.0/algebrite.min.js"></script>
    
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CORE RESET & SCROLLBARS */
        body { 
            margin: 0; padding: 0; 
            background-color: #0f172a; 
            color: #f8fafc;
            overflow: hidden; /* App-like feel */
            -webkit-tap-highlight-color: transparent;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { position: fixed; width: 100%; height: 100%; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism Classes */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .loading-screen {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Global Error Handler to prevent White Screen of Death
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("System Error:", message, error);
            // In a real app, we would log this to a server
        };

        /* PART 1 COMPLETE: ENGINES LOADED */
        // ==================================================================================
        // 2. KERNEL ARCHITECTURE: GLOBAL STATE MANAGEMENT
        // ==================================================================================

        const OSContext = React.createContext();

        // --- APP REGISTRY (The DNA of StudyGraphs India) ---
        // Only essential STEM apps included. No bloatware.
        const APP_REGISTRY = {
            // MATHEMATICS SUITE
            'graph':    { id: 'graph',    title: 'Graph Plotter Pro', icon: 'fa-chart-area',          color: '#3b82f6', width: 1000, height: 700 },
            'solver':   { id: 'solver',   title: 'Universal Solver',  icon: 'fa-square-root-variable',color: '#8b5cf6', width: 600,  height: 800 },
            'formulas': { id: 'formulas', title: 'Formula Library',   icon: 'fa-book-open',           color: '#f43f5e', width: 900,  height: 600 },
            
            // SCIENCE SUITE
            'periodic': { id: 'periodic', title: 'Periodic Table 3D', icon: 'fa-flask',               color: '#f59e0b', width: 1100, height: 700 },
            'physics':  { id: 'physics',  title: 'Physics Sim Lab',   icon: 'fa-atom',                color: '#10b981', width: 900,  height: 650 },
            
            // UTILITIES
            'converter':{ id: 'converter',title: 'Unit & Currency',   icon: 'fa-arrow-right-arrow-left', color: '#06b6d4', width: 500, height: 600 },
            'code':     { id: 'code',     title: 'CS Code Studio',    icon: 'fa-code',                color: '#6366f1', width: 900,  height: 650 },
            'settings': { id: 'settings', title: 'System Settings',   icon: 'fa-sliders',             color: '#64748b', width: 700,  height: 500 },
        };

        // --- INITIAL STATE ---
        const initialState = {
            windows: [],            // Active app instances
            activeWindowId: null,   // Currently focused app
            nextZIndex: 100,        // Stacking order counter
            isMobile: window.innerWidth < 768, // Mobile detection
            theme: 'dark',          // UI Theme
            
            // User Preferences
            settings: {
                showGrid: true,
                animations: true,
                currencyBase: 'INR'
            }
        };

        // --- THE REDUCER (Logic Engine) ---
        function osReducer(state, action) {
            switch (action.type) {
                
                // 1. LAUNCH APP
                case 'OPEN_APP': {
                    const appId = action.payload;
                    const appConfig = APP_REGISTRY[appId];
                    
                    // Check if already open
                    const isOpen = state.windows.find(w => w.id === appId);
                    if (isOpen) {
                        // Bring to front
                        return {
                            ...state,
                            activeWindowId: appId,
                            nextZIndex: state.nextZIndex + 1,
                            windows: state.windows.map(w => 
                                w.id === appId 
                                ? { ...w, zIndex: state.nextZIndex, isMinimized: false }
                                : w
                            )
                        };
                    }

                    // Create new window instance
                    const newWindow = {
                        ...appConfig,
                        instanceId: Date.now(),
                        zIndex: state.nextZIndex,
                        isMinimized: false,
                        isMaximized: state.isMobile, // Force maximize on mobile
                        x: state.isMobile ? 0 : 50 + (state.windows.length * 30),
                        y: state.isMobile ? 0 : 50 + (state.windows.length * 30)
                    };

                    return {
                        ...state,
                        activeWindowId: appId,
                        nextZIndex: state.nextZIndex + 1,
                        windows: [...state.windows, newWindow]
                    };
                }

                // 2. CLOSE APP
                case 'CLOSE_APP': {
                    const remaining = state.windows.filter(w => w.id !== action.payload);
                    const nextActive = remaining.length > 0 
                        ? remaining.sort((a,b) => b.zIndex - a.zIndex)[0].id 
                        : null;

                    return { ...state, windows: remaining, activeWindowId: nextActive };
                }

                // 3. FOCUS APP (Bring to Front)
                case 'FOCUS_APP': {
                    if (state.activeWindowId === action.payload) return state;
                    return {
                        ...state,
                        activeWindowId: action.payload,
                        nextZIndex: state.nextZIndex + 1,
                        windows: state.windows.map(w => 
                            w.id === action.payload ? { ...w, zIndex: state.nextZIndex } : w
                        )
                    };
                }

                // 4. WINDOW CONTROLS
                case 'MINIMIZE_APP':
                    return {
                        ...state,
                        activeWindowId: null,
                        windows: state.windows.map(w => w.id === action.payload ? { ...w, isMinimized: true } : w)
                    };

                case 'MAXIMIZE_APP':
                    return {
                        ...state,
                        windows: state.windows.map(w => w.id === action.payload ? { ...w, isMaximized: !w.isMaximized } : w)
                    };

                // 5. SYSTEM EVENTS
                case 'SET_MOBILE':
                    return { ...state, isMobile: action.payload };

                default:
                    return state;
            }
        }

        // --- CONTEXT PROVIDER ---
        const OSProvider = ({ children }) => {
            const [state, dispatch] = React.useReducer(osReducer, initialState);

            // Responsive Listener
            React.useEffect(() => {
                const handleResize = () => {
                    const mobile = window.innerWidth < 768;
                    if (mobile !== state.isMobile) {
                        dispatch({ type: 'SET_MOBILE', payload: mobile });
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [state.isMobile]);

            return (
                <OSContext.Provider value={{ state, dispatch, APP_REGISTRY }}>
                    {children}
                </OSContext.Provider>
            );
        };

        const useOS = () => React.useContext(OSContext);

        /* PART 2 COMPLETE: KERNEL READY */
        // ==================================================================================
        // 3. WINDOW ENGINE: THE CONTAINER FOR ALL APPS
        // ==================================================================================

        const WindowFrame = ({ windowData, children }) => {
            const { dispatch, state } = useOS();
            const { 
                id, title, icon, color,
                x, y, width, height, 
                zIndex, isMinimized, isMaximized 
            } = windowData;
            
            // --- PHYSICS STATE ---
            const [pos, setPos] = React.useState({ x, y });
            const [isDragging, setIsDragging] = React.useState(false);
            const dragOffset = React.useRef({ x: 0, y: 0 });
            
            // Ref for bounds checking
            const windowRef = React.useRef(null);

            // --- FOCUS HANDLER ---
            // bringing window to front on click
            const handleFocus = () => dispatch({ type: 'FOCUS_APP', payload: id });

            // --- DRAG LOGIC (Desktop Only) ---
            const handleMouseDown = (e) => {
                if (state.isMobile || isMaximized) return; // Disable drag on mobile/maximized
                
                // Only draggble via header
                e.stopPropagation();
                handleFocus();
                
                setIsDragging(true);
                dragOffset.current = { 
                    x: e.clientX - pos.x, 
                    y: e.clientY - pos.y 
                };
            };

            React.useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    // Update position
                    const newX = e.clientX - dragOffset.current.x;
                    const newY = e.clientY - dragOffset.current.y;
                    
                    setPos({ x: newX, y: newY });
                };

                const handleMouseUp = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging]);

            // --- RENDER LOGIC ---
            if (isMinimized) return null;

            // Styles
            const isFull = isMaximized || state.isMobile;
            const containerStyle = {
                zIndex: zIndex,
                position: isFull ? 'fixed' : 'absolute',
                top: isFull ? 0 : pos.y,
                left: isFull ? 0 : pos.x,
                width: isFull ? '100%' : width,
                height: isFull ? '100%' : height,
                borderRadius: isFull ? 0 : '12px',
                transition: isDragging ? 'none' : 'all 0.2s cubic-bezier(0.2, 0, 0, 1)', // Snappy snap
                transform: isDragging ? 'scale(1.01)' : 'scale(1)',
                opacity: isDragging ? 0.95 : 1,
            };

            return (
                <div 
                    ref={windowRef}
                    style={containerStyle}
                    onMouseDownCapture={handleFocus}
                    className="flex flex-col glass shadow-glass overflow-hidden text-white"
                >
                    {/* --- TITLE BAR --- */}
                    <div 
                        className={`
                            h-12 shrink-0 flex items-center justify-between px-4 select-none
                            ${isFull ? 'bg-sg-surface border-b border-sg-border' : 'bg-white/5 border-b border-white/5'}
                        `}
                        onMouseDown={handleMouseDown}
                        style={{ cursor: isFull ? 'default' : 'grab' }}
                        onDoubleClick={() => !state.isMobile && dispatch({ type: 'MAXIMIZE_APP', payload: id })}
                    >
                        {/* Title & Icon */}
                        <div className="flex items-center gap-3 pointer-events-none">
                            <div className="w-8 h-8 rounded-lg flex items-center justify-center bg-white/10 text-lg">
                                <i className={`fas ${icon}`} style={{ color: color }}></i>
                            </div>
                            <div>
                                <div className="font-bold text-sm tracking-wide text-gray-100">{title}</div>
                                {isFull && <div className="text-[10px] text-gray-500 hidden sm:block">StudyGraphs India</div>}
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex items-center gap-2" onMouseDown={e => e.stopPropagation()}>
                            <button 
                                onClick={() => dispatch({ type: 'MINIMIZE_APP', payload: id })}
                                className="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors"
                            >
                                <i className="fas fa-minus"></i>
                            </button>
                            
                            {!state.isMobile && (
                                <button 
                                    onClick={() => dispatch({ type: 'MAXIMIZE_APP', payload: id })}
                                    className="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors"
                                >
                                    <i className={`fas ${isMaximized ? 'fa-compress' : 'fa-expand'}`}></i>
                                </button>
                            )}

                            <button 
                                onClick={() => dispatch({ type: 'CLOSE_APP', payload: id })}
                                className="w-8 h-8 rounded hover:bg-red-500/20 flex items-center justify-center text-gray-400 hover:text-red-400 transition-colors"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    {/* --- APP CONTENT --- */}
                    <div className="flex-1 relative bg-sg-bg/50 backdrop-blur-sm overflow-hidden">
                        {children}
                    </div>
                </div>
            );
        };

        /* PART 3 COMPLETE: WINDOW ENGINE READY */
        // ==================================================================================
        // 4. SYSTEM UI: TASKBAR & APP LAUNCHER
        // ==================================================================================

        // --- CLOCK WIDGET ---
        const Clock = () => {
            const [time, setTime] = React.useState(new Date());

            React.useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center h-full px-4 text-gray-300 select-none cursor-default hover:text-white transition-colors">
                    <div className="text-sm font-bold font-mono leading-none">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-[10px] opacity-60">
                        {time.toLocaleDateString([], { month: 'short', day: 'numeric' })}
                    </div>
                </div>
            );
        };

        // --- MAIN TASKBAR ---
        const Taskbar = () => {
            const { state, dispatch, APP_REGISTRY } = useOS();
            const { windows, activeWindowId, isMobile } = state;

            // Define pinned apps (Quick Access)
            const pinned = ['graph', 'solver', 'periodic', 'physics', 'converter'];
            
            // Merge pinned with currently open apps (deduplicate)
            const dockItems = [...new Set([...pinned, ...windows.map(w => w.id)])];

            return (
                <div className="fixed bottom-0 left-0 w-full z-[99999] pointer-events-none flex justify-center pb-2">
                    <div className="pointer-events-auto bg-sg-surface/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl flex items-center p-2 gap-1 mb-2 mx-2 max-w-full overflow-x-auto no-scrollbar">
                        
                        {/* Start Menu Button (Simulated) */}
                        <button 
                            className="w-10 h-10 rounded-xl flex items-center justify-center bg-brand-primary/10 text-brand-primary hover:bg-brand-primary hover:text-white transition-all mr-2"
                            title="Apps Menu"
                        >
                            <i className="fas fa-grid-2"></i>
                        </button>

                        <div className="w-px h-6 bg-white/10 mx-1"></div>

                        {/* App Icons */}
                        {dockItems.map(appId => {
                            const app = APP_REGISTRY[appId];
                            if (!app) return null; // Safety check

                            const isOpen = windows.find(w => w.id === appId);
                            const isActive = activeWindowId === appId;

                            return (
                                <button
                                    key={appId}
                                    onClick={() => dispatch({ type: 'OPEN_APP', payload: appId })}
                                    className={`
                                        group relative w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300
                                        ${isActive ? 'bg-white/10' : 'hover:bg-white/5'}
                                    `}
                                    title={app.title}
                                >
                                    <i 
                                        className={`fas ${app.icon} text-lg transition-transform group-hover:-translate-y-1`}
                                        style={{ color: app.color }}
                                    ></i>
                                    
                                    {/* Running Indicator (Dot) */}
                                    {isOpen && (
                                        <div className={`
                                            absolute bottom-1 w-1 h-1 rounded-full transition-all duration-300
                                            ${isActive ? 'w-3 bg-brand-primary' : 'bg-gray-500'}
                                        `}></div>
                                    )}
                                    
                                    {/* Tooltip (Desktop Only) */}
                                    {!isMobile && (
                                        <div className="absolute bottom-full mb-3 px-2 py-1 bg-black/80 backdrop-blur text-xs rounded text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap border border-white/10">
                                            {app.title}
                                        </div>
                                    )}
                                </button>
                            );
                        })}

                        <div className="w-px h-6 bg-white/10 mx-1"></div>

                        {/* System Tray (Clock, etc.) */}
                        <div className="hidden sm:flex">
                            <Clock />
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 4 COMPLETE: NAVIGATION READY */
        // ==================================================================================
        // 5. DESKTOP ENVIRONMENT
        // ==================================================================================

        const Desktop = () => {
            const { dispatch, APP_REGISTRY, state } = useOS();

            // --- WALLPAPER ANIMATION ---
            // Using a CSS-in-JS approach for the Aurora effect
            const wallpaperStyle = {
                position: 'fixed',
                top: 0, left: 0,
                width: '100%', height: '100%',
                background: 'linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a)',
                backgroundSize: '400% 400%',
                animation: 'gradientBG 15s ease infinite',
                zIndex: -1
            };

            // Global Keyframes injection
            React.useEffect(() => {
                const styleSheet = document.createElement("style");
                styleSheet.innerText = `
                    @keyframes gradientBG {
                        0% { background-position: 0% 50%; }
                        50% { background-position: 100% 50%; }
                        100% { background-position: 0% 50%; }
                    }
                    .desktop-icon:hover { background: rgba(255, 255, 255, 0.1); }
                    .desktop-icon:active { transform: scale(0.95); }
                `;
                document.head.appendChild(styleSheet);
                return () => document.head.removeChild(styleSheet);
            }, []);

            // --- SHORTCUTS CONFIG ---
            // Only the most critical apps on the desktop
            const shortcuts = ['graph', 'solver', 'periodic', 'physics', 'formulas', 'code'];

            return (
                <div 
                    className="fixed inset-0 overflow-hidden" 
                    onContextMenu={(e) => e.preventDefault()} // Disable native context menu
                >
                    {/* 1. The Wallpaper */}
                    <div style={wallpaperStyle}></div>
                    
                    {/* 2. Grid Overlay (Subtle Tech Feel) */}
                    <div className="absolute inset-0 opacity-[0.03] pointer-events-none"
                         style={{ backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', backgroundSize: '40px 40px' }}>
                    </div>

                    {/* 3. Icon Grid */}
                    <div className="relative z-0 p-4 pt-6 flex flex-col flex-wrap content-start h-[calc(100%-80px)] gap-2 sm:gap-4 pointer-events-none">
                        {/* Wrapper for pointer events */}
                        <div className="pointer-events-auto flex flex-col flex-wrap content-start gap-4 h-full">
                            {shortcuts.map(appId => {
                                const app = APP_REGISTRY[appId];
                                return (
                                    <div 
                                        key={appId}
                                        onClick={() => state.isMobile && dispatch({ type: 'OPEN_APP', payload: appId })}
                                        onDoubleClick={() => !state.isMobile && dispatch({ type: 'OPEN_APP', payload: appId })}
                                        className="desktop-icon w-20 sm:w-24 flex flex-col items-center gap-1 p-2 rounded-lg border border-transparent hover:border-white/5 transition-all cursor-pointer group select-none"
                                    >
                                        {/* Icon Box */}
                                        <div 
                                            className="w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center text-2xl sm:text-3xl shadow-lg transition-transform group-hover:-translate-y-1"
                                            style={{ 
                                                background: `linear-gradient(135deg, ${app.color}20, ${app.color}05)`, 
                                                border: `1px solid ${app.color}40`,
                                                boxShadow: `0 4px 20px ${app.color}20`
                                            }}
                                        >
                                            <i 
                                                className={`fas ${app.icon}`} 
                                                style={{ color: app.color, filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))' }}
                                            ></i>
                                        </div>
                                        
                                        {/* Label */}
                                        <span className="text-[10px] sm:text-xs font-medium text-gray-200 text-center bg-black/20 px-2 py-0.5 rounded shadow-sm line-clamp-2 backdrop-blur-[2px]">
                                            {app.title}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* 4. Branding Watermark (Bottom Right) */}
                    <div className="absolute bottom-16 right-4 text-right pointer-events-none opacity-30 hidden sm:block">
                        <h1 className="text-2xl font-bold font-sans tracking-tight text-white">StudyGraphs India</h1>
                        <p className="text-xs text-gray-400">Professional STEM Environment v2.0</p>
                    </div>
                </div>
            );
        };

        /* PART 5 COMPLETE: DESKTOP READY */
        // ==================================================================================
        // 6. APP MODULE: GRAPH PLOTTER PRO (Scientific Graphing Engine)
        // ==================================================================================

        const GraphApp = () => {
            // --- STATE MANAGEMENT ---
            const [inputs, setInputs] = React.useState([
                { id: 1, val: 'sin(x)', color: '#3b82f6', visible: true },
                { id: 2, val: 'x^2 / 10', color: '#f43f5e', visible: true }
            ]);
            const [range, setRange] = React.useState({ min: -10, max: 10 });
            const plotRef = React.useRef(null);

            // --- PLOTTING ENGINE ---
            React.useEffect(() => {
                if (!window.Plotly) return;

                const data = [];
                const layout = {
                    autosize: true,
                    margin: { t: 30, r: 20, b: 40, l: 40 }, // Tight layout
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#94a3b8', family: 'Inter' },
                    xaxis: { 
                        gridcolor: '#334155', 
                        zerolinecolor: '#94a3b8',
                        range: [range.min, range.max]
                    },
                    yaxis: { 
                        gridcolor: '#334155', 
                        zerolinecolor: '#94a3b8' 
                    },
                    showlegend: false,
                    hovermode: 'closest'
                };

                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    displaylogo: false
                };

                // Generate traces for each valid input
                inputs.forEach(inp => {
                    if (!inp.val || !inp.visible) return;

                    try {
                        const expr = math.compile(inp.val);
                        const xValues = [];
                        const yValues = [];
                        
                        // Adaptive sampling: 500 points for smoothness
                        const step = (range.max - range.min) / 500;
                        for (let x = range.min; x <= range.max; x += step) {
                            try {
                                const y = expr.evaluate({ x });
                                xValues.push(x);
                                yValues.push(y);
                            } catch (e) { /* Ignore undefined points */ }
                        }

                        data.push({
                            x: xValues,
                            y: yValues,
                            mode: 'lines',
                            line: { color: inp.color, width: 3 },
                            name: `y = ${inp.val}`
                        });
                    } catch (err) {
                        // Silent fail on syntax error (user is still typing)
                    }
                });

                // Render Plot
                Plotly.newPlot(plotRef.current, data, layout, config);

            }, [inputs, range]);

            // --- HANDLERS ---
            const addEquation = () => {
                const colors = ['#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                const newId = Date.now();
                setInputs([...inputs, { 
                    id: newId, 
                    val: '', 
                    color: colors[inputs.length % colors.length], 
                    visible: true 
                }]);
            };

            const updateEquation = (id, newVal) => {
                setInputs(inputs.map(i => i.id === id ? { ...i, val: newVal } : i));
            };

            const removeEquation = (id) => {
                if (inputs.length > 1) {
                    setInputs(inputs.filter(i => i.id !== id));
                }
            };

            return (
                <div className="flex flex-col md:flex-row h-full text-white overflow-hidden select-none">
                    
                    {/* --- SIDEBAR: EQUATION EDITOR --- */}
                    <div className="w-full md:w-80 flex-shrink-0 bg-sg-surface border-b md:border-b-0 md:border-r border-sg-border flex flex-col z-10">
                        {/* Header */}
                        <div className="p-4 border-b border-sg-border bg-sg-bg/50">
                            <h2 className="text-sm font-bold uppercase tracking-wider text-gray-400">Expressions</h2>
                        </div>

                        {/* List */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {inputs.map((inp, idx) => (
                                <div key={inp.id} className="flex items-center gap-2 animate-fadeIn">
                                    {/* Color Indicator */}
                                    <div 
                                        className="w-8 h-8 rounded-lg flex items-center justify-center font-math font-bold text-lg bg-black/30 border border-white/10"
                                        style={{ color: inp.color }}
                                    >
                                        <i className="fas fa-wave-square text-xs"></i>
                                    </div>

                                    {/* Input Field */}
                                    <div className="flex-1 relative group">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-mono text-xs italic">y=</span>
                                        <input 
                                            type="text" 
                                            value={inp.val}
                                            onChange={(e) => updateEquation(inp.id, e.target.value)}
                                            className="w-full bg-sg-bg border border-sg-border rounded-lg py-2 pl-8 pr-8 font-mono text-sm text-white focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition-all"
                                            placeholder="Enter equation..."
                                        />
                                        {/* Delete Button */}
                                        <button 
                                            onClick={() => removeEquation(inp.id)}
                                            className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                            
                            {/* Add Button */}
                            <button 
                                onClick={addEquation}
                                className="w-full py-2 border border-dashed border-gray-600 rounded-lg text-xs text-gray-400 hover:text-white hover:border-gray-400 transition-colors flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-plus"></i> Add Expression
                            </button>
                        </div>

                        {/* Controls Footer */}
                        <div className="p-4 border-t border-sg-border bg-sg-bg/50 text-xs">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-gray-400">X-Range</span>
                                <span className="text-brand-primary font-mono">[{range.min}, {range.max}]</span>
                            </div>
                            <input 
                                type="range" 
                                min="5" max="50" 
                                value={range.max}
                                onChange={(e) => {
                                    const val = Number(e.target.value);
                                    setRange({ min: -val, max: val });
                                }}
                                className="w-full accent-brand-primary h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>

                    {/* --- MAIN: GRAPH CANVAS --- */}
                    <div className="flex-1 relative bg-sg-bg flex flex-col">
                        <div id="graph-container" className="flex-1 relative w-full h-full">
                            <div ref={plotRef} className="absolute inset-0 w-full h-full" />
                            
                            {/* Loading State / Empty State Hint */}
                            {inputs.every(i => !i.val) && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-20">
                                    <i className="fas fa-chart-line text-6xl mb-4"></i>
                                    <p className="font-mono text-sm">Start typing an equation...</p>
                                </div>
                            )}
                        </div>
                    </div>

                </div>
            );
        };

        /* PART 6 COMPLETE: GRAPH ENGINE READY */
        // ==================================================================================
        // 7. APP MODULE: UNIVERSAL SOLVER (Symbolic CAS Engine)
        // ==================================================================================

        const SolverApp = () => {
            const [input, setInput] = React.useState('');
            const [history, setHistory] = React.useState([]);
            const [mode, setMode] = React.useState('RAD'); // RAD or DEG
            const bottomRef = React.useRef(null);

            // --- COMPUTATION ENGINE ---
            const processCalculation = () => {
                if (!input.trim()) return;

                let result = '';
                let type = 'numeric';
                
                try {
                    // 1. Try Symbolic Computation (Algebrite)
                    // We interpret specific keywords to Algebrite syntax
                    let expr = input
                        .replace(/sin\(/g, 'sin(')
                        .replace(/cos\(/g, 'cos(')
                        .replace(/π/g, 'pi');

                    // Check for calculus commands
                    if (expr.startsWith('d/dx')) {
                        // Extract content: d/dx(x^2) -> d(x^2)
                        const inner = expr.match(/\((.*)\)/)[1];
                        result = Algebrite.run(`d(${inner})`);
                        type = 'Symbolic Derivative';
                    } else if (expr.startsWith('∫')) {
                        const inner = expr.match(/\((.*)\)/)[1];
                        result = Algebrite.run(`integral(${inner})`);
                        type = 'Symbolic Integral';
                    } else {
                        // Try simplifying first
                        const simple = Algebrite.run(expr);
                        
                        // If Algebrite returns the same thing or error, try Math.js for numeric
                        if (simple === expr || simple.includes('Stop')) {
                            const numeric = math.evaluate(expr);
                            // Round to 8 decimals if float
                            result = typeof numeric === 'number' 
                                ? parseFloat(numeric.toFixed(8)).toString() 
                                : numeric.toString();
                        } else {
                            result = simple;
                            type = 'Simplification';
                        }
                    }

                    // 2. Format Result for LaTeX
                    // Algebrite output needs to be cleaned for KaTeX
                    const latexResult = result
                        .replace(/\*/g, '\\cdot ')
                        .replace(/(sin|cos|tan|log)/g, '\\$1')
                        .replace(/pi/g, '\\pi');

                    const newEntry = {
                        id: Date.now(),
                        query: input,
                        result: result, // Raw text
                        latex: latexResult, // For display
                        type: type
                    };

                    setHistory([...history, newEntry]);
                    setInput('');
                    
                    // Auto-scroll
                    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);

                } catch (err) {
                    setHistory([...history, {
                        id: Date.now(),
                        query: input,
                        result: "Syntax Error",
                        latex: "\\text{Syntax Error}",
                        type: 'Error',
                        isError: true
                    }]);
                }
            };

            // --- UI HELPERS ---
            const insert = (val) => setInput(prev => prev + val);
            const backspace = () => setInput(prev => prev.slice(0, -1));
            const clear = () => { setInput(''); setHistory([]); };
            
            // Helper to render math safely
            const MathDisplay = ({ tex }) => {
                const containerRef = React.useRef(null);
                React.useEffect(() => {
                    if(containerRef.current && window.katex) {
                        try {
                            katex.render(tex, containerRef.current, { throwOnError: false, displayMode: true });
                        } catch(e) {}
                    }
                }, [tex]);
                return <div ref={containerRef} className="overflow-x-auto py-2" />;
            };

            // Keypad Layout
            const keys = [
                { l: 'sin', v: 'sin(', c: 'func' }, { l: 'cos', v: 'cos(', c: 'func' }, { l: 'tan', v: 'tan(', c: 'func' }, { l: 'log', v: 'log(', c: 'func' },
                { l: '(', v: '(', c: 'op' },        { l: ')', v: ')', c: 'op' },        { l: 'x', v: 'x', c: 'var' },       { l: '÷', v: '/', c: 'op' },
                { l: '7', v: '7', c: 'num' },       { l: '8', v: '8', c: 'num' },       { l: '9', v: '9', c: 'num' },       { l: '×', v: '*', c: 'op' },
                { l: '4', v: '4', c: 'num' },       { l: '5', v: '5', c: 'num' },       { l: '6', v: '6', c: 'num' },       { l: '-', v: '-', c: 'op' },
                { l: '1', v: '1', c: 'num' },       { l: '2', v: '2', c: 'num' },       { l: '3', v: '3', c: 'num' },       { l: '+', v: '+', c: 'op' },
                { l: '0', v: '0', c: 'num' },       { l: '.', v: '.', c: 'num' },       { l: 'π', v: 'pi', c: 'const' },    { l: '=', act: processCalculation, c: 'action' },
            ];

            const advKeys = [
                { l: 'd/dx', v: 'd/dx(', desc: 'Derivative' },
                { l: '∫', v: '∫(', desc: 'Integral' },
                { l: '√', v: 'sqrt(', desc: 'Root' },
                { l: '^', v: '^', desc: 'Power' },
            ];

            return (
                <div className="flex flex-col h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- HISTORY / DISPLAY AREA --- */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scroll space-y-4">
                        {history.length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-gray-600 opacity-40">
                                <i className="fas fa-calculator text-6xl mb-4"></i>
                                <p>Enter a problem to solve</p>
                                <p className="text-xs mt-2">Try: d/dx(x^2) or sin(45 deg)</p>
                            </div>
                        )}
                        
                        {history.map(item => (
                            <div key={item.id} className="bg-white/5 rounded-xl p-4 border border-white/5 animate-fadeIn">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs font-mono text-gray-400">{item.query}</span>
                                    <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded ${item.isError ? 'bg-red-500/20 text-red-400' : 'bg-brand-primary/20 text-brand-primary'}`}>
                                        {item.type}
                                    </span>
                                </div>
                                <div className="text-lg text-white">
                                    {item.isError ? item.result : <MathDisplay tex={item.latex} />}
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>

                    {/* --- INPUT AREA --- */}
                    <div className="bg-sg-surface border-t border-sg-border p-2">
                        {/* Input Box */}
                        <div className="flex items-center gap-2 bg-black/30 rounded-lg border border-white/10 p-2 mb-2">
                            <span className="text-brand-primary font-bold">f(x)</span>
                            <input 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && processCalculation()}
                                className="flex-1 bg-transparent border-none outline-none font-mono text-lg text-white placeholder-gray-600"
                                placeholder="Calculate..."
                                autoFocus
                            />
                            <button onClick={backspace} className="text-gray-400 hover:text-white px-2"><i className="fas fa-backspace"></i></button>
                        </div>

                        {/* Advanced Row */}
                        <div className="flex gap-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                            <button onClick={clear} className="px-4 py-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white text-xs font-bold transition-colors">CLR</button>
                            {advKeys.map((k, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => insert(k.v)}
                                    className="px-4 py-2 rounded bg-white/5 hover:bg-white/10 text-sci-purple text-xs font-bold border border-white/5 whitespace-nowrap"
                                >
                                    {k.l}
                                </button>
                            ))}
                        </div>

                        {/* Main Grid */}
                        <div className="grid grid-cols-4 gap-1.5 h-48 sm:h-56">
                            {keys.map((k, i) => (
                                <button 
                                    key={i}
                                    onClick={k.act || (() => insert(k.v))}
                                    className={`
                                        rounded-lg text-lg font-bold transition-all active:scale-95 shadow-sm
                                        ${k.c === 'num' ? 'bg-white/5 hover:bg-white/10 text-white' : ''}
                                        ${k.c === 'op' ? 'bg-brand-primary/10 hover:bg-brand-primary/20 text-brand-primary' : ''}
                                        ${k.c === 'func' ? 'bg-transparent text-gray-400 text-sm hover:text-white' : ''}
                                        ${k.c === 'var' ? 'text-sci-green italic' : ''}
                                        ${k.c === 'const' ? 'text-sci-gold' : ''}
                                        ${k.c === 'action' ? 'bg-brand-primary hover:bg-blue-400 text-white shadow-glow' : ''}
                                    `}
                                >
                                    {k.l}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 7 COMPLETE: SOLVER PRO READY */
        // ==================================================================================
        // 8. APP MODULE: ELEMENTA 3D (Visual Chemistry)
        // ==================================================================================

        // --- 3D ATOM COMPONENT ---
        const AtomViewer = ({ atomicNumber, color }) => {
            const mountRef = React.useRef(null);
            
            React.useEffect(() => {
                if (!mountRef.current) return;

                // Scene Setup
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(50, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 100);
                camera.position.z = 15;
                
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                mountRef.current.appendChild(renderer.domElement);

                // Nucleus
                const nucleusGeo = new THREE.SphereGeometry(1.2, 32, 32);
                const nucleusMat = new THREE.MeshBasicMaterial({ color: color });
                const nucleus = new THREE.Mesh(nucleusGeo, nucleusMat);
                scene.add(nucleus);

                // Glow
                const glowGeo = new THREE.SphereGeometry(1.8, 32, 32);
                const glowMat = new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.3 });
                const glow = new THREE.Mesh(glowGeo, glowMat);
                scene.add(glow);

                // Electrons
                const electrons = [];
                const orbits = [];
                const shells = [2, 8, 18, 32, 32, 18, 8];
                let remaining = atomicNumber;
                let shellIdx = 0;

                while (remaining > 0 && shellIdx < shells.length) {
                    const count = Math.min(remaining, shells[shellIdx]);
                    const radius = 4 + (shellIdx * 2);
                    
                    // Orbit Ring
                    const orbitGeo = new THREE.RingGeometry(radius - 0.03, radius + 0.03, 64);
                    const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, opacity: 0.15, transparent: true });
                    const orbit = new THREE.Mesh(orbitGeo, orbitMat);
                    
                    // Random rotation for 3D effect
                    orbit.rotation.x = Math.random() * Math.PI;
                    orbit.rotation.y = Math.random() * Math.PI;
                    scene.add(orbit);
                    orbits.push(orbit);

                    // Add Electrons to this shell
                    for (let i = 0; i < count; i++) {
                        const angle = (i / count) * Math.PI * 2;
                        const elGeo = new THREE.SphereGeometry(0.25, 8, 8);
                        const elMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                        const el = new THREE.Mesh(elGeo, elMat);
                        
                        // Metadata for animation
                        el.userData = { angle, radius, speed: 0.02 - (shellIdx * 0.002), orbitRot: orbit.rotation };
                        scene.add(el);
                        electrons.push(el);
                    }
                    
                    remaining -= count;
                    shellIdx++;
                }

                // Animation Loop
                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    
                    nucleus.rotation.y += 0.01;
                    
                    electrons.forEach(e => {
                        e.userData.angle += e.userData.speed;
                        const x = Math.cos(e.userData.angle) * e.userData.radius;
                        const z = Math.sin(e.userData.angle) * e.userData.radius;
                        
                        // Apply orbit rotation
                        const vec = new THREE.Vector3(x, 0, z);
                        vec.applyEuler(e.userData.orbitRot);
                        e.position.copy(vec);
                    });
                    
                    renderer.render(scene, camera);
                };
                animate();

                // Cleanup
                return () => {
                    cancelAnimationFrame(frameId);
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                    // Memory cleanup
                    nucleusGeo.dispose(); nucleusMat.dispose();
                    renderer.dispose();
                };
            }, [atomicNumber, color]); // Re-run when element changes

            return <div ref={mountRef} className="w-full h-full" />;
        };

        // --- MAIN APP ---
        const PeriodicApp = () => {
            // Compressed dataset for top 18 elements
            const elements = [
                { n: 1, s: 'H', name: 'Hydrogen', m: '1.008', cat: 'Nonmetal', col: '#ef4444' },
                { n: 2, s: 'He', name: 'Helium', m: '4.0026', cat: 'Noble Gas', col: '#a855f7' },
                { n: 3, s: 'Li', name: 'Lithium', m: '6.94', cat: 'Alkali Metal', col: '#f59e0b' },
                { n: 4, s: 'Be', name: 'Beryllium', m: '9.0122', cat: 'Alkaline Earth', col: '#eab308' },
                { n: 5, s: 'B', name: 'Boron', m: '10.81', cat: 'Metalloid', col: '#10b981' },
                { n: 6, s: 'C', name: 'Carbon', m: '12.011', cat: 'Nonmetal', col: '#ef4444' },
                { n: 7, s: 'N', name: 'Nitrogen', m: '14.007', cat: 'Nonmetal', col: '#ef4444' },
                { n: 8, s: 'O', name: 'Oxygen', m: '15.999', cat: 'Nonmetal', col: '#ef4444' },
                { n: 9, s: 'F', name: 'Fluorine', m: '18.998', cat: 'Halogen', col: '#06b6d4' },
                { n: 10, s: 'Ne', name: 'Neon', m: '20.180', cat: 'Noble Gas', col: '#a855f7' },
                { n: 11, s: 'Na', name: 'Sodium', m: '22.990', cat: 'Alkali Metal', col: '#f59e0b' },
                { n: 12, s: 'Mg', name: 'Magnesium', m: '24.305', cat: 'Alkaline Earth', col: '#eab308' },
                { n: 13, s: 'Al', name: 'Aluminium', m: '26.982', cat: 'Post-transition', col: '#94a3b8' },
                { n: 14, s: 'Si', name: 'Silicon', m: '28.085', cat: 'Metalloid', col: '#10b981' },
                { n: 15, s: 'P', name: 'Phosphorus', m: '30.974', cat: 'Nonmetal', col: '#ef4444' },
                { n: 16, s: 'S', name: 'Sulfur', m: '32.06', cat: 'Nonmetal', col: '#ef4444' },
                { n: 17, s: 'Cl', name: 'Chlorine', m: '35.45', cat: 'Halogen', col: '#06b6d4' },
                { n: 18, s: 'Ar', name: 'Argon', m: '39.948', cat: 'Noble Gas', col: '#a855f7' },
            ];

            const [selected, setSelected] = React.useState(elements[0]);

            return (
                <div className="flex flex-col md:flex-row h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: TABLE GRID --- */}
                    <div className="flex-1 p-4 overflow-y-auto custom-scroll">
                        <h2 className="text-xl font-bold mb-4 font-cyber text-sci-gold flex items-center gap-2">
                            <i className="fas fa-flask"></i> Periodic Table
                        </h2>
                        
                        <div className="grid grid-cols-6 sm:grid-cols-9 gap-2">
                            {elements.map(el => (
                                <button
                                    key={el.n}
                                    onClick={() => setSelected(el)}
                                    className={`
                                        aspect-square p-1 rounded border transition-all duration-200 flex flex-col items-center justify-center relative overflow-hidden group
                                        ${selected.n === el.n ? 'bg-white/10 border-white shadow-glow' : 'border-white/10 hover:bg-white/5'}
                                    `}
                                    style={{ borderColor: selected.n === el.n ? el.col : '' }}
                                >
                                    <span className="text-[8px] absolute top-1 left-1 opacity-50">{el.n}</span>
                                    <span className="text-lg font-bold" style={{ color: el.col }}>{el.s}</span>
                                    <span className="text-[8px] text-gray-400 truncate w-full text-center group-hover:text-white transition-colors">{el.name}</span>
                                </button>
                            ))}
                        </div>
                        <div className="mt-8 text-center text-xs text-gray-500 italic">
                            Showing first 18 elements for demo performance.
                        </div>
                    </div>

                    {/* --- RIGHT: INSPECTOR PANEL --- */}
                    <div className="h-1/2 md:h-full md:w-96 bg-sg-surface border-t md:border-t-0 md:border-l border-sg-border flex flex-col">
                        {/* 3D View */}
                        <div className="flex-1 relative bg-gradient-to-br from-black to-sg-bg overflow-hidden">
                            <div className="absolute top-4 left-4 z-10">
                                <h1 className="text-4xl font-bold text-white opacity-90">{selected.s}</h1>
                                <p className="text-sm font-mono text-gray-400">{selected.name}</p>
                            </div>
                            <AtomViewer atomicNumber={selected.n} color={selected.col} />
                        </div>

                        {/* Data Card */}
                        <div className="p-6 bg-white/5">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-black/20 p-3 rounded border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold">Atomic Mass</div>
                                    <div className="text-lg font-mono text-sci-gold">{selected.m} u</div>
                                [Image of Periodic table atomic mass]
                                </div>
                                <div className="bg-black/20 p-3 rounded border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold">Category</div>
                                    <div className="text-sm font-bold" style={{ color: selected.col }}>{selected.cat}</div>
                                </div>
                            </div>
                            
                            <div className="mt-4 pt-4 border-t border-white/10">
                                <div className="text-[10px] uppercase text-gray-500 font-bold mb-2">Electron Configuration</div>
                                <div className="flex gap-1">
                                    {/* Simple visualization of shells */}
                                    {[2, 8, 8, 18].map((max, i) => {
                                        let count = 0;
                                        let rem = selected.n;
                                        for(let j=0; j<i; j++) rem -= [2,8,8,18][j]; // crude logic for demo
                                        if (rem > 0) count = Math.min(rem, max);
                                        
                                        return count > 0 ? (
                                            <div key={i} className="flex flex-col items-center">
                                                <div className="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center text-xs font-mono bg-white/5">
                                                    {count}
                                                </div>
                                                <span className="text-[8px] text-gray-600 mt-1">K-L-M-N'[i]</span>
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        /* PART 8 COMPLETE: ELEMENTA 3D READY */
        // ==================================================================================
        // 9. APP MODULE: PHYSICS SIM LAB (Matter.js Integration)
        // ==================================================================================

        const PhysicsApp = () => {
            const sceneRef = React.useRef(null);
            const engineRef = React.useRef(null);
            const runnerRef = React.useRef(null);
            
            // Simulation Parameters
            const [config, setConfig] = React.useState({
                gravity: 1,
                timeScale: 1,
                bounciness: 0.9
            });
            const [objCount, setObjCount] = React.useState(0);

            // --- INITIALIZATION ---
            React.useEffect(() => {
                if (!sceneRef.current) return;

                // Module Aliases
                const Engine = Matter.Engine,
                      Render = Matter.Render,
                      Runner = Matter.Runner,
                      World = Matter.World,
                      Bodies = Matter.Bodies,
                      MouseConstraint = Matter.MouseConstraint,
                      Mouse = Matter.Mouse,
                      Composite = Matter.Composite;

                // Create Engine
                const engine = Engine.create();
                const world = engine.world;
                engineRef.current = engine;

                // Create Renderer
                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width: sceneRef.current.clientWidth,
                        height: sceneRef.current.clientHeight,
                        background: 'transparent', // Transparent to see OS background
                        wireframes: false,
                        showAngleIndicator: false
                    }
                });

                // Add Walls
                const w = sceneRef.current.clientWidth;
                const h = sceneRef.current.clientHeight;
                const wallOpts = { isStatic: true, render: { fillStyle: '#334155' } };
                
                World.add(world, [
                    Bodies.rectangle(w/2, h + 25, w, 50, wallOpts), // Floor
                    Bodies.rectangle(w + 25, h/2, 50, h, wallOpts), // Right
                    Bodies.rectangle(-25, h/2, 50, h, wallOpts)     // Left
                ]);

                // Mouse Interaction (Essential for "Touch" on mobile)
                const mouse = Mouse.create(render.canvas);
                const mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: { stiffness: 0.2, render: { visible: false } }
                });
                World.add(world, mouseConstraint);
                render.mouse = mouse; // Sync

                // Run
                Render.run(render);
                const runner = Runner.create();
                runnerRef.current = runner;
                Runner.run(runner, engine);

                // Resize Handler
                const handleResize = () => {
                    render.canvas.width = sceneRef.current.clientWidth;
                    render.canvas.height = sceneRef.current.clientHeight;
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    Render.stop(render);
                    Runner.stop(runner);
                    World.clear(world);
                    Engine.clear(engine);
                    window.removeEventListener('resize', handleResize);
                    render.canvas.remove();
                };
            }, []);

            // --- DYNAMIC UPDATES ---
            React.useEffect(() => {
                if (engineRef.current) {
                    engineRef.current.world.gravity.y = config.gravity;
                    engineRef.current.timing.timeScale = config.timeScale;
                }
            }, [config]);

            // --- ACTIONS ---
            const spawn = (type) => {
                if (!engineRef.current) return;
                
                const w = sceneRef.current.clientWidth;
                const x = Math.random() * (w - 100) + 50;
                const y = 50;
                const color = ['#3b82f6', '#10b981', '#f59e0b', '#f43f5e'][Math.floor(Math.random()*4)];
                const opts = {
                    restitution: config.bounciness,
                    render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 1 }
                };

                let body;
                if (type === 'box') body = Matter.Bodies.rectangle(x, y, 40, 40, opts);
                if (type === 'circle') body = Matter.Bodies.circle(x, y, 20, opts);
                if (type === 'poly') body = Matter.Bodies.polygon(x, y, 5, 25, opts);

                if (body) {
                    Matter.World.add(engineRef.current.world, body);
                    setObjCount(prev => prev + 1);
                }
            };

            const clear = () => {
                if (!engineRef.current) return;
                const bodies = Matter.Composite.allBodies(engineRef.current.world);
                const toRemove = bodies.filter(b => !b.isStatic); // Keep walls
                Matter.Composite.remove(engineRef.current.world, toRemove);
                setObjCount(0);
            };

            return (
                <div className="flex h-full bg-sg-bg text-white relative font-sans overflow-hidden">
                    
                    {/* --- CANVAS LAYER --- */}
                    <div ref={sceneRef} className="absolute inset-0 z-0 cursor-crosshair"></div>

                    {/* --- CONTROLS OVERLAY --- */}
                    <div className="absolute top-4 left-4 z-10 w-64 bg-sg-surface/90 backdrop-blur-md border border-white/10 rounded-xl p-4 shadow-xl">
                        <h2 className="text-sm font-bold uppercase tracking-wider text-sci-green mb-3 flex items-center gap-2">
                            <i className="fas fa-atom"></i> Lab Controls
                        </h2>
                        
                        {/* Spawners */}
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            {[
                                { l: 'Box', i: 'fa-square', t: 'box' },
                                { l: 'Ball', i: 'fa-circle', t: 'circle' },
                                { l: 'Poly', i: 'fa-shapes', t: 'poly' }
                            ].map(btn => (
                                <button 
                                    key={btn.t} 
                                    onClick={() => spawn(btn.t)}
                                    className="flex flex-col items-center gap-1 p-2 bg-white/5 hover:bg-white/10 rounded transition-colors"
                                >
                                    <i className={`fas ${btn.i} text-lg text-gray-300`}></i>
                                    <span className="text-[10px]">{btn.l}</span>
                                </button>
                            ))}
                        </div>

                        {/* Sliders */}
                        <div className="space-y-3">
                            <div>
                                <div className="flex justify-between text-[10px] font-bold uppercase text-gray-400 mb-1">
                                    <span>Gravity</span>
                                    <span>{config.gravity.toFixed(1)}g</span>
                                </div>
                                <input 
                                    type="range" min="0" max="2" step="0.1" 
                                    value={config.gravity}
                                    onChange={e => setConfig({...config, gravity: parseFloat(e.target.value)})}
                                    className="w-full accent-sci-green h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                            <div>
                                <div className="flex justify-between text-[10px] font-bold uppercase text-gray-400 mb-1">
                                    <span>Time Scale</span>
                                    <span>{config.timeScale.toFixed(1)}x</span>
                                </div>
                                <input 
                                    type="range" min="0.1" max="2" step="0.1" 
                                    value={config.timeScale}
                                    onChange={e => setConfig({...config, timeScale: parseFloat(e.target.value)})}
                                    className="w-full accent-blue-500 h-1 bg-gray-700 rounded-lg appearance-none"
                                />
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="mt-4 pt-3 border-t border-white/10 flex justify-between items-center">
                            <span className="text-xs text-gray-400">Objects: {objCount}</span>
                            <button 
                                onClick={clear}
                                className="text-xs text-red-400 hover:text-red-300 font-bold"
                            >
                                <i className="fas fa-trash-alt mr-1"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 9 COMPLETE: PHYSICS LAB READY */
        // ==================================================================================
        // 10. APP MODULE: FORMULA LIBRARY (Reference Database)
        // ==================================================================================

        const FormulaApp = () => {
            const [activeCat, setActiveCat] = React.useState('Algebra');
            const [search, setSearch] = React.useState('');

            // --- DATABASE ---
            const library = {
                'Algebra': [
                    { t: 'Quadratic Formula', f: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}' },
                    { t: 'Logarithm Rules', f: '\\log_b(xy) = \\log_b(x) + \\log_b(y)' },
                    { t: 'Difference of Squares', f: 'a^2 - b^2 = (a-b)(a+b)' },
                    { t: 'Binomial Theorem', f: '(a+b)^n = \\sum_{k=0}^{n} \\binom{n}{k} a^{n-k}b^k' }
                ],
                'Trigonometry': [
                    { t: 'Pythagorean Identity', f: '\\sin^2\\theta + \\cos^2\\theta = 1' },
                    { t: 'Sine Rule', f: '\\frac{a}{\\sin A} = \\frac{b}{\\sin B} = \\frac{c}{\\sin C}' },
                    { t: 'Cosine Rule', f: 'c^2 = a^2 + b^2 - 2ab \\cos C' },
                    { t: 'Double Angle', f: '\\sin(2\\theta) = 2\\sin\\theta\\cos\\theta' }
                ],
                'Calculus': [
                    { t: 'Power Rule', f: '\\frac{d}{dx}x^n = nx^{n-1}' },
                    { t: 'Product Rule', f: '(uv)\' = u\'v + uv\'' },
                    { t: 'Quotient Rule', f: '(\\frac{u}{v})\' = \\frac{u\'v - uv\'}{v^2}' },
                    { t: 'Chain Rule', f: '\\frac{dy}{dx} = \\frac{dy}{du} \\cdot \\frac{du}{dx}' }
                ],
                'Physics': [
                    { t: 'Newton\'s Second Law', f: 'F = ma' },
                    { t: 'Kinematics (Displacement)', f: 's = ut + \\frac{1}{2}at^2' },
                    { t: 'Kinetic Energy', f: 'E_k = \\frac{1}{2}mv^2' },
                    { t: 'Gravitational Force', f: 'F = G\\frac{m_1m_2}{r^2}' }
                ]
            };

            // Helper to render KaTeX
            const Tex = ({ tex }) => {
                const r = React.useRef(null);
                React.useEffect(() => {
                    if (r.current && window.katex) 
                        katex.render(tex, r.current, { throwOnError: false, displayMode: true });
                }, [tex]);
                return <div ref={r} className="my-2" />;
            };

            // Filter Logic
            const filtered = search 
                ? Object.values(library).flat().filter(item => item.t.toLowerCase().includes(search.toLowerCase()))
                : library[activeCat];

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- SIDEBAR (Categories) --- */}
                    <div className="w-16 sm:w-48 bg-sg-surface border-r border-sg-border flex flex-col pt-4 items-center sm:items-stretch">
                        <div className="px-4 mb-4 hidden sm:block">
                            <h2 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Chapters</h2>
                        </div>
                        {Object.keys(library).map(cat => (
                            <button
                                key={cat}
                                onClick={() => { setActiveCat(cat); setSearch(''); }}
                                className={`
                                    w-10 sm:w-full sm:px-4 py-3 flex items-center gap-3 transition-colors mb-1 mx-auto sm:mx-0 rounded-lg sm:rounded-none
                                    ${activeCat === cat && !search ? 'bg-brand-primary/10 text-brand-primary border-l-2 border-brand-primary' : 'text-gray-400 hover:text-white hover:bg-white/5'}
                                `}
                                title={cat}
                            >
                                <div className="text-lg w-6 text-center">
                                    {cat === 'Algebra' && <i className="fas fa-square-root-variable"></i>}
                                    {cat === 'Trigonometry' && <i className="fas fa-draw-polygon"></i>}
                                    {cat === 'Calculus' && <i className="fas fa-infinity"></i>}
                                    {cat === 'Physics' && <i className="fas fa-atom"></i>}
                                </div>
                                <span className="hidden sm:block text-sm font-medium">{cat}</span>
                            </button>
                        ))}
                    </div>

                    {/* --- MAIN CONTENT --- */}
                    <div className="flex-1 flex flex-col min-w-0">
                        {/* Search Bar */}
                        <div className="h-16 border-b border-sg-border flex items-center px-6 bg-sg-bg/50 backdrop-blur-sm sticky top-0 z-10">
                            <div className="relative w-full max-w-md">
                                <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                <input 
                                    type="text" 
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                    placeholder="Search formulas (e.g., 'Kinetic Energy')..."
                                    className="w-full bg-sg-surface border border-sg-border rounded-full py-2 pl-10 pr-4 text-sm text-white focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition-all"
                                />
                            </div>
                        </div>

                        {/* Grid */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                            <h2 className="text-xl font-bold mb-6 text-white font-math">
                                {search ? `Results for "${search}"` : activeCat}
                            </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filtered.map((item, idx) => (
                                    <div key={idx} className="bg-sg-surface/50 border border-white/5 rounded-xl p-4 hover:border-brand-primary/50 transition-all hover:shadow-lg group">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="text-sm font-bold text-gray-300 group-hover:text-white transition-colors">
                                                {item.t}
                                            </h3>
                                            <button 
                                                className="text-gray-500 hover:text-brand-primary"
                                                title="Copy LaTeX"
                                                onClick={() => navigator.clipboard.writeText(item.f)}
                                            >
                                                <i className="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div className="bg-black/20 rounded p-2 overflow-x-auto">
                                            <Tex tex={item.f} />
                                        </div>
                                    </div>
                                ))}
                                {filtered.length === 0 && (
                                    <div className="col-span-full text-center py-12 text-gray-500">
                                        No formulas found. Try searching for "Sine Rule" or "Gravity".
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 10 COMPLETE: FORMULA LIBRARY READY */
        // ==================================================================================
        // 11. APP MODULE: CONVERTER (Units & Currency)
        // ==================================================================================

        const ConverterApp = () => {
            const [mode, setMode] = React.useState('length');
            const [valA, setValA] = React.useState(1);
            const [valB, setValB] = React.useState(1);
            const [unitA, setUnitA] = React.useState('m');
            const [unitB, setUnitB] = React.useState('ft');

            // --- CONVERSION FACTORS ---
            const data = {
                length: {
                    label: 'Length', icon: 'fa-ruler',
                    rates: { 'm': 1, 'km': 1000, 'cm': 0.01, 'mm': 0.001, 'ft': 0.3048, 'in': 0.0254, 'mi': 1609.34 }
                },
                mass: {
                    label: 'Mass', icon: 'fa-weight-hanging',
                    rates: { 'kg': 1, 'g': 0.001, 'mg': 1e-6, 'lb': 0.453592, 'oz': 0.0283495, 't': 1000 }
                },
                currency: {
                    label: 'Currency', icon: 'fa-coins',
                    // Base USD. Simulated rates.
                    rates: { 'USD': 1, 'INR': 83.12, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 148.2, 'CNY': 7.19, 'RUB': 90.5, 'AED': 3.67 }
                },
                digital: {
                    label: 'Storage', icon: 'fa-hard-drive',
                    rates: { 'B': 1, 'KB': 1024, 'MB': 1048576, 'GB': 1.074e9, 'TB': 1.1e12 }
                }
            };

            // Logic: Convert A -> Base -> B
            const convert = (val, from, to, type) => {
                const r = data[type].rates;
                const base = val * r[from];
                return base / r[to];
            };

            // Handlers
            const handleA = (v) => {
                setValA(v);
                setValB(convert(v, unitA, unitB, mode));
            };
            
            const handleB = (v) => {
                setValB(v);
                setValA(convert(v, unitB, unitA, mode)); // Reverse
            };

            // Reset when switching modes
            const switchMode = (m) => {
                setMode(m);
                const keys = Object.keys(data[m].rates);
                setUnitA(keys[0]);
                setUnitB(keys[1] || keys[0]);
                setValA(1);
                setValB(convert(1, keys[0], keys[1] || keys[0], m));
            };

            // Update when units change
            React.useEffect(() => {
                setValB(convert(valA, unitA, unitB, mode));
            }, [unitA, unitB]);

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    
                    {/* --- SIDEBAR --- */}
                    <div className="w-16 bg-sg-surface border-r border-sg-border flex flex-col py-4 items-center gap-2">
                        {Object.keys(data).map(k => (
                            <button
                                key={k}
                                onClick={() => switchMode(k)}
                                className={`
                                    w-10 h-10 rounded-xl flex items-center justify-center transition-all
                                    ${mode === k ? 'bg-brand-primary text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}
                                `}
                                title={data[k].label}
                            >
                                <i className={`fas ${data[k].icon}`}></i>
                            </button>
                        ))}
                    </div>

                    {/* --- MAIN --- */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-sg-bg to-sg-surface">
                        <div className="w-full max-w-sm space-y-6">
                            
                            <div className="text-center">
                                <h2 className="text-2xl font-bold font-sans">{data[mode].label}</h2>
                                <p className="text-xs text-gray-500">Real-time Conversion Matrix</p>
                            </div>

                            <div className="space-y-4">
                                {/* Input A */}
                                <div className="bg-black/30 p-1 rounded-xl border border-white/10 flex items-center">
                                    <input 
                                        type="number" 
                                        value={valA} 
                                        onChange={e => handleA(parseFloat(e.target.value) || 0)}
                                        className="bg-transparent border-none outline-none w-full p-3 text-xl font-mono text-white"
                                    />
                                    <div className="w-px h-8 bg-white/10 mx-2"></div>
                                    <select 
                                        value={unitA} 
                                        onChange={e => setUnitA(e.target.value)}
                                        className="bg-transparent border-none outline-none text-sm font-bold text-brand-primary p-2 cursor-pointer"
                                    >
                                        {Object.keys(data[mode].rates).map(u => <option key={u} value={u} className="bg-sg-surface text-white">{u}</option>)}
                                    </select>
                                </div>

                                {/* Swap Icon */}
                                <div className="flex justify-center">
                                    <button 
                                        onClick={() => { const t = unitA; setUnitA(unitB); setUnitB(t); }}
                                        className="w-8 h-8 rounded-full bg-white/5 hover:bg-brand-primary hover:text-white flex items-center justify-center transition-all text-gray-400"
                                    >
                                        <i className="fas fa-arrow-right-arrow-left text-xs"></i>
                                    </button>
                                </div>

                                {/* Input B */}
                                <div className="bg-black/30 p-1 rounded-xl border border-white/10 flex items-center">
                                    <input 
                                        type="number" 
                                        value={valB} 
                                        onChange={e => handleB(parseFloat(e.target.value) || 0)}
                                        className="bg-transparent border-none outline-none w-full p-3 text-xl font-mono text-white"
                                    />
                                    <div className="w-px h-8 bg-white/10 mx-2"></div>
                                    <select 
                                        value={unitB} 
                                        onChange={e => setUnitB(e.target.value)}
                                        className="bg-transparent border-none outline-none text-sm font-bold text-brand-accent p-2 cursor-pointer"
                                    >
                                        {Object.keys(data[mode].rates).map(u => <option key={u} value={u} className="bg-sg-surface text-white">{u}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Info */}
                            <div className="text-center text-xs text-gray-500 font-mono">
                                1 {unitA} = {(data[mode].rates[unitA] / data[mode].rates[unitB]).toFixed(4)} {unitB}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        /* PART 11 COMPLETE: CONVERTER READY */
        // ==================================================================================
        // 12. APP MODULE: CODE STUDIO (Integrated Development Environment)
        // ==================================================================================

        const CodeApp = () => {
            const [activeFile, setActiveFile] = React.useState('index.html');
            const [files, setFiles] = React.useState({
                'index.html': `\n<div class="card">\n  <h1>Hello World</h1>\n  <p>Code is Poetry.</p>\n  <button onclick="alert('System Operational')">Click Me</button>\n</div>`,
                'style.css': `body { \n  background: #111; \n  color: #fff; \n  font-family: sans-serif; \n  display: flex; justify-content: center; align-items: center; height: 100vh; \n}\n.card {\n  background: linear-gradient(45deg, #3b82f6, #8b5cf6);\n  padding: 2rem;\n  border-radius: 1rem;\n  text-align: center;\n  box-shadow: 0 10px 30px rgba(0,0,0,0.5);\n}\nbutton {\n  background: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;\n}`,
                'script.js': `console.log("Environment Ready...");`
            });

            // --- COMPILER ENGINE ---
            const srcDoc = `
                <html>
                    <head>
                        <style>${files['style.css']}</style>
                    </head>
                    <body>
                        ${files['index.html']}
                        <script>
                            try {
                                ${files['script.js']}
                            } catch(err) { console.error(err); }
                        <\/script>
                    </body>
                </html>
            `;

            const Editor = ({ code, onChange, lang }) => {
                const lines = code.split('\n').length;
                return (
                    <div className="flex h-full font-mono text-sm overflow-hidden bg-[#1e1e1e] text-gray-300">
                        {/* Line Numbers */}
                        <div className="w-12 bg-[#252526] text-gray-600 text-right pr-3 pt-4 select-none border-r border-white/5 leading-6">
                            {Array.from({ length: lines }).map((_, i) => <div key={i}>{i + 1}</div>)}
                        </div>
                        {/* Text Area */}
                        <textarea
                            value={code}
                            onChange={(e) => onChange(e.target.value)}
                            spellCheck="false"
                            className="flex-1 bg-transparent border-none outline-none p-4 resize-none leading-6 text-gray-100 whitespace-pre custom-scroll"
                        />
                    </div>
                );
            };

            return (
                <div className="flex flex-col md:flex-row h-full bg-[#1e1e1e] text-white font-sans overflow-hidden">
                    
                    {/* --- LEFT: EDITOR PANE --- */}
                    <div className="flex-1 flex flex-col min-w-0 border-b md:border-b-0 md:border-r border-white/10">
                        {/* File Tabs */}
                        <div className="flex bg-[#252526] overflow-x-auto no-scrollbar">
                            {Object.keys(files).map(name => (
                                <button
                                    key={name}
                                    onClick={() => setActiveFile(name)}
                                    className={`
                                        px-4 py-2 text-xs flex items-center gap-2 border-r border-white/5 transition-colors whitespace-nowrap
                                        ${activeFile === name ? 'bg-[#1e1e1e] text-white border-t-2 border-t-brand-primary' : 'text-gray-500 hover:text-gray-300'}
                                    `}
                                >
                                    <i className={`
                                        ${name.endsWith('html') ? 'fab fa-html5 text-orange-500' : ''}
                                        ${name.endsWith('css') ? 'fab fa-css3-alt text-blue-500' : ''}
                                        ${name.endsWith('js') ? 'fab fa-js text-yellow-500' : ''}
                                    `}></i>
                                    {name}
                                </button>
                            ))}
                        </div>

                        {/* Editor Area */}
                        <div className="flex-1 relative">
                            <Editor 
                                code={files[activeFile]} 
                                onChange={(val) => setFiles({ ...files, [activeFile]: val })}
                            />
                            <div className="absolute bottom-2 right-4 text-[10px] text-gray-500 bg-black/50 px-2 rounded">
                                UTF-8 • {files[activeFile].length} chars
                            </div>
                        </div>
                    </div>

                    {/* --- RIGHT: PREVIEW PANE --- */}
                    <div className="h-1/2 md:h-full md:w-[40%] flex flex-col bg-white">
                        <div className="h-8 bg-gray-100 border-b border-gray-300 flex items-center px-3 justify-between">
                            <span className="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                Live Server
                            </span>
                            <i className="fas fa-rotate text-gray-400 text-xs cursor-pointer hover:text-black"></i>
                        </div>
                        <iframe 
                            srcDoc={srcDoc}
                            title="preview"
                            sandbox="allow-scripts"
                            className="flex-1 w-full border-none bg-white"
                        />
                    </div>

                </div>
            );
        };

        /* PART 12 COMPLETE: CODE STUDIO READY */
        // ==================================================================================
        // 13. APP MODULE: SETTINGS (System Configuration)
        // ==================================================================================

        const SettingsApp = () => {
            const { state, dispatch } = useOS();
            const [tab, setTab] = React.useState('system');

            const renderContent = () => {
                switch(tab) {
                    case 'system': return (
                        <div className="space-y-6 animate-fadeIn">
                            <div className="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/5">
                                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-brand-primary to-sci-purple flex items-center justify-center text-xl font-bold text-white shadow-glow">
                                    SK
                                </div>
                                <div>
                                    <h2 className="text-lg font-bold">Shashank Kushwaha</h2>
                                    <p className="text-xs text-gray-400">Administrator • Local Account</p>
                                    <div className="mt-1 flex gap-2">
                                        <span className="px-2 py-0.5 bg-sci-green/20 text-sci-green text-[10px] rounded font-bold">ISC Student</span>
                                        <span className="px-2 py-0.5 bg-brand-primary/20 text-brand-primary text-[10px] rounded font-bold">Developer</span>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">OS Version</div>
                                    <div className="text-sm font-mono text-white">StudyGraphs v2.0</div>
                                </div>
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">Kernel</div>
                                    <div className="text-sm font-mono text-white">React-Fiber 18.2</div>
                                </div>
                                <div className="p-4 bg-white/5 rounded-lg border border-white/5 col-span-2">
                                    <div className="text-[10px] uppercase text-gray-500 font-bold mb-1">Storage Status</div>
                                    <div className="w-full h-2 bg-gray-700 rounded-full mt-2 overflow-hidden">
                                        <div className="h-full bg-brand-primary w-[35%]"></div>
                                    </div>
                                    <div className="flex justify-between mt-1 text-[10px] text-gray-400">
                                        <span>Used: 350 MB</span>
                                        <span>Total: 1 GB (Local)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );

                    case 'display': return (
                        <div className="space-y-6 animate-fadeIn">
                            <div>
                                <h3 className="text-sm font-bold mb-3">Appearance</h3>
                                <div className="flex gap-4">
                                    <div className="flex-1 aspect-video bg-sg-bg border-2 border-brand-primary rounded-lg flex items-center justify-center relative overflow-hidden cursor-pointer">
                                        <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 to-transparent"></div>
                                        <span className="relative z-10 text-xs font-bold">Dark Mode</span>
                                        <div className="absolute bottom-2 right-2 text-brand-primary"><i className="fas fa-check-circle"></i></div>
                                    </div>
                                    <div className="flex-1 aspect-video bg-gray-100 border-2 border-transparent rounded-lg flex items-center justify-center opacity-50 cursor-not-allowed grayscale">
                                        <span className="text-xs font-bold text-black">Light Mode</span>
                                        <div className="absolute top-2 right-2 text-[10px] bg-yellow-500 text-black px-1 rounded font-bold">SOON</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 className="text-sm font-bold mb-3">Interface</h3>
                                <label className="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors">
                                    <span className="text-sm">Show Grid Lines</span>
                                    <div className="w-10 h-5 bg-brand-primary rounded-full relative">
                                        <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    );

                    case 'about': return (
                        <div className="text-center pt-8 animate-fadeIn">
                            <i className="fas fa-atom text-4xl text-brand-primary mb-4 animate-spin-slow"></i>
                            <h1 className="text-2xl font-bold font-sans">StudyGraphs India</h1>
                            <p className="text-xs text-gray-400 mt-2 max-w-xs mx-auto">
                                An advanced educational operating system simulation designed to assist STEM students with visualization and calculation.
                            </p>
                            <div className="mt-8 pt-8 border-t border-white/10 text-[10px] text-gray-600">
                                © 2026 Shashank Kushwaha<br/>
                                Built with React, Three.js, Matter.js, Plotly
                            </div>
                        </div>
                    );
                }
            };

            const menu = [
                { id: 'system', l: 'System', i: 'fa-server' },
                { id: 'display', l: 'Display', i: 'fa-desktop' },
                { id: 'about', l: 'About', i: 'fa-info-circle' }
            ];

            return (
                <div className="flex h-full bg-sg-bg text-white font-sans overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-48 bg-sg-surface border-r border-sg-border p-2 flex flex-col gap-1">
                        {menu.map(m => (
                            <button
                                key={m.id}
                                onClick={() => setTab(m.id)}
                                className={`
                                    w-full text-left px-4 py-2 rounded-lg text-sm flex items-center gap-3 transition-colors
                                    ${tab === m.id ? 'bg-white/10 text-white font-bold' : 'text-gray-400 hover:bg-white/5'}
                                `}
                            >
                                <i className={`fas ${m.i} w-4 text-center`}></i>
                                {m.l}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        <div className="max-w-lg mx-auto">
                            <h1 className="text-2xl font-bold mb-6 capitalize">{tab} Settings</h1>
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };

        /* PART 13 COMPLETE: SETTINGS READY */
        // ==================================================================================
        // 14. BOOT LOADER & APP ROOT
        // ==================================================================================

        const BootScreen = ({ onComplete }) => {
            const [step, setStep] = React.useState(0);
            const [logs, setLogs] = React.useState([
                'StudyGraphs BIOS v2.0 (c) 2026',
                'Initializing Memory...... OK',
                'Checking CPU Cores....... 12 Active',
                'Loading Kernel Modules... OK',
            ]);

            React.useEffect(() => {
                // Sequence logic
                const t1 = setTimeout(() => setStep(1), 2000); // Show Logo
                const t2 = setTimeout(() => setStep(2), 3500); // Fade Out
                const t3 = setTimeout(onComplete, 4000);       // Finish

                return () => { clearTimeout(t1); clearTimeout(t2); clearTimeout(t3); };
            }, []);

            if (step === 2) return null; // Fading out

            return (
                <div className="fixed inset-0 z-[100000] bg-black text-white font-mono flex flex-col items-center justify-center p-8 transition-opacity duration-1000">
                    {step === 0 ? (
                        <div className="w-full max-w-md text-xs text-green-500 space-y-1">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                            <div className="animate-pulse">_</div>
                        </div>
                    ) : (
                        <div className="text-center animate-fadeIn">
                            <i className="fas fa-atom text-6xl text-brand-primary mb-6 animate-spin-slow"></i>
                            <h1 className="text-3xl font-bold font-sans tracking-tight">StudyGraphs India</h1>
                            <div className="mt-4 w-48 h-1 bg-gray-800 rounded-full overflow-hidden mx-auto">
                                <div className="h-full bg-white animate-[load_1s_ease-in-out_infinite]"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [booted, setBooted] = React.useState(false);

            if (!booted) return <BootScreen onComplete={() => setBooted(true)} />;

            return (
                <OSProvider>
                    <div className="relative w-full h-full text-white select-none">
                        <Desktop />
                        <Taskbar />
                        
                        {/* Render Active Windows */}
                        <WindowRenderer />
                    </div>
                </OSProvider>
            );
        };

        // Helper to separate context consumption from provider
        const WindowRenderer = () => {
            const { state, APP_REGISTRY } = useOS();
            
            return (
                <>
                    {state.windows.map(win => {
                        const AppConfig = APP_REGISTRY[win.id];
                        // Map App IDs to Components
                        let Component = null;
                        if (win.id === 'graph') Component = GraphApp;
                        if (win.id === 'solver') Component = SolverApp;
                        if (win.id === 'periodic') Component = PeriodicApp;
                        if (win.id === 'physics') Component = PhysicsApp;
                        if (win.id === 'formulas') Component = FormulaApp;
                        if (win.id === 'converter') Component = ConverterApp;
                        if (win.id === 'code') Component = CodeApp;
                        if (win.id === 'settings') Component = SettingsApp;

                        if (!Component) return null;

                        return (
                            <WindowFrame key={win.instanceId} windowData={win}>
                                <Component />
                            </WindowFrame>
                        );
                    })}
                </>
            );
        };

        // --- MOUNT TO DOM ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
